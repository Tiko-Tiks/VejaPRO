<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VejaPRO Admin Projects</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap");

      :root {
        --bg: #f4f1ec;
        --panel: #ffffff;
        --ink: #161616;
        --muted: #585858;
        --accent: #1e3a8a;
        --accent-dark: #162c6c;
        --border: #e1dcd6;
        --shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        --radius: 16px;
        --radius-sm: 10px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", sans-serif;
        color: var(--ink);
        background: radial-gradient(900px 500px at 10% 0%, #dfe7f3 0%, transparent 60%),
          radial-gradient(900px 500px at 90% -10%, #efe1d2 0%, transparent 60%),
          var(--bg);
      }

      header {
        max-width: 1200px;
        margin: 0 auto;
        padding: 28px 24px 16px;
      }

      h1 {
        margin: 0 0 6px;
        font-size: 28px;
      }

      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .nav {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .nav a {
        text-decoration: none;
        color: var(--ink);
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #fff;
      }

      .nav a.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto 40px;
        padding: 0 24px 40px;
      }

      .panel {
        background: var(--panel);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .section {
        padding: 20px;
        border-bottom: 1px solid var(--border);
      }

      .section:last-child {
        border-bottom: none;
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }

      input,
      select,
      button {
        font-family: "Space Grotesk", sans-serif;
      }

      input,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: #fff;
        font-size: 14px;
      }

      button {
        border: none;
        border-radius: var(--radius-sm);
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover {
        background: var(--accent-dark);
      }

      .btn-ghost {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--ink);
      }

      .token-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
      }

      .link-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .status-bar {
        padding: 12px 20px;
        font-size: 14px;
        color: var(--muted);
        border-top: 1px solid var(--border);
      }

      .error {
        color: #a91c1c;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #f0ede7;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      th,
      td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        vertical-align: top;
      }

      tbody tr:hover {
        background: #faf7f2;
      }

      .mono {
        font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal.open {
        display: flex;
      }

      .modal-content {
        background: #fff;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 520px;
        padding: 20px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 16px;
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }

      pre {
        background: #f8f6f1;
        padding: 12px;
        border-radius: var(--radius-sm);
        max-height: 320px;
        overflow: auto;
        font-size: 12px;
      }

      .inline-actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      @media (max-width: 900px) {
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }

        thead {
          display: none;
        }

        td {
          border: none;
          padding: 6px 14px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Projects</h1>
      <p class="subtitle">Admin dashboard (manual tools).</p>
      <nav class="nav">
        <a href="/admin">Overview</a>
        <a href="/admin/projects" class="active">Projects</a>
        <a href="/admin/calls">Calls</a>
        <a href="/admin/calendar">Calendar</a>
        <a href="/admin/audit">Audit</a>
        <a href="/admin/margins">Margins</a>
      </nav>
    </header>

    <div class="container">
      <div class="panel">
        <div class="section">
          <div class="token-row">
            <div>
              <label for="token">Bearer token</label>
              <input id="token" type="password" placeholder="Paste JWT token" />
            </div>
            <div class="actions">
              <button class="btn-ghost" id="generateToken">Generate token</button>
              <button class="btn-ghost" id="saveToken">Save token</button>
            </div>
          </div>
        </div>

        <div class="section">
          <form id="createForm" class="form-grid">
            <div>
              <label for="createName">Client name</label>
              <input id="createName" placeholder="Client name" required />
            </div>
            <div>
              <label for="createClientId">Client ID</label>
              <input id="createClientId" placeholder="client-123" required />
            </div>
            <div>
              <label for="createPhone">Phone (optional)</label>
              <input id="createPhone" placeholder="+370..." />
            </div>
            <div>
              <button class="btn-primary" type="submit">Create project</button>
            </div>
          </form>
          <div class="hint" id="createStatus"></div>
        </div>

        <div class="section">
          <div class="filters">
            <div>
              <label>Status</label>
              <select id="status">
                <option value="">Any</option>
                <option value="DRAFT">DRAFT</option>
                <option value="PAID">PAID</option>
                <option value="SCHEDULED">SCHEDULED</option>
                <option value="PENDING_EXPERT">PENDING_EXPERT</option>
                <option value="CERTIFIED">CERTIFIED</option>
                <option value="ACTIVE">ACTIVE</option>
              </select>
            </div>
            <div>
              <label>Contractor ID</label>
              <input id="assigned_contractor_id" placeholder="UUID" />
            </div>
            <div>
              <label>Expert ID</label>
              <input id="assigned_expert_id" placeholder="UUID" />
            </div>
            <div>
              <label>Limit</label>
              <select id="limit">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
              </select>
            </div>
            <div class="actions">
              <button class="btn-primary" id="apply">Apply</button>
              <button class="btn-ghost" id="clear">Clear</button>
            </div>
          </div>
        </div>

        <div class="status-bar" id="statusBar">Ready</div>

        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Scheduled</th>
                <th>Contractor</th>
                <th>Expert</th>
                <th>Created</th>
                <th>Updated</th>
                <th>Audit</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div class="pagination">
          <span id="count">0 items</span>
          <button class="btn-primary" id="loadMore">Load more</button>
        </div>
      </div>
    </div>

    <div class="modal" id="assignModal">
      <div class="modal-content">
        <div class="modal-header">
          <strong id="modalTitle">Assign</strong>
          <button class="btn-ghost" id="closeAssign">Close</button>
        </div>
        <div>
          <label for="assigneeInput">Assignee UUID</label>
          <input id="assigneeInput" placeholder="UUID" />
          <div class="hint">Only UUID input. Role validation is enforced server-side.</div>
          <label for="confirmCheck" style="margin-top: 12px;">Confirm</label>
          <div>
            <input type="checkbox" id="confirmCheck" />
            <span class="hint">I understand this updates the assignment.</span>
          </div>
          <div class="modal-actions">
            <button class="btn-ghost" id="cancelAssign">Cancel</button>
            <button class="btn-primary" id="confirmAssign">Confirm</button>
          </div>
          <div class="hint" id="assignStatus" style="margin-top: 8px;"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="detailModal">
      <div class="modal-content">
        <div class="modal-header">
          <strong>Project details</strong>
          <button class="btn-ghost" id="closeDetails">Close</button>
        </div>
        <pre id="detailJson">{}</pre>
      </div>
    </div>

    <div class="modal" id="clientTokenModal">
      <div class="modal-content">
        <div class="modal-header">
          <strong>Client token</strong>
          <button class="btn-ghost" id="closeClientToken">Close</button>
        </div>
        <div>
          <label for="clientTokenValue">Token</label>
          <input id="clientTokenValue" readonly />
          <div class="hint" id="clientTokenMeta"></div>
          <div class="modal-actions">
            <button class="btn-ghost" id="copyClientToken">Copy token</button>
            <button class="btn-ghost" id="copyClientLink">Copy portal link</button>
          </div>
          <div class="hint">Portal link includes the token (share carefully).</div>
          <div style="margin-top: 8px;">
            <a id="clientPortalLink" href="#" target="_blank" rel="noreferrer">Open client portal</a>
          </div>
          <div class="hint" id="clientTokenStatus" style="margin-top: 8px;"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="transitionModal">
      <div class="modal-content">
        <div class="modal-header">
          <strong>Transition status</strong>
          <button class="btn-ghost" id="closeTransition">Close</button>
        </div>
        <div>
          <label for="transitionStatus">New status</label>
          <select id="transitionStatus">
            <option value="DRAFT">DRAFT</option>
            <option value="PAID">PAID</option>
            <option value="SCHEDULED">SCHEDULED</option>
            <option value="PENDING_EXPERT">PENDING_EXPERT</option>
            <option value="CERTIFIED">CERTIFIED</option>
            <option value="ACTIVE">ACTIVE</option>
          </select>
          <div class="hint">Some transitions require prerequisites (payment, evidence).</div>
          <div class="modal-actions">
            <button class="btn-ghost" id="cancelTransition">Cancel</button>
            <button class="btn-primary" id="confirmTransition">Apply</button>
          </div>
          <div class="hint" id="transitionStatusMsg" style="margin-top: 8px;"></div>
        </div>
      </div>
    </div>

    <div class="modal" id="paymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <strong>Payment link</strong>
          <button class="btn-ghost" id="closePayment">Close</button>
        </div>
        <div>
          <div class="form-grid">
            <div>
              <label for="paymentType">Payment type</label>
              <select id="paymentType">
                <option value="DEPOSIT">DEPOSIT</option>
                <option value="FINAL">FINAL</option>
              </select>
            </div>
            <div>
              <label for="paymentCurrency">Currency</label>
              <input id="paymentCurrency" value="EUR" />
            </div>
          </div>
          <div class="form-grid" style="margin-top: 10px;">
            <div>
              <label for="paymentAmount">Amount</label>
              <input id="paymentAmount" type="number" min="0" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <label for="paymentDescription">Description (optional)</label>
              <input id="paymentDescription" placeholder="VejaPRO payment" />
            </div>
          </div>
          <label for="paymentSuccessUrl" style="margin-top: 12px;">Success URL (optional)</label>
          <input id="paymentSuccessUrl" placeholder="https://..." />
          <label for="paymentCancelUrl" style="margin-top: 12px;">Cancel URL (optional)</label>
          <input id="paymentCancelUrl" placeholder="https://..." />
          <div class="modal-actions">
            <button class="btn-ghost" id="cancelPayment">Cancel</button>
            <button class="btn-primary" id="createPaymentLink">Create link</button>
          </div>
          <label for="paymentLinkValue">Payment URL</label>
          <div class="link-row">
            <input id="paymentLinkValue" readonly />
            <button class="btn-ghost" id="copyPaymentLink">Copy</button>
          </div>
          <div style="margin-top: 8px;">
            <a id="openPaymentLink" href="#" target="_blank" rel="noreferrer">Open payment link</a>
          </div>
          <div class="hint" id="paymentStatus" style="margin-top: 8px;"></div>
        </div>
      </div>
    </div>

    <script>
      const rowsEl = document.getElementById("rows");
      const statusBar = document.getElementById("statusBar");
      const countEl = document.getElementById("count");
      const loadMoreBtn = document.getElementById("loadMore");
      const tokenInput = document.getElementById("token");
      const createForm = document.getElementById("createForm");
      const createStatus = document.getElementById("createStatus");
      const assignModal = document.getElementById("assignModal");
      const assignStatus = document.getElementById("assignStatus");
      const modalTitle = document.getElementById("modalTitle");
      const assigneeInput = document.getElementById("assigneeInput");
      const confirmCheck = document.getElementById("confirmCheck");
      const detailModal = document.getElementById("detailModal");
      const detailJson = document.getElementById("detailJson");
      const clientTokenModal = document.getElementById("clientTokenModal");
      const clientTokenValue = document.getElementById("clientTokenValue");
      const clientTokenMeta = document.getElementById("clientTokenMeta");
      const clientPortalLink = document.getElementById("clientPortalLink");
      const clientTokenStatus = document.getElementById("clientTokenStatus");
      const transitionModal = document.getElementById("transitionModal");
      const transitionStatusSelect = document.getElementById("transitionStatus");
      const transitionStatusMsg = document.getElementById("transitionStatusMsg");
      const paymentModal = document.getElementById("paymentModal");
      const paymentTypeSelect = document.getElementById("paymentType");
      const paymentAmountInput = document.getElementById("paymentAmount");
      const paymentCurrencyInput = document.getElementById("paymentCurrency");
      const paymentDescriptionInput = document.getElementById("paymentDescription");
      const paymentSuccessUrlInput = document.getElementById("paymentSuccessUrl");
      const paymentCancelUrlInput = document.getElementById("paymentCancelUrl");
      const paymentLinkValue = document.getElementById("paymentLinkValue");
      const paymentStatus = document.getElementById("paymentStatus");
      const openPaymentLink = document.getElementById("openPaymentLink");

      const STORAGE_KEY = "vejapro_admin_token";

      let nextCursor = null;
      let items = [];
      let itemIds = new Set();
      let activeProjectId = null;
      let activeAssignType = null;
      let paymentDefaults = { deposit: null, final: null };
      let paymentAmountTouched = false;

      const normalizeToken = (value) => {
        if (!value) return "";
        return value.replace(/^Bearer\\s+/i, "").replace(/\\s+/g, "").trim();
      };

      const setStatus = (message, isError = false) => {
        statusBar.textContent = message;
        statusBar.className = isError ? "status-bar error" : "status-bar";
      };

      const setClientTokenStatus = (message, isError = false) => {
        clientTokenStatus.textContent = message;
        clientTokenStatus.style.color = isError ? "#a91c1c" : "var(--muted)";
      };

      const setPaymentStatus = (message, isError = false) => {
        paymentStatus.textContent = message || "";
        paymentStatus.className = isError ? "hint error" : "hint";
      };

      const loadToken = () => {
        const stored = localStorage.getItem(STORAGE_KEY) || "";
        if (!tokenInput.value && stored) {
          tokenInput.value = normalizeToken(stored);
        }
      };

      const getToken = () =>
        normalizeToken(tokenInput.value) || normalizeToken(localStorage.getItem(STORAGE_KEY) || "");

      const parseErrorDetail = async (resp) => {
        try {
          const data = await resp.json();
          if (data && typeof data.detail === "string") {
            return data.detail;
          }
          return JSON.stringify(data);
        } catch (err) {
          try {
            return await resp.text();
          } catch (innerErr) {
            return "";
          }
        }
      };

      const refreshToken = async () => {
        try {
          const resp = await fetch("/api/v1/admin/token");
          if (!resp.ok) {
            return null;
          }
          const data = await resp.json();
          const token = normalizeToken(data.token || "");
          if (!token) {
            return null;
          }
          localStorage.setItem(STORAGE_KEY, token);
          tokenInput.value = token;
          setStatus("Token refreshed.");
          return token;
        } catch (err) {
          return null;
        }
      };

      const fetchWithAuth = async (url, options = {}, retryOn401 = true) => {
        const token = getToken();
        const headers = {
          ...(options.headers || {}),
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };
        let resp = await fetch(url, { ...options, headers });
        if (resp.status === 401 && retryOn401) {
          const newToken = await refreshToken();
          if (newToken) {
            const retryHeaders = {
              ...(options.headers || {}),
              Authorization: `Bearer ${newToken}`,
            };
            resp = await fetch(url, { ...options, headers: retryHeaders });
          }
        }
        return resp;
      };

      const shortenId = (value) => {
        if (!value) return "-";
        return `${value.slice(0, 8)}...`;
      };

      const formatDate = (value) => {
        if (!value) return "-";
        try {
          return new Date(value).toLocaleString();
        } catch (err) {
          return value;
        }
      };

      const formatUnix = (value) => {
        if (!value) return "-";
        try {
          return new Date(value * 1000).toLocaleString();
        } catch (err) {
          return "-";
        }
      };

      const copyText = async (value) => {
        if (!value) return false;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(value);
            return true;
          } catch (err) {
            // fallback below
          }
        }
        try {
          const temp = document.createElement("textarea");
          temp.value = value;
          temp.style.position = "fixed";
          temp.style.opacity = "0";
          document.body.appendChild(temp);
          temp.focus();
          temp.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(temp);
          return ok;
        } catch (err) {
          return false;
        }
      };

      const getFilters = () => {
        return {
          status: document.getElementById("status").value || null,
          assigned_contractor_id: document.getElementById("assigned_contractor_id").value || null,
          assigned_expert_id: document.getElementById("assigned_expert_id").value || null,
          limit: document.getElementById("limit").value || "50",
        };
      };

      const buildQuery = (filters, cursor) => {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
          if (value) params.append(key, value);
        });
        if (cursor) params.append("cursor", cursor);
        return params.toString();
      };

      const renderRows = () => {
        rowsEl.innerHTML = "";
        items.forEach((item) => {
          const tr = document.createElement("tr");
          const auditUrl = `/admin/audit?entity_type=project&entity_id=${encodeURIComponent(item.id)}`;
          tr.innerHTML = `
            <td class="mono" title="${item.id}">${shortenId(item.id)}</td>
            <td>${item.status}</td>
            <td>${formatDate(item.scheduled_for)}</td>
            <td class="mono">${item.assigned_contractor_id || "-"}</td>
            <td class="mono">${item.assigned_expert_id || "-"}</td>
            <td>${formatDate(item.created_at)}</td>
            <td>${formatDate(item.updated_at)}</td>
            <td><a href="${auditUrl}">Audit</a></td>
            <td>
              <div class="inline-actions">
                <button class="btn-ghost" data-action="details" data-id="${item.id}">Details</button>
                <button class="btn-ghost" data-action="client-token" data-id="${item.id}">Client token</button>
                <button class="btn-ghost" data-action="payment-link" data-id="${item.id}">Payment link</button>
                <button class="btn-ghost" data-action="transition" data-id="${item.id}">Transition</button>
                <button class="btn-ghost" data-action="seed-evidence" data-id="${item.id}">Seed cert photos</button>
                <button class="btn-ghost" data-action="certify" data-id="${item.id}">Certify</button>
                <button class="btn-ghost" data-action="assign-contractor" data-id="${item.id}">Assign contractor</button>
                <button class="btn-ghost" data-action="assign-expert" data-id="${item.id}">Assign expert</button>
              </div>
            </td>
          `;
          rowsEl.appendChild(tr);
        });
        countEl.textContent = `${items.length} items`;
        loadMoreBtn.disabled = !nextCursor;
        wireRowActions();
      };

      const wireRowActions = () => {
        rowsEl.querySelectorAll("button[data-action]").forEach((btn) => {
          btn.addEventListener("click", (event) => {
            const action = event.currentTarget.getAttribute("data-action");
            const id = event.currentTarget.getAttribute("data-id");
            if (action === "details") {
              openDetailModal(id);
              return;
            }
            if (action === "client-token") {
              openClientTokenModal(id);
              return;
            }
            if (action === "payment-link") {
              openPaymentModal(id);
              return;
            }
            if (action === "transition") {
              openTransitionModal(id);
              return;
            }
            if (action === "seed-evidence") {
              seedCertPhotos(id);
              return;
            }
            if (action === "certify") {
              certifyProject(id);
              return;
            }
            openAssignModal(id, action);
          });
        });
      };

      const openAssignModal = (projectId, action) => {
        activeProjectId = projectId;
        activeAssignType = action;
        modalTitle.textContent = action === "assign-contractor" ? "Assign contractor" : "Assign expert";
        assigneeInput.value = "";
        confirmCheck.checked = false;
        assignStatus.textContent = "";
        assignModal.classList.add("open");
      };

      const closeAssignModal = () => {
        assignModal.classList.remove("open");
        activeProjectId = null;
        activeAssignType = null;
      };

      const openDetailModal = async (projectId) => {
        detailJson.textContent = "Loading...";
        detailModal.classList.add("open");
        try {
          const resp = await fetchWithAuth(`/api/v1/projects/${encodeURIComponent(projectId)}`, {});
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            detailJson.textContent = `Failed to load (${resp.status}). ${detail}`;
            return;
          }
          const data = await resp.json();
          detailJson.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          detailJson.textContent = "Network error.";
        }
      };

      const closeDetailModal = () => {
        detailModal.classList.remove("open");
      };

      const openClientTokenModal = async (projectId) => {
        clientTokenModal.classList.add("open");
        clientTokenValue.value = "";
        clientTokenMeta.textContent = "";
        clientPortalLink.href = "#";
        clientPortalLink.textContent = "Open client portal";
        setClientTokenStatus("Generating token...");
        clientTokenModal.dataset.token = "";
        clientTokenModal.dataset.link = "";

        try {
          const resp = await fetchWithAuth(
            `/api/v1/admin/projects/${encodeURIComponent(projectId)}/client-token`,
            {}
          );
          if (resp.status === 403) {
            setClientTokenStatus("Access denied.", true);
            return;
          }
          if (resp.status === 404) {
            setClientTokenStatus("Project not found.", true);
            return;
          }
          if (resp.status === 400) {
            const detail = await parseErrorDetail(resp);
            setClientTokenStatus(detail || "Client ID missing.", true);
            return;
          }
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            setClientTokenStatus(`Failed (${resp.status}). ${detail}`, true);
            return;
          }

          const data = await resp.json();
          const token = normalizeToken(data.token || "");
          if (!token) {
            setClientTokenStatus("Token missing.", true);
            return;
          }
          clientTokenValue.value = token;
          clientTokenModal.dataset.token = token;
          const portalUrl = `/client?project=${encodeURIComponent(projectId)}&token=${encodeURIComponent(token)}`;
          clientPortalLink.href = portalUrl;
          clientPortalLink.textContent = portalUrl;
          clientTokenModal.dataset.link = portalUrl;
          clientTokenMeta.textContent = `Client ID: ${data.client_id || "-"} â€¢ Expires: ${formatUnix(data.expires_at)}`;
          setClientTokenStatus("Token ready.");
        } catch (err) {
          setClientTokenStatus("Network error.", true);
        }
      };

      const closeClientTokenModal = () => {
        clientTokenModal.classList.remove("open");
        setClientTokenStatus("");
      };

      const openTransitionModal = (projectId) => {
        activeProjectId = projectId;
        transitionStatusMsg.textContent = "";
        transitionModal.classList.add("open");
      };

      const closeTransitionModal = () => {
        transitionModal.classList.remove("open");
        transitionStatusMsg.textContent = "";
        activeProjectId = null;
      };

      const openPaymentModal = async (projectId) => {
        paymentModal.classList.add("open");
        paymentModal.dataset.projectId = projectId;
        paymentTypeSelect.value = "DEPOSIT";
        paymentCurrencyInput.value = "EUR";
        paymentAmountInput.value = "";
        paymentDescriptionInput.value = "";
        paymentSuccessUrlInput.value = "";
        paymentCancelUrlInput.value = "";
        paymentLinkValue.value = "";
        openPaymentLink.href = "#";
        paymentDefaults = { deposit: null, final: null };
        paymentAmountTouched = false;
        setPaymentStatus("Loading project...");

        try {
          const resp = await fetchWithAuth(`/api/v1/projects/${encodeURIComponent(projectId)}`, {});
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            setPaymentStatus(`Failed to load project. ${detail}`, true);
            return;
          }
          const data = await resp.json();
          const project = data.project || {};
          const total = Number(project.total_price_client || 0);
          if (Number.isFinite(total) && total > 0) {
            const deposit = Math.round(total * 0.3 * 100) / 100;
            paymentDefaults = { deposit, final: total };
            if (project.status === "CERTIFIED" || project.status === "ACTIVE") {
              paymentTypeSelect.value = "FINAL";
              paymentAmountInput.value = total.toFixed(2);
            } else {
              paymentTypeSelect.value = "DEPOSIT";
              paymentAmountInput.value = deposit.toFixed(2);
            }
            setPaymentStatus("Ready. Adjust amount if needed.");
          } else {
            setPaymentStatus("Total price missing. Enter amount manually.");
          }
        } catch (err) {
          setPaymentStatus("Network error.", true);
        }
      };

      const closePaymentModal = () => {
        paymentModal.classList.remove("open");
        paymentModal.dataset.projectId = "";
        setPaymentStatus("");
      };

      const createPaymentLink = async () => {
        const projectId = paymentModal.dataset.projectId;
        const paymentType = paymentTypeSelect.value;
        const amount = Number(paymentAmountInput.value);
        const currency = (paymentCurrencyInput.value || "EUR").trim().toUpperCase();
        const description = paymentDescriptionInput.value.trim();
        const successUrl = paymentSuccessUrlInput.value.trim();
        const cancelUrl = paymentCancelUrlInput.value.trim();

        if (!projectId) {
          setPaymentStatus("Project ID missing.", true);
          return;
        }
        if (!amount || Number.isNaN(amount) || amount <= 0) {
          setPaymentStatus("Amount must be greater than 0.", true);
          return;
        }
        if (!currency || currency.length < 3) {
          setPaymentStatus("Currency must be provided.", true);
          return;
        }

        const payload = {
          payment_type: paymentType,
          amount,
          currency,
        };
        if (description) payload.description = description;
        if (successUrl) payload.success_url = successUrl;
        if (cancelUrl) payload.cancel_url = cancelUrl;

        setPaymentStatus("Creating payment link...");
        paymentLinkValue.value = "";
        openPaymentLink.href = "#";

        try {
          const resp = await fetchWithAuth(
            `/api/v1/admin/projects/${encodeURIComponent(projectId)}/payment-link`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            }
          );
          if (resp.status === 403) {
            setPaymentStatus("Access denied.", true);
            return;
          }
          if (resp.status === 404) {
            setPaymentStatus("Project not found.", true);
            return;
          }
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            setPaymentStatus(`Failed (${resp.status}). ${detail}`, true);
            return;
          }
          const data = await resp.json();
          if (!data.url) {
            setPaymentStatus("Stripe returned no URL.", true);
            return;
          }
          paymentLinkValue.value = data.url;
          openPaymentLink.href = data.url;
          setPaymentStatus("Payment link ready.");
        } catch (err) {
          setPaymentStatus("Network error.", true);
        }
      };

      const seedCertPhotos = async (projectId) => {
        setStatus("Seeding certification photos...");
        try {
          const resp = await fetchWithAuth(
            `/api/v1/admin/projects/${encodeURIComponent(projectId)}/seed-cert-photos`,
            {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ count: 3 }),
          }
          );
          if (resp.status === 403) {
            setStatus("Access denied.", true);
            return;
          }
          if (resp.status === 404) {
            setStatus("Project not found.", true);
            return;
          }
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            setStatus(`Seed failed (${resp.status}). ${detail}`, true);
            return;
          }
          const data = await resp.json();
          setStatus(`Seeded ${data.created || 0} photos.`);
        } catch (err) {
          setStatus("Network error.", true);
        }
      };

      const certifyProject = async (projectId) => {
        setStatus("Certifying project...");
        try {
          const resp = await fetchWithAuth("/api/v1/certify-project", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              project_id: projectId,
              checklist: { photos: true, notes: true },
              notes: "Certified via admin UI",
            }),
          });
          if (resp.status === 403) {
            setStatus("Access denied.", true);
            return;
          }
          if (resp.status === 404) {
            setStatus("Project not found.", true);
            return;
          }
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            setStatus(`Certify failed (${resp.status}). ${detail}`, true);
            return;
          }
          await fetchProjects({ reset: true });
          setStatus("Certified.");
        } catch (err) {
          setStatus("Network error.", true);
        }
      };

      const isUuid = (value) => {
        return /^[0-9a-fA-F-]{36}$/.test(value);
      };

      const updateItemAssignment = (projectId, field, value) => {
        items = items.map((item) => {
          if (item.id !== projectId) return item;
          return { ...item, [field]: value };
        });
      };

      const fetchProjects = async ({ reset } = { reset: false }) => {
        if (reset) {
          items = [];
          nextCursor = null;
          itemIds = new Set();
          renderRows();
        }

        const filters = getFilters();
        const query = buildQuery(filters, nextCursor);

        setStatus("Loading...");
        try {
          const resp = await fetchWithAuth(`/api/v1/admin/projects?${query}`, {});

          if (resp.status === 403) {
            setStatus("Access denied.", true);
            return;
          }
          if (resp.status === 400) {
            setStatus("Invalid filters or cursor.", true);
            return;
          }
          if (resp.status === 401) {
            const detail = await parseErrorDetail(resp);
            setStatus(`Token invalid or expired. ${detail || ""}`.trim(), true);
            return;
          }
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            setStatus(`Unexpected error. ${detail}`, true);
            return;
          }

          const data = await resp.json();
          const newItems = (data.items || []).filter((item) => {
            if (itemIds.has(item.id)) return false;
            itemIds.add(item.id);
            return true;
          });
          items = items.concat(newItems);
          nextCursor = data.next_cursor;
          renderRows();
          setStatus(data.has_more ? "Loaded. More available." : "Loaded.");
        } catch (err) {
          setStatus("Network error.", true);
        }
      };

      createForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        createStatus.textContent = "";
        const name = document.getElementById("createName").value.trim();
        const clientId = document.getElementById("createClientId").value.trim();
        const phone = document.getElementById("createPhone").value.trim();
        if (!name || !clientId) {
          createStatus.textContent = "Client name and ID are required.";
          return;
        }

        createStatus.textContent = "Creating...";
        try {
          const resp = await fetchWithAuth("/api/v1/projects", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              client_info: {
                name,
                client_id: clientId,
                ...(phone ? { phone } : {}),
              },
            }),
          });

          if (resp.status === 403) {
            createStatus.textContent = "Access denied.";
            return;
          }
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            createStatus.textContent = `Create failed (${resp.status}). ${detail}`;
            return;
          }

          createStatus.textContent = "Project created.";
          document.getElementById("createPhone").value = "";
          await fetchProjects({ reset: true });
        } catch (err) {
          createStatus.textContent = "Network error.";
        }
      });

      document.getElementById("apply").addEventListener("click", () => fetchProjects({ reset: true }));
      document.getElementById("clear").addEventListener("click", () => {
        ["status", "assigned_contractor_id", "assigned_expert_id"].forEach((id) => {
          document.getElementById(id).value = "";
        });
        document.getElementById("limit").value = "50";
        fetchProjects({ reset: true });
      });

      loadMoreBtn.addEventListener("click", () => {
        if (!nextCursor) {
          setStatus("No more results.");
          return;
        }
        fetchProjects({ reset: false });
      });

      document.getElementById("saveToken").addEventListener("click", () => {
        const token = normalizeToken(tokenInput.value);
        if (token) {
          localStorage.setItem(STORAGE_KEY, token);
          tokenInput.value = token;
          setStatus("Token saved.");
        } else {
          localStorage.removeItem(STORAGE_KEY);
          setStatus("Token cleared.");
        }
      });

      document.getElementById("generateToken").addEventListener("click", async () => {
        setStatus("Generating token...");
        const token = await refreshToken();
        if (!token) {
          setStatus("Token generation failed.", true);
        }
      });

      document.getElementById("closeAssign").addEventListener("click", closeAssignModal);
      document.getElementById("cancelAssign").addEventListener("click", closeAssignModal);
      assignModal.addEventListener("click", (event) => {
        if (event.target === assignModal) closeAssignModal();
      });

      document.getElementById("closeDetails").addEventListener("click", closeDetailModal);
      detailModal.addEventListener("click", (event) => {
        if (event.target === detailModal) closeDetailModal();
      });

      document.getElementById("closeClientToken").addEventListener("click", closeClientTokenModal);
      clientTokenModal.addEventListener("click", (event) => {
        if (event.target === clientTokenModal) closeClientTokenModal();
      });
      document.getElementById("copyClientToken").addEventListener("click", async () => {
        const value = clientTokenModal.dataset.token || "";
        const ok = await copyText(value);
        setClientTokenStatus(ok ? "Token copied." : "Copy failed.", !ok);
      });
      document.getElementById("copyClientLink").addEventListener("click", async () => {
        const value = clientTokenModal.dataset.link || "";
        const ok = await copyText(value);
        setClientTokenStatus(ok ? "Link copied." : "Copy failed.", !ok);
      });

      document.getElementById("closeTransition").addEventListener("click", closeTransitionModal);
      document.getElementById("cancelTransition").addEventListener("click", closeTransitionModal);
      transitionModal.addEventListener("click", (event) => {
        if (event.target === transitionModal) closeTransitionModal();
      });

      document.getElementById("closePayment").addEventListener("click", closePaymentModal);
      document.getElementById("cancelPayment").addEventListener("click", closePaymentModal);
      paymentModal.addEventListener("click", (event) => {
        if (event.target === paymentModal) closePaymentModal();
      });
      document.getElementById("createPaymentLink").addEventListener("click", createPaymentLink);
      document.getElementById("copyPaymentLink").addEventListener("click", async () => {
        const value = paymentLinkValue.value || "";
        const ok = await copyText(value);
        setPaymentStatus(ok ? "Link copied." : "Copy failed.", !ok);
      });
      paymentTypeSelect.addEventListener("change", () => {
        if (paymentAmountTouched) return;
        const isFinal = paymentTypeSelect.value === "FINAL";
        const amount = isFinal ? paymentDefaults.final : paymentDefaults.deposit;
        if (amount) {
          paymentAmountInput.value = Number(amount).toFixed(2);
        }
      });
      paymentAmountInput.addEventListener("input", () => {
        paymentAmountTouched = true;
      });

      document.getElementById("confirmAssign").addEventListener("click", async () => {
        if (!activeProjectId || !activeAssignType) return;
        const assignee = assigneeInput.value.trim();
        if (!assignee || !isUuid(assignee)) {
          assignStatus.textContent = "Enter a valid UUID.";
          return;
        }
        if (!confirmCheck.checked) {
          assignStatus.textContent = "Please confirm before assigning.";
          return;
        }

        const token = getToken();
        const endpoint =
          activeAssignType === "assign-contractor"
            ? `/api/v1/admin/projects/${encodeURIComponent(activeProjectId)}/assign-contractor`
            : `/api/v1/admin/projects/${encodeURIComponent(activeProjectId)}/assign-expert`;

        assignStatus.textContent = "Assigning...";
        try {
          const resp = await fetchWithAuth(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ user_id: assignee }),
          });

          if (resp.status === 403) {
            assignStatus.textContent = "Access denied.";
            return;
          }
          if (resp.status === 404) {
            assignStatus.textContent = "Not found.";
            return;
          }
          if (resp.status === 400) {
            assignStatus.textContent = "Invalid user or role.";
            return;
          }
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            assignStatus.textContent = `Unexpected error. ${detail}`;
            return;
          }

          const data = await resp.json();
          if (data.no_change) {
            assignStatus.textContent = "No change.";
            return;
          }

          if (activeAssignType === "assign-contractor") {
            updateItemAssignment(activeProjectId, "assigned_contractor_id", assignee);
          } else {
            updateItemAssignment(activeProjectId, "assigned_expert_id", assignee);
          }
          renderRows();
          assignStatus.textContent = "Assigned. View audit.";
        } catch (err) {
          assignStatus.textContent = "Unexpected error.";
        }
      });

      document.getElementById("confirmTransition").addEventListener("click", async () => {
        if (!activeProjectId) return;
        const newStatus = transitionStatusSelect.value;
        transitionStatusMsg.textContent = "Updating...";
        try {
          const resp = await fetchWithAuth("/api/v1/transition-status", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              project_id: activeProjectId,
              new_status: newStatus,
              actor: "ADMIN",
            }),
          });

          if (resp.status === 403) {
            transitionStatusMsg.textContent = "Access denied.";
            return;
          }
          if (resp.status === 404) {
            transitionStatusMsg.textContent = "Project not found.";
            return;
          }
          if (!resp.ok) {
            const detail = await parseErrorDetail(resp);
            transitionStatusMsg.textContent = `Transition failed (${resp.status}). ${detail}`;
            return;
          }

          transitionStatusMsg.textContent = "Status updated.";
          await fetchProjects({ reset: true });
        } catch (err) {
          transitionStatusMsg.textContent = "Unexpected error.";
        }
      });

      loadToken();
    </script>
  </body>
</html>
