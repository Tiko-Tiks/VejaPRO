<!DOCTYPE html>
<html lang="lt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VejaPRO – Maržos</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" />
    <link rel="stylesheet" href="/static/admin-shared.css?v=3.1" />
    <style>
      .section { padding: 20px; border-bottom: 1px solid var(--border); }
      .section:last-child { border-bottom: none; }
    </style>
  </head>
  <body>
    <button class="hamburger" aria-label="Meniu">&#9776;</button>
    <div class="sidebar-overlay"></div>
    <div class="admin-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/"><img src="/static/logo.png" alt="VejaPRO" class="logo" /></a>
          <span class="brand">VejaPRO</span>
        </div>
        <nav class="sidebar-nav" id="sidebarNav"></nav>
        <div class="sidebar-footer">V3.1 Admin - Modern Design</div>
      </aside>
      <main class="main-content">
        <div class="page-header">
          <h1>Maržų taisyklės</h1>
        </div>
        <div class="content-area">
          <div class="token-card">
            <div class="token-card-header">
              <span>&#128274; Bearer žetonas</span>
              <span id="tokenBadge" class="pill pill-gray">Nenustatytas</span>
            </div>
            <div class="token-card-body">
              <div class="form-grid" style="grid-template-columns: 1fr auto auto;">
                <div class="form-group">
                  <label for="token">Prieigos žetonas</label>
                  <input id="token" type="password" class="form-input" placeholder="Įklijuokite JWT žetoną" />
                </div>
                <button class="btn" id="generateToken" type="button">Generuoti</button>
                <button class="btn btn-secondary" id="saveToken" type="button">Išsaugoti</button>
              </div>
              <div class="hint" id="tokenStatus" style="margin-top:6px;color:var(--ink-muted);">Žetonas nenustatytas.</div>
            </div>
          </div>

          <div class="card">
            <div class="section">
              <form id="marginForm" class="form-grid">
                <div>
                  <label for="serviceType">Paslaugos tipas</label>
                  <input id="serviceType" class="form-input" type="text" placeholder="pvz., LAWN_INSTALL" required />
                </div>
                <div>
                  <label for="marginPercent">Maržos %</label>
                  <input id="marginPercent" class="form-input" type="number" step="0.01" min="0" required />
                </div>
                <div>
                  <button class="btn btn-primary" type="submit">Sukurti taisyklę</button>
                </div>
              </form>
              <div class="hint" id="formStatus" style="margin-top:8px;"></div>
            </div>

            <div class="section">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Paslauga</th>
                    <th>Maržos %</th>
                    <th>Galioja nuo</th>
                    <th>Galioja iki</th>
                    <th>Sukūrė</th>
                    <th>Sukurta</th>
                    <th>Būsena</th>
                  </tr>
                </thead>
                <tbody id="marginRows"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="/static/admin-shared.js?v=3.1"></script>
    <script>
      document.getElementById("sidebarNav").innerHTML = sidebarHTML("/admin/margins");

      const tokenInput = document.getElementById("token");
      const tokenStatus = document.getElementById("tokenStatus");
      const tokenBadge = document.getElementById("tokenBadge");
      const formStatus = document.getElementById("formStatus");
      const rows = document.getElementById("marginRows");
      const saveToken = document.getElementById("saveToken");
      const generateToken = document.getElementById("generateToken");
      const marginForm = document.getElementById("marginForm");

      const updateTokenBadge = () => {
        if (!tokenBadge) return;
        if (Auth.isSet()) {
          tokenBadge.textContent = "Aktyvus";
          tokenBadge.className = "pill pill-success";
        } else {
          tokenBadge.textContent = "Nenustatytas";
          tokenBadge.className = "pill pill-gray";
        }
      };

      const loadToken = () => {
        const stored = Auth.get();
        tokenInput.value = stored;
        tokenStatus.textContent = stored ? "Žetonas įkeltas iš saugyklos." : "Žetonas nenustatytas.";
        updateTokenBadge();
      };

      const formatDate = (value) => {
        if (!value) return "-";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toISOString();
      };

      const renderRows = (items) => {
        rows.innerHTML = "";
        if (!items.length) {
          rows.innerHTML = '<tr><td colspan="7" style="color:var(--ink-muted);">Maržų taisyklių dar nėra.</td></tr>';
          return;
        }
        for (const item of items) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td data-label="Paslauga">${escapeHtml(item.service_type)}</td>
            <td data-label="Maržos %">${escapeHtml(String(item.margin_percent))}</td>
            <td data-label="Galioja nuo">${escapeHtml(formatDate(item.valid_from))}</td>
            <td data-label="Galioja iki">${escapeHtml(formatDate(item.valid_until))}</td>
            <td data-label="Sukūrė" style="color:var(--ink-muted);">${escapeHtml(item.created_by || "-")}</td>
            <td data-label="Sukurta" style="color:var(--ink-muted);">${escapeHtml(formatDate(item.created_at))}</td>
            <td data-label="Būsena">${item.is_active ? '<span class="pill pill-success">Aktyvi</span>' : "Istorinė"}</td>
          `;
          rows.appendChild(tr);
        }
      };

      const fetchMargins = async () => {
        formStatus.textContent = "";
        try {
          const resp = await authFetch("/api/v1/admin/margins");
          const body = await resp.json();
          renderRows(body.items || []);
        } catch (err) {
          formStatus.textContent = err.message || "Įkėlimas nepavyko.";
          formStatus.style.color = "var(--error)";
        }
      };

      saveToken.addEventListener("click", () => {
        const token = Auth.normalize(tokenInput.value);
        if (token) {
          Auth.set(token);
          tokenInput.value = token;
          tokenStatus.textContent = "Žetonas išsaugotas.";
          showToast("Žetonas išsaugotas", "success");
        } else {
          Auth.remove();
          tokenStatus.textContent = "Žetonas ištrintas.";
        }
        updateTokenBadge();
      });

      generateToken.addEventListener("click", async () => {
        tokenStatus.textContent = "Generuojamas žetonas...";
        try {
          const token = await Auth.generate();
          if (token) {
            tokenInput.value = token;
            tokenStatus.textContent = "Žetonas sugeneruotas.";
            showToast("Žetonas sugeneruotas", "success");
          } else {
            tokenStatus.textContent = "Žetono generavimas nepavyko.";
          }
        } catch (err) {
          tokenStatus.textContent = err.message || "Žetono generavimas nepavyko.";
        }
        updateTokenBadge();
      });

      marginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        formStatus.textContent = "";
        const serviceType = document.getElementById("serviceType").value.trim();
        const marginPercent = Number(document.getElementById("marginPercent").value);
        try {
          await authFetch("/api/v1/admin/margins", {
            method: "POST",
            body: JSON.stringify({
              service_type: serviceType,
              margin_percent: marginPercent,
            }),
          });
          formStatus.textContent = "Nauja maržos taisyklė sukurta.";
          formStatus.style.color = "var(--ink-muted)";
          document.getElementById("marginPercent").value = "";
          await fetchMargins();
        } catch (err) {
          formStatus.textContent = err.message || "Sukūrimas nepavyko.";
          formStatus.style.color = "var(--error)";
        }
      });

      loadToken();
      fetchMargins();
    </script>
  </body>
</html>
