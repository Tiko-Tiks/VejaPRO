<!DOCTYPE html>
<html lang="lt" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="description" content="VejaPRO – maržų taisyklės." />
    <title>VejaPRO – Maržos</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" />
    <link rel="stylesheet" href="/static/admin-shared.css?v=6.4" />
    <style>
      .section { padding: 20px; border-bottom: 1px solid var(--border); }
      .section:last-child { border-bottom: none; }
    </style>
    <script>try{var t=localStorage.getItem("vejapro_theme")||"light";document.documentElement.dataset.theme=t;}catch(e){}</script>
  </head>
  <body data-layout="topbar">
      <main class="main-content">
        <div class="page-header">
          <h1>Maržų taisyklės</h1>
        </div>
        <div class="content-area">
          <div class="card">
            <!-- V3 Global Attention (recent margin changes) -->
            <div id="globalAttention" class="mini-triage" style="display:none; margin:16px 20px;"></div>
            <!-- V3 AI summary -->
            <div id="aiSummaryPill" class="ai-summary-pill" style="display:none; margin:0 20px 12px;"></div>
            <!-- V3 Preview calc -->
            <div id="previewCalc" class="hint" style="display:none; margin:0 20px 8px; padding:10px; background:var(--accent-subtle); border-radius:var(--radius);"></div>
            <div class="section">
              <form id="marginForm" class="form-grid">
                <div>
                  <label for="serviceType">Paslaugos tipas</label>
                  <input id="serviceType" class="form-input" type="text" placeholder="pvz., Vejos įrengimas" required />
                </div>
                <div>
                  <label for="marginPercent">Maržos %</label>
                  <input id="marginPercent" class="form-input" type="number" step="0.01" min="0" required />
                </div>
                <div>
                  <button class="btn btn-primary" type="submit">Sukurti taisyklę</button>
                </div>
              </form>
              <div class="hint" id="formStatus" style="margin-top:8px;"></div>
            </div>

            <div class="section">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Paslauga</th>
                    <th>Maržos %</th>
                    <th>Galioja nuo</th>
                    <th>Galioja iki</th>
                    <th>Sukūrė</th>
                    <th>Sukurta</th>
                    <th>Būsena</th>
                  </tr>
                </thead>
                <tbody id="marginRows"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>

    <script src="/static/admin-shared.js?v=6.4"></script>
    <script>
      const formStatus = document.getElementById("formStatus");
      const rows = document.getElementById("marginRows");
      const marginForm = document.getElementById("marginForm");

      const _fmtDate = (value) => {
        if (!value) return "-";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toISOString();
      };

      let _rulesVersion = 0;
      let _recentChangesCount = 0;

      const updatePreviewCalc = () => {
        const el = document.getElementById("previewCalc");
        if (!el) return;
        const st = (document.getElementById("serviceType")?.value || "").trim();
        const mp = parseFloat(document.getElementById("marginPercent")?.value || "0");
        if (!st) {
          el.textContent = "";
          el.style.display = "none";
          return;
        }
        el.style.display = "block";
        el.textContent = `Peržiūra: nauja taisyklė „${escapeHtml(st)}“ su marža ${mp}%`;
      };

      const updateAiSummaryAndAttention = () => {
        const pill = document.getElementById("aiSummaryPill");
        const ga = document.getElementById("globalAttention");
        if (pill) {
          if (_recentChangesCount > 0) {
            pill.textContent = `${_recentChangesCount} taisyklių pakeitimai per 7 d.`;
            pill.className = "ai-summary-pill pill-warning";
          } else {
            pill.textContent = `${_rulesVersion} maržų taisykl${_rulesVersion === 1 ? "ė" : "ių"}`;
            pill.className = "ai-summary-pill";
          }
          pill.style.display = "block";
        }
        if (ga) {
          if (_recentChangesCount > 0) {
            ga.innerHTML = `<strong>Dėmesio:</strong> Pastarosiomis 7 dienomis pridėta ${_recentChangesCount} nauja maržos taisyklė.`;
            ga.style.display = "block";
          } else {
            ga.style.display = "none";
          }
        }
      };

      const renderRows = (items) => {
        rows.innerHTML = "";
        if (!items.length) {
          rows.innerHTML = '<tr><td colspan="7" style="color:var(--ink-muted);">Maržų taisyklių dar nėra.</td></tr>';
          return;
        }
        for (const item of items) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td data-label="Paslauga">${escapeHtml(item.service_type)}</td>
            <td data-label="Maržos %">${escapeHtml(String(item.margin_percent))}</td>
            <td data-label="Galioja nuo">${escapeHtml(_fmtDate(item.valid_from))}</td>
            <td data-label="Galioja iki">${escapeHtml(_fmtDate(item.valid_until))}</td>
            <td data-label="Sukūrė" style="color:var(--ink-muted);">${escapeHtml(item.created_by || "-")}</td>
            <td data-label="Sukurta" style="color:var(--ink-muted);">${escapeHtml(_fmtDate(item.created_at))}</td>
            <td data-label="Būsena">${item.is_active ? '<span class="pill pill-success">Aktyvi</span>' : "Istorinė"}</td>
          `;
          rows.appendChild(tr);
        }
      };

      const fetchMargins = async () => {
        if (!Auth.isSet()) {
          rows.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--ink-muted);padding:32px;">Prisijunkite arba sugeneruokite žetoną (šoninė juosta apačioje).</td></tr>';
          return;
        }
        formStatus.textContent = "";
        try {
          const resp = await authFetch("/api/v1/admin/margins");
          const body = await resp.json();
          _rulesVersion = body.rules_version ?? body.items?.length ?? 0;
          _recentChangesCount = body.recent_changes_count ?? 0;
          renderRows(body.items || []);
          updateAiSummaryAndAttention();
        } catch (err) {
          formStatus.textContent = err.message || "Įkėlimas nepavyko.";
          formStatus.style.color = "var(--error)";
        }
      };

      marginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        formStatus.textContent = "";
        const serviceType = document.getElementById("serviceType").value.trim();
        const marginPercent = Number(document.getElementById("marginPercent").value);
        try {
          await authFetch("/api/v1/admin/margins", {
            method: "POST",
            body: JSON.stringify({
              service_type: serviceType,
              margin_percent: marginPercent,
            }),
          });
          formStatus.textContent = "Nauja maržos taisyklė sukurta.";
          formStatus.style.color = "var(--ink-muted)";
          document.getElementById("marginPercent").value = "";
          await fetchMargins();
        } catch (err) {
          formStatus.textContent = err.message || "Sukūrimas nepavyko.";
          formStatus.style.color = "var(--error)";
        }
      });

      fetchMargins();
      document.getElementById("serviceType")?.addEventListener("input", updatePreviewCalc);
      document.getElementById("serviceType")?.addEventListener("change", updatePreviewCalc);
      document.getElementById("marginPercent")?.addEventListener("input", updatePreviewCalc);
    </script>
  </body>
</html>
