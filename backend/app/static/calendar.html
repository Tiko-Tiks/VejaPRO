<!DOCTYPE html>
<html lang="lt" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="description" content="VejaPRO – kalendorius ir vizitai." />
    <title>VejaPRO – Kalendorius</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" />
    <link rel="stylesheet" href="/static/admin-shared.css?v=6.0" />
    <link rel="stylesheet" href="/static/vendor/flatpickr/flatpickr.min.css" />
    <style>
      textarea { min-height: 70px; resize: vertical; }
      .flatpickr-wrapper { display: block; width: 100%; }
      .flatpickr-input { display: block; width: 100%; box-sizing: border-box; }
      .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 14px; }
      .section { padding: 20px; border-bottom: 1px solid var(--border); }
      .section:last-child { border-bottom: none; }
      .token-row { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end; }
    </style>
    <script>try{var t=localStorage.getItem("vejapro_theme")||"light";document.documentElement.dataset.theme=t;}catch(e){}</script>
  </head>
  <body>
    <button class="hamburger" aria-label="Meniu">&#9776;</button>
    <div class="sidebar-overlay"></div>
    <div class="admin-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/"><img src="/static/logo.png" alt="VejaPRO" class="logo" /></a>
        </div>
        <nav class="sidebar-nav" id="sidebarNav"></nav>
        <div class="sidebar-token token-card">
          <div class="token-card-header">
            <span>&#128274; Žetonas</span>
            <span id="tokenBadge" class="pill pill-gray">Nenustatytas</span>
          </div>
          <div class="token-card-body">
            <input id="tokenInput" type="password" class="form-input" placeholder="JWT žetonas" />
            <div style="display:flex;gap:6px;margin-top:8px;">
              <button class="btn btn-sm" id="btnGenerate" type="button">Gen.</button>
              <button class="btn btn-sm btn-secondary" id="btnSaveToken" type="button">Ės.</button>
            </div>
            <div id="tokenStatus" style="font-size:11px;color:var(--sidebar-ink-muted);margin-top:6px;"></div>
          </div>
        </div>
        <div class="sidebar-footer">V6.0</div>
      </aside>
      <main class="main-content">
        <div class="page-header">
          <h1>Kalendorius</h1>
        </div>
        <div class="content-area">
          <div class="card">
            <div class="section">
          <strong>Naujas susitikimas</strong>
          <div class="form-grid" style="margin-top: 12px;">
            <div>
              <label>Projekto numeris</label>
              <input id="newProjectId" placeholder="Neprivaloma" />
            </div>
            <div>
              <label>Skambučio užklausa</label>
              <input id="newCallRequestId" placeholder="Neprivaloma" />
            </div>
            <div>
              <label>Darbuotojas</label>
              <input id="newResourceId" placeholder="Neprivaloma" />
              <div class="hint">Jei neįvesta, sistema parinks automatiškai.</div>
            </div>
            <div>
              <label>Pradžia</label>
              <input id="newStartsAt" type="text" placeholder="Pasirinkite datą ir laiką" />
            </div>
            <div>
              <label>Pabaiga</label>
              <input id="newEndsAt" type="text" placeholder="Pasirinkite datą ir laiką" />
            </div>
            <div>
              <label>Būsena</label>
              <select id="newStatus">
                <option value="CONFIRMED">Patvirtinta</option>
                <option value="CANCELLED">Atšaukta</option>
              </select>
            </div>
            <div style="grid-column: 1 / -1;">
              <label>Pastabos</label>
              <textarea id="newNotes" placeholder="Neprivaloma pastaba"></textarea>
            </div>
            <button class="btn btn-primary" id="createAppointment">Sukurti susitikimą</button>
          </div>
        </div>

        <details class="section">
          <summary>Planavimo įrankiai <span class="hint">(dienos patvirtinimas)</span></summary>
          <div>
          <p class="hint" style="margin-top: 8px;">
            Patvirtinus dieną, tos dienos vizitai bus užrakinti ir nebus automatiškai perkeliami.
          </p>
          <div class="form-grid" style="margin-top: 12px;">
            <div>
              <label>Diena</label>
              <input id="approveRouteDate" type="text" placeholder="Pasirinkite datą" />
            </div>
            <div>
              <label>Darbuotojas (neprivaloma)</label>
              <input id="approveResourceId" placeholder="Neprivaloma" />
            </div>
            <div style="grid-column: 1 / -1;">
              <label>Pastaba</label>
              <textarea id="approveComment" placeholder="Neprivaloma pastaba"></textarea>
            </div>
            <button class="btn btn-primary" id="approveDay">Patvirtinti dieną</button>
          </div>
          </div>
        </details>

        <details class="section">
          <summary>Rezervacijos (Hold) <span class="hint">(balso/pokalbio kanalui)</span></summary>
          <div>
          <p class="hint" style="margin-top: 8px;">
            Laikinų rezervacijų kūrimas balso arba pokalbio kanalams.
          </p>
          <div class="form-grid" style="margin-top: 12px;">
            <div>
              <label>Kanalas</label>
              <select id="holdChannel">
                <option value="VOICE">Balsas</option>
                <option value="CHAT">Pokalbis</option>
              </select>
            </div>
            <div>
              <label>Pokalbio ID</label>
              <input id="holdConversationId" placeholder="Pokalbio identifikatorius" />
            </div>
            <div>
              <label>Darbuotojas</label>
              <input id="holdResourceId" placeholder="Neprivaloma" />
            </div>
            <div>
              <label>Vizito tipas</label>
              <input id="holdVisitType" value="PRIMARY" />
            </div>
            <div>
              <label>Projekto numeris</label>
              <input id="holdProjectId" placeholder="Neprivaloma jei yra skambučio užklausa" />
            </div>
            <div>
              <label>Skambučio užklausa</label>
              <input id="holdCallRequestId" placeholder="Neprivaloma jei yra projektas" />
            </div>
            <div>
              <label>Oro sąlygų klasė</label>
              <select id="holdWeatherClass">
                <option value="MIXED" selected>Mišri</option>
                <option value="SOIL_SENSITIVE">Jautri dirvožemiui</option>
                <option value="WEATHER_RESISTANT">Atspari orui</option>
              </select>
            </div>
            <div>
              <label>Pradžia</label>
              <input id="holdStartsAt" type="text" placeholder="Pasirinkite datą ir laiką" />
            </div>
            <div>
              <label>Pabaiga</label>
              <input id="holdEndsAt" type="text" placeholder="Pasirinkite datą ir laiką" />
            </div>
            <div style="grid-column: 1 / -1;">
              <label>Atšaukimo pastaba</label>
              <textarea id="holdCancelComment" placeholder="Neprivaloma pastaba"></textarea>
            </div>
            <div style="grid-column: 1 / -1; display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn btn-primary" id="holdCreateBtn" type="button">Sukurti rezervaciją</button>
              <button class="btn btn-ghost" id="holdConfirmBtn" type="button">Patvirtinti</button>
              <button class="btn btn-ghost" id="holdCancelBtn" type="button">Atšaukti</button>
              <button class="btn btn-ghost" id="holdExpireBtn" type="button">Naikinti pasibaigusius</button>
            </div>
            <div id="holdResultBox" style="grid-column: 1 / -1; display: none;">
              <div class="hint" id="holdResultMeta" style="margin-bottom: 6px;"></div>
              <pre class="mono" id="holdResultText" style="white-space: pre-wrap; margin: 0;"></pre>
            </div>
          </div>
          </div>
        </details>

        <details class="section">
          <summary>Perplanavimas <span class="hint">(vizitų perkėlimas)</span></summary>
          <div>
          <p class="hint" style="margin-top: 8px;">
            Perplanavimas vyksta dviem etapais: peržiūra ir patvirtinimas. Patvirtinus, sistema atšaukia senus vizitus ir sukuria naujus.
          </p>
          <div class="form-grid" style="margin-top: 12px;">
            <div>
              <label>Diena</label>
              <input id="reschedRouteDate" type="text" placeholder="Pasirinkite datą..." />
            </div>
            <div>
              <label>Darbuotojas (neprivaloma)</label>
              <input id="reschedResourceId" placeholder="Neprivaloma" />
              <div class="hint">Jei neįvesta, sistema naudos numatytąjį darbuotoją.</div>
            </div>
            <div>
              <label>Priežastis</label>
              <select id="reschedReason">
                <option value="WEATHER">Lijo / per šlapia</option>
                <option value="TECHNICAL_ISSUE">Techninis gedimas</option>
                <option value="RESOURCE_UNAVAILABLE">Resursas nepasiekiamas</option>
                <option value="TIME_OVERFLOW">Nespėjome</option>
                <option value="OTHER">Kita</option>
              </select>
            </div>
            <div>
              <label>Apimtis</label>
              <select id="reschedScope">
                <option value="DAY" selected>Diena</option>
                <option value="WEEK">Savaitė</option>
              </select>
            </div>
            <div style="grid-column: 1 / -1;">
              <label>Greitos priežastys</label>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn btn-ghost" data-resched-quick="WEATHER" data-resched-comment="Lijo / per slapia" type="button">Lijo / per slapia</button>
                <button class="btn btn-ghost" data-resched-quick="TECHNICAL_ISSUE" data-resched-comment="Techninis gedimas" type="button">Techninis gedimas</button>
                <button class="btn btn-ghost" data-resched-quick="TIME_OVERFLOW" data-resched-comment="Rangovas nespejo" type="button">Rangovas nespejo</button>
                <button class="btn btn-ghost" data-resched-quick="OTHER" data-resched-comment="Klientas paprase perkelti" type="button">Klientas paprase perkelti</button>
                <button class="btn btn-ghost" data-resched-quick="OTHER" data-resched-comment="" type="button">Kita</button>
              </div>
            </div>
            <div style="grid-column: 1 / -1; display: flex; gap: 12px; flex-wrap: wrap; align-items: end;">
              <div>
                <label>Saugoti užrakintus (lygis)</label>
                <input id="reschedPreserveLockedLevel" type="number" min="0" max="3" value="1" />
              </div>
              <label style="display: flex; gap: 8px; align-items: center;">
                <input id="reschedAllowWeatherResistant" type="checkbox" checked />
                Leisti pakeisti atspariais orui
              </label>
            </div>
            <div style="grid-column: 1 / -1;">
              <label>Pastaba</label>
              <textarea id="reschedComment" placeholder="Neprivaloma pastaba"></textarea>
            </div>
            <div style="grid-column: 1 / -1; display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn btn-ghost" id="reschedPreview">Peržiūra</button>
              <button class="btn btn-primary" id="reschedConfirm" disabled>Patvirtinti perplanavimą</button>
            </div>
            <div id="reschedPreviewBox" style="grid-column: 1 / -1; display: none;">
              <div class="hint" id="reschedPreviewMeta" style="margin-bottom: 6px;"></div>
              <div class="hint" id="reschedPreviewCountdown" style="margin-bottom: 10px;"></div>
              <div class="table-wrap">
                <table class="data-table" id="reschedActionsTable">
                  <thead>
                    <tr>
                      <th>Veiksmas</th>
                      <th>Susitikimo nr.</th>
                      <th>Projekto nr.</th>
                      <th>Skambučio užkl.</th>
                      <th>Pradžia</th>
                      <th>Pabaiga</th>
                      <th>Oro kl.</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <pre class="mono" id="reschedPreviewText" style="white-space: pre-wrap; margin: 0; display: none;"></pre>
            </div>
          </div>
          </div>
        </details>

        <!-- V3 Global Attention (laukiantys HELD) -->
        <div id="attentionTriage" class="section" style="display:none;">
          <strong>Laukia patvirtinimo</strong>
          <div id="attentionCards" class="mini-triage" style="margin-top:12px;"></div>
        </div>

        <div class="section">
          <div class="form-grid">
            <div>
              <label>Būsena</label>
              <select id="statusFilter">
                <option value="">Bet kokia</option>
                <option value="CONFIRMED">PATVIRTINTA</option>
                <option value="HELD">LAIKINAI REZERVUOTA</option>
                <option value="CANCELLED">ATŠAUKTA</option>
              </select>
            </div>
            <div>
              <label>Nuo</label>
              <input id="fromFilter" type="text" placeholder="Pasirinkite datą ir laiką" />
            </div>
            <div>
              <label>Iki</label>
              <input id="toFilter" type="text" placeholder="Pasirinkite datą ir laiką" />
            </div>
            <div>
              <label>Limitas</label>
              <select id="limitSelect">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
            </div>
            <div style="align-self: end; display: flex; gap: 8px;">
              <button class="btn btn-primary" id="applyFilters">Taikyti</button>
              <button class="btn btn-ghost" id="clearFilters">Valyti</button>
            </div>
          </div>
        </div>

        <div class="section">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Pradžia</th>
                <th>Pabaiga</th>
                <th>Būsena</th>
                <th>Projekto ID</th>
                <th>Skambučio užklausos ID</th>
                <th>Pastabos</th>
                <th>Veiksmai</th>
              </tr>
            </thead>
            <tbody id="appointmentTable">
              <tr><td colspan="8">Nėra įrašų</td></tr>
            </tbody>
          </table>
        </div>

        <div class="section" style="display:flex;justify-content:space-between;align-items:center;">
          <div id="pageInfo">Paruošta</div>
          <button class="btn btn-primary" id="loadMore">Įkelti daugiau</button>
        </div>
        <div class="hint" id="statusMessage" style="padding:12px 20px;"></div>
      </div>
        </div>
      </main>
    </div>

    <div class="modal-backdrop" id="editModal">
      <div class="modal" style="max-width:520px;">
        <div class="modal-header">
          <strong>Atnaujinti susitikimą</strong>
          <button class="btn btn-ghost" id="closeModal">Uždaryti</button>
        </div>
        <div class="modal-body">
        <div class="form-grid">
          <div>
            <label>Būsena</label>
            <select id="editStatus">
              <option value="CONFIRMED">PATVIRTINTA</option>
              <option value="CANCELLED">ATŠAUKTA</option>
            </select>
          </div>
          <div>
            <label>Pradžia</label>
            <input id="editStartsAt" type="text" placeholder="Pasirinkite datą ir laiką" disabled />
          </div>
          <div>
            <label>Pabaiga</label>
            <input id="editEndsAt" type="text" placeholder="Pasirinkite datą ir laiką" disabled />
          </div>
          <div style="grid-column: 1 / -1;">
            <label>Pastabos</label>
            <textarea id="editNotes"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" id="cancelEdit">Atšaukti</button>
          <button class="btn btn-primary" id="saveEdit">Išsaugoti</button>
        </div>
        </div>
      </div>
    </div>

    <script src="/static/admin-shared.js?v=6.0"></script>
    <script src="/static/vendor/flatpickr/flatpickr.min.js"></script>
    <script src="/static/vendor/flatpickr/l10n/lt.js"></script>
    <script>
      document.getElementById("sidebarNav").innerHTML = sidebarHTML("/admin/calendar");
      if (typeof initSidebar === "function") initSidebar();
      if (typeof initTokenCard === "function") initTokenCard();

      const tokenInput = document.getElementById("tokenInput");
      const tokenStatus = document.getElementById("tokenStatus");
      const tokenBadge = document.getElementById("tokenBadge");
      const statusMessage = document.getElementById("statusMessage");
      const appointmentTable = document.getElementById("appointmentTable");
      const pageInfo = document.getElementById("pageInfo");

      let nextCursor = null;
      let editingId = null;

      const setStatus = (message, isError = false) => {
        statusMessage.textContent = message;
        statusMessage.style.color = isError ? "var(--error)" : "var(--ink-muted)";
      };

      const fetchWithAuth = async (url, options = {}) => authFetch(url, options);

      const pad = (value) => String(value).padStart(2, "0");

      const toLocalIso = (value) => {
        if (!value) return null;
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return null;
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        const seconds = pad(date.getSeconds());
        const offsetMinutes = -date.getTimezoneOffset();
        const sign = offsetMinutes >= 0 ? "+" : "-";
        const offsetAbs = Math.abs(offsetMinutes);
        const offsetHours = pad(Math.floor(offsetAbs / 60));
        const offsetMins = pad(offsetAbs % 60);
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${sign}${offsetHours}:${offsetMins}`;
      };

      const toLocalInputValue = (value) => {
        if (!value) return "";
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return "";
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      };

      const datePickerLocale = flatpickr && flatpickr.l10ns && flatpickr.l10ns.lt
        ? { ...flatpickr.l10ns.lt, firstDayOfWeek: 1 }
        : null;

      const setPickerValue = (input, value) => {
        if (!input) return;
        if (input._flatpickr) {
          if (value) {
            input._flatpickr.setDate(value, false);
          } else {
            input._flatpickr.clear();
          }
          return;
        }
        input.value = value ? toLocalInputValue(value) : "";
      };

      const _fmtDate = (value) => {
        if (!value) return "-";
        try {
          return new Date(value).toLocaleString("lt-LT", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hourCycle: "h23",
          });
        } catch (err) {
          return value;
        }
      };

      const clearTable = () => {
        appointmentTable.innerHTML = "";
      };

      const appendRow = (item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="mono" data-label="ID">${escapeHtml(item.id)}</td>
          <td data-label="Pradžia">${escapeHtml(_fmtDate(item.starts_at))}</td>
          <td data-label="Pabaiga">${escapeHtml(_fmtDate(item.ends_at))}</td>
          <td data-label="Būsena"><span class="pill">${escapeHtml(item.status)}</span></td>
          <td class="mono" data-label="Projekto ID">${escapeHtml(item.project_id || "-")}</td>
          <td class="mono" data-label="Skambučio užklausos ID">${escapeHtml(item.call_request_id || "-")}</td>
          <td data-label="Pastabos">${escapeHtml(item.notes || "-")}</td>
          <td data-label="Veiksmai"><button class="btn btn-ghost" data-action="edit">Redaguoti</button></td>
        `;
        row.querySelector('[data-action="edit"]').addEventListener("click", () => openEdit(item));
        appointmentTable.appendChild(row);
      };

      const loadAppointments = async (reset = false) => {
        if (!Auth.isSet()) {
          appointmentTable.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--ink-muted);padding:32px;">Prisijunkite arba sugeneruokite žetoną (šoninė juosta apačioje).</td></tr>';
          setStatus("");
          return;
        }
        try {
          if (reset) {
            nextCursor = null;
            clearTable();
          }
          setStatus("Įkeliami susitikimai...");
          const status = document.getElementById("statusFilter").value;
          const fromValue = toLocalIso(document.getElementById("fromFilter").value);
          const toValue = toLocalIso(document.getElementById("toFilter").value);
          const limit = document.getElementById("limitSelect").value;
          const params = new URLSearchParams();
          if (status) params.set("status", status);
          if (fromValue) params.set("from_ts", fromValue);
          if (toValue) params.set("to_ts", toValue);
          if (limit) params.set("limit", limit);
          if (nextCursor) params.set("cursor", nextCursor);

          const resp = await fetchWithAuth(`/api/v1/admin/appointments?${params.toString()}`);
          const data = await resp.json();

          if (!data.items || data.items.length === 0) {
            if (reset) {
              appointmentTable.innerHTML = `<tr><td colspan="8">Nėra įrašų</td></tr>`;
            }
            setStatus("Daugiau įrašų nėra.");
          } else {
            data.items.forEach(appendRow);
            setStatus(`Įkelta susitikimų: ${data.items.length}.`);
          }

          nextCursor = data.has_more ? data.next_cursor : null;
          pageInfo.textContent = data.has_more ? "Yra daugiau" : "Sąrašo pabaiga";
        } catch (err) {
          setStatus(err.message || "Netikėta klaida.", true);
          appointmentTable.innerHTML = `<tr><td colspan="8">Netikėta klaida.</td></tr>`;
        }
      };

      const openEdit = (item) => {
        editingId = item.id;
        document.getElementById("editStatus").value = item.status || "CONFIRMED";
        setPickerValue(document.getElementById("editStartsAt"), item.starts_at);
        setPickerValue(document.getElementById("editEndsAt"), item.ends_at);
        document.getElementById("editNotes").value = item.notes || "";
        document.getElementById("editModal").classList.add("active");
      };

      const closeEdit = () => {
        editingId = null;
        document.getElementById("editModal").classList.remove("active");
      };

      document.getElementById("closeModal").addEventListener("click", closeEdit);
      document.getElementById("cancelEdit").addEventListener("click", closeEdit);

      document.getElementById("saveEdit").addEventListener("click", async () => {
        if (!editingId) return;
        try {
          const payload = {};
          const status = document.getElementById("editStatus").value;
          const notes = document.getElementById("editNotes").value.trim();

          if (status) payload.status = status;
          payload.notes = notes;

          await fetchWithAuth(`/api/v1/admin/appointments/${encodeURIComponent(editingId)}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          closeEdit();
          await loadAppointments(true);
          loadMiniTriage();
        } catch (err) {
          setStatus(err.message || "Atnaujinimas nepavyko.", true);
        }
      });

      document.getElementById("applyFilters").addEventListener("click", () => {
        loadAppointments(true);
        loadMiniTriage();
      });
      document.getElementById("clearFilters").addEventListener("click", () => {
        document.getElementById("statusFilter").value = "";
        setPickerValue(document.getElementById("fromFilter"), null);
        setPickerValue(document.getElementById("toFilter"), null);
        document.getElementById("limitSelect").value = "50";
        loadAppointments(true);
      });

      document.getElementById("loadMore").addEventListener("click", () => {
        if (nextCursor) {
          loadAppointments(false);
        }
      });

      document.getElementById("createAppointment").addEventListener("click", async () => {
        try {
          const payload = {
            project_id: document.getElementById("newProjectId").value.trim() || null,
            call_request_id: document.getElementById("newCallRequestId").value.trim() || null,
            resource_id: document.getElementById("newResourceId").value.trim() || null,
            starts_at: toLocalIso(document.getElementById("newStartsAt").value),
            ends_at: toLocalIso(document.getElementById("newEndsAt").value),
            status: document.getElementById("newStatus").value,
            notes: document.getElementById("newNotes").value.trim() || null,
          };
          if (!payload.starts_at || !payload.ends_at) {
            setStatus("Pradžios ir pabaigos laikas yra privalomi.", true);
            return;
          }
          const resp = await fetchWithAuth("/api/v1/admin/appointments", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          await resp.json();
          setStatus("Susitikimas sukurtas.");
          document.getElementById("newProjectId").value = "";
          document.getElementById("newCallRequestId").value = "";
          document.getElementById("newResourceId").value = "";
          setPickerValue(document.getElementById("newStartsAt"), null);
          setPickerValue(document.getElementById("newEndsAt"), null);
          document.getElementById("newNotes").value = "";
          await loadAppointments(true);
        } catch (err) {
          setStatus(err.message || "Sukūrimas nepavyko.", true);
        }
      });

      document.getElementById("approveDay").addEventListener("click", async () => {
        try {
          const routeDate = document.getElementById("approveRouteDate").value.trim();
          if (!routeDate) {
            setStatus("Diena yra privaloma.", true);
            return;
          }

          const resourceId = document.getElementById("approveResourceId").value.trim();
          const comment = document.getElementById("approveComment").value.trim();

          const payload = {
            route_date: routeDate,
            comment,
          };
          if (resourceId) {
            payload.resource_id = resourceId;
          }

          setStatus("Patvirtinama diena...");
          const resp = await fetchWithAuth("/api/v1/admin/schedule/daily-approve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          setStatus(`Diena patvirtinta. Atnaujinta susitikimų: ${data.updated_count ?? 0}.`);
          await loadAppointments(true);
        } catch (err) {
          setStatus(err.message || "Dienos patvirtinimas nepavyko.", true);
        }
      });

      let holdState = null;

      const parseMaybeJson = (text) => {
        if (!text) return { text: "" };
        const trimmed = String(text).trim();
        if (!trimmed) return { text: "" };
        if (!(trimmed.startsWith("{") || trimmed.startsWith("["))) return { text: trimmed };
        try {
          return { json: JSON.parse(trimmed), text: trimmed };
        } catch {
          return { text: trimmed };
        }
      };

      const setHoldResult = (value, isError = false) => {
        const box = document.getElementById("holdResultBox");
        const meta = document.getElementById("holdResultMeta");
        const text = document.getElementById("holdResultText");
        if (!box || !text) return;
        box.style.display = "block";
        const parsed = typeof value === "string" ? parseMaybeJson(value) : { json: value };
        const rendered = parsed.json ? JSON.stringify(parsed.json, null, 2) : parsed.text || "";
        text.textContent = rendered;
        if (meta) {
          meta.textContent = isError ? "Klaida" : "Atsakymas";
          meta.classList.toggle("error", isError);
        }
      };

      document.getElementById("holdCreateBtn").addEventListener("click", async () => {
        try {
          const channel = document.getElementById("holdChannel").value;
          const conversationId = document.getElementById("holdConversationId").value.trim();
          const resourceId = document.getElementById("holdResourceId").value.trim();
          const visitType = document.getElementById("holdVisitType").value.trim() || "PRIMARY";
          const projectId = document.getElementById("holdProjectId").value.trim();
          const callRequestId = document.getElementById("holdCallRequestId").value.trim();
          const startsAt = toLocalIso(document.getElementById("holdStartsAt").value);
          const endsAt = toLocalIso(document.getElementById("holdEndsAt").value);
          const weatherClass = document.getElementById("holdWeatherClass").value;

          if (!conversationId) {
            setStatus("Conversation ID yra privalomas.", true);
            return;
          }
          if (!resourceId) {
            setStatus("Resurso ID yra privalomas.", true);
            return;
          }
          if (!startsAt || !endsAt) {
            setStatus("Pradžios ir pabaigos laikas yra privalomi.", true);
            return;
          }
          if (!projectId && !callRequestId) {
            setStatus("Būtina pateikti project_id arba call_request_id.", true);
            return;
          }

          const payload = {
            channel,
            conversation_id: conversationId,
            resource_id: resourceId,
            visit_type: visitType,
            starts_at: startsAt,
            ends_at: endsAt,
            weather_class: weatherClass,
          };
          if (projectId) payload.project_id = projectId;
          if (callRequestId) payload.call_request_id = callRequestId;

          setStatus("Kuriama HOLD rezervacija...");
          const resp = await fetchWithAuth("/api/v1/admin/schedule/holds", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          holdState = { channel, conversation_id: conversationId, appointment_id: data.appointment_id };
          setStatus(`HOLD sukurta. appointment_id=${data.appointment_id}`);
          setHoldResult(data, false);
          await loadAppointments(true);
        } catch (err) {
          setStatus(err.message || "HOLD sukurti nepavyko.", true);
          setHoldResult(err.message || String(err), true);
        }
      });

      document.getElementById("holdConfirmBtn").addEventListener("click", async () => {
        try {
          const channel = document.getElementById("holdChannel").value;
          const conversationId = document.getElementById("holdConversationId").value.trim();
          if (!conversationId) {
            setStatus("Conversation ID yra privalomas.", true);
            return;
          }

          setStatus("Tvirtinama HOLD rezervacija...");
          const resp = await fetchWithAuth("/api/v1/admin/schedule/holds/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ channel, conversation_id: conversationId }),
          });
          const data = await resp.json();
          holdState = { channel, conversation_id: conversationId, appointment_id: data.appointment_id };
          setStatus(`HOLD patvirtinta. appointment_id=${data.appointment_id}`);
          setHoldResult(data, false);
          await loadAppointments(true);
        } catch (err) {
          setStatus(err.message || "HOLD patvirtinti nepavyko.", true);
          setHoldResult(err.message || String(err), true);
        }
      });

      document.getElementById("holdCancelBtn").addEventListener("click", async () => {
        try {
          const channel = document.getElementById("holdChannel").value;
          const conversationId = document.getElementById("holdConversationId").value.trim();
          const comment = document.getElementById("holdCancelComment").value.trim();
          if (!conversationId) {
            setStatus("Conversation ID yra privalomas.", true);
            return;
          }

          setStatus("Atšaukiama HOLD rezervacija...");
          const resp = await fetchWithAuth("/api/v1/admin/schedule/holds/cancel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ channel, conversation_id: conversationId, comment }),
          });
          const data = await resp.json();
          holdState = { channel, conversation_id: conversationId, appointment_id: data.appointment_id };
          setStatus(`HOLD atšaukta. appointment_id=${data.appointment_id}`);
          setHoldResult(data, false);
          await loadAppointments(true);
        } catch (err) {
          setStatus(err.message || "HOLD atšaukti nepavyko.", true);
          setHoldResult(err.message || String(err), true);
        }
      });

      document.getElementById("holdExpireBtn").addEventListener("click", async () => {
        try {
          setStatus("Expire: atšaukiamos pasibaigusios HOLD rezervacijos...");
          const resp = await fetchWithAuth("/api/v1/admin/schedule/holds/expire", {
            method: "POST",
          });
          const data = await resp.json();
          setStatus(`Expire atliktas. expired_count=${data.expired_count ?? 0}`);
          setHoldResult(data, false);
          await loadAppointments(true);
        } catch (err) {
          setStatus(err.message || "Expire nepavyko.", true);
          setHoldResult(err.message || String(err), true);
        }
      });

      let reschedState = null;
      let reschedLastPreviewPayload = null;
      let reschedAutoRefreshAttempted = false;
      let reschedTimer = null;
      let lastReschedAutoComment = null;

      const stopReschedTimer = () => {
        if (reschedTimer) {
          clearInterval(reschedTimer);
          reschedTimer = null;
        }
      };

      const formatCountdownMs = (ms) => {
        const totalSec = Math.max(0, Math.floor(ms / 1000));
        const min = Math.floor(totalSec / 60);
        const sec = String(totalSec % 60).padStart(2, "0");
        return `${min}:${sec}`;
      };

      const getRescheduleConflictHint = (message) => {
        const msg = String(message || "").toLowerCase();
        if (msg.includes("pasibaig")) return "Perziura pasibaige (TTL). Paleiskite perziura is naujo.";
        if (msg.includes("hash")) return "Preview hash nesutapo. Reikia atnaujinti perziura.";
        if (msg.includes("versij") || msg.includes("pasikeit")) return "Duomenys pasikeite (row_version konfliktas).";
        return "Konfliktas tarp preview ir dabartines busenos.";
      };
      const renderReschedPreview = (data) => {
        const box = document.getElementById("reschedPreviewBox");
        const meta = document.getElementById("reschedPreviewMeta");
        const countdown = document.getElementById("reschedPreviewCountdown");
        const tableBody = document.querySelector("#reschedActionsTable tbody");
        const text = document.getElementById("reschedPreviewText");
        const actions = data.suggested_actions || [];
        const summary = data.summary || {};
        const scopeValue = (reschedLastPreviewPayload && reschedLastPreviewPayload.scope) || "DAY";

        if (meta) {
          const cancelCount = summary.cancel_count ?? 0;
          const createCount = summary.create_count ?? 0;
          const skippedLocked = summary.skipped_locked_count ?? 0;
          const travelMin = summary.total_travel_minutes ?? 0;
          meta.textContent = `Perziura (${scopeValue}): ${data.preview_id} | Galioja iki: ${data.preview_expires_at || "-"} | CANCEL: ${cancelCount} | CREATE: ${createCount} | Skipped locked: ${skippedLocked} | Travel(min): ${travelMin}`;
        }

        if (tableBody) {
          tableBody.innerHTML = "";
          for (const a of actions) {
            const tr = document.createElement("tr");
            const td = (value) => {
              const el = document.createElement("td");
              el.textContent = value ?? "";
              return el;
            };
            const actionLabel = a.action === "CANCEL" ? "CANCEL (old)" : (a.action === "CREATE" ? "CREATE (new)" : (a.action || ""));
            tr.appendChild(td(actionLabel));
            tr.appendChild(td(a.appointment_id || ""));
            tr.appendChild(td(a.project_id || ""));
            tr.appendChild(td(a.call_request_id || ""));
            tr.appendChild(td(_fmtDate(a.starts_at) || ""));
            tr.appendChild(td(_fmtDate(a.ends_at) || ""));
            tr.appendChild(td(a.weather_class || ""));
            tableBody.appendChild(tr);
          }
        }

        if (text) {
          // Hidden raw view for debugging / copy.
          const lines = [];
          lines.push(`preview_id=${data.preview_id}`);
          lines.push(`preview_hash=${data.preview_hash}`);
          lines.push(`preview_expires_at=${data.preview_expires_at}`);
          text.textContent = lines.join("\n");
        }

        box.style.display = "block";

        stopReschedTimer();
        const expiresAt = data.preview_expires_at ? Date.parse(data.preview_expires_at) : null;
        const updateCountdown = () => {
          if (!countdown) return;
          if (!expiresAt || Number.isNaN(expiresAt)) {
            countdown.textContent = "";
            return;
          }
          const msLeft = expiresAt - Date.now();
          if (msLeft <= 0) {
            countdown.textContent = "Peržiūra nebegalioja. Paleiskite peržiūrą dar kartą.";
            document.getElementById("reschedConfirm").disabled = true;
            stopReschedTimer();
            return;
          }
          countdown.textContent = `Liko laiko: ${formatCountdownMs(msLeft)}`;
        };
        updateCountdown();
        reschedTimer = setInterval(updateCountdown, 500);
      };

      document.querySelectorAll("[data-resched-quick]").forEach((btn) => {
        btn.addEventListener("click", (ev) => {
          ev.preventDefault();
          const reason = btn.getAttribute("data-resched-quick") || "OTHER";
          document.getElementById("reschedReason").value = reason;

          const comment = btn.getAttribute("data-resched-comment") ?? "";
          const commentEl = document.getElementById("reschedComment");
          const current = (commentEl.value || "").trim();
          const shouldOverwrite = !current || current === lastReschedAutoComment;
          if (shouldOverwrite) {
            commentEl.value = comment;
            lastReschedAutoComment = comment;
          }
          if (!comment) {
            commentEl.focus();
          }

          document.querySelectorAll("[data-resched-quick]").forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      document.getElementById("reschedPreview").addEventListener("click", async () => {
        try {
          const routeDate = document.getElementById("reschedRouteDate").value.trim();
          if (!routeDate) {
            setStatus("Diena yra privaloma.", true);
            return;
          }
          const resourceId = document.getElementById("reschedResourceId").value.trim();
          const scope = document.getElementById("reschedScope").value || "DAY";
          const reason = document.getElementById("reschedReason").value;
          const comment = document.getElementById("reschedComment").value.trim();
          const preserveLockedLevelRaw = document.getElementById("reschedPreserveLockedLevel").value;
          const preserveLockedLevel = Number.parseInt(preserveLockedLevelRaw || "1", 10);
          const allowReplaceWeatherResistant = !!document.getElementById("reschedAllowWeatherResistant").checked;

          const payload = {
            route_date: routeDate,
            scope,
            reason,
            comment,
            rules: {
              preserve_locked_level: Number.isFinite(preserveLockedLevel) ? preserveLockedLevel : 1,
              allow_replace_with_weather_resistant: allowReplaceWeatherResistant,
            },
          };
          if (resourceId) {
            payload.resource_id = resourceId;
          }
          reschedLastPreviewPayload = payload;
          reschedAutoRefreshAttempted = false;

          setStatus("Ruošiama peržiūra...");
          const resp = await fetchWithAuth("/api/v1/admin/schedule/reschedule/preview", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) {
            throw new Error(data?.detail || `Perziura nepavyko (HTTP ${resp.status}).`);
          }

          reschedState = data;
          renderReschedPreview(data);
          document.getElementById("reschedConfirm").disabled = false;
          setStatus("Peržiūra paruošta.");
        } catch (err) {
          stopReschedTimer();
          document.getElementById("reschedConfirm").disabled = true;
          document.getElementById("reschedPreviewBox").style.display = "none";
          setStatus(err.message || "Peržiūra nepavyko.", true);
        }
      });

      document.getElementById("reschedConfirm").addEventListener("click", async () => {
        try {
          if (!reschedState) {
            setStatus("Pirma reikia peržiūros.", true);
            return;
          }
          const reason = document.getElementById("reschedReason").value;
          const comment = document.getElementById("reschedComment").value.trim();

          const payload = {
            preview_id: reschedState.preview_id,
            preview_hash: reschedState.preview_hash,
            reason,
            comment,
            expected_versions: reschedState.expected_versions || {},
          };

          setStatus("Taikomas perplanavimas...");
          const resp = await fetchWithAuth("/api/v1/admin/schedule/reschedule/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) {
             const msg = data?.detail || `Perplanavimas nepavyko (HTTP ${resp.status}).`;
             if (resp.status === 409 || resp.status === 410) {
               // Typical reasons: preview expired, preview hash mismatch, row_version conflict.
               stopReschedTimer();
               document.getElementById("reschedConfirm").disabled = true;
               if (!reschedAutoRefreshAttempted && reschedLastPreviewPayload) {
                 reschedAutoRefreshAttempted = true;
                 setStatus(`${msg} ${getRescheduleConflictHint(msg)} Atnaujinama perziura...`, true);

                 const pr = await fetchWithAuth("/api/v1/admin/schedule/reschedule/preview", {
                   method: "POST",
                   headers: { "Content-Type": "application/json" },
                   body: JSON.stringify(reschedLastPreviewPayload),
                 });
                 const pd = await pr.json().catch(() => ({}));
                 if (!pr.ok) {
                   throw new Error(pd?.detail || `Perziura nepavyko (HTTP ${pr.status}).`);
                 }

                 reschedState = pd;
                 renderReschedPreview(pd);
                 document.getElementById("reschedConfirm").disabled = false;
                 setStatus("Perziura atnaujinta. Patikrinkite veiksmus ir patvirtinkite dar karta.");
                 return;
               }

               setStatus(`${msg} ${getRescheduleConflictHint(msg)} Paspauskite "Perziura" dar karta.`, true);
               return;
             }
             throw new Error(msg);
           }
          setStatus(`Perplanavimas atliktas. Nauju vizitu: ${data.new_appointment_ids?.length || 0}.`);
          reschedState = null;
          stopReschedTimer();
          document.getElementById("reschedConfirm").disabled = true;
          document.getElementById("reschedPreviewBox").style.display = "none";
          await loadAppointments(true);
        } catch (err) {
          setStatus(err.message || "Perplanavimas nepavyko.", true);
        }
      });

      [
        document.getElementById("newStartsAt"),
        document.getElementById("newEndsAt"),
        document.getElementById("holdStartsAt"),
        document.getElementById("holdEndsAt"),
        document.getElementById("fromFilter"),
        document.getElementById("toFilter"),
      ].filter(Boolean).forEach((input) => {
        flatpickr(input, {
          enableTime: true,
          time_24hr: true,
          dateFormat: "Y-m-d\\TH:i",
          altInput: true,
          altFormat: "d.m.Y H:i",
          allowInput: true,
          locale: datePickerLocale || undefined,
        });
      });

      const approveRouteEl = document.getElementById("approveRouteDate");
      if (approveRouteEl) flatpickr(approveRouteEl, {
        enableTime: false,
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d.m.Y",
        allowInput: true,
        locale: datePickerLocale || undefined,
      });

      const reschedRouteEl = document.getElementById("reschedRouteDate");
      if (reschedRouteEl) flatpickr(reschedRouteEl, {
        enableTime: false,
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d.m.Y",
        allowInput: true,
        locale: datePickerLocale || undefined,
      });

      const initToken = () => {
        const stored = Auth.get();
        if (stored && !tokenInput.value) {
          tokenInput.value = stored;
          tokenStatus.textContent = "Žetonas įkeltas iš naršyklės saugyklos.";
        }
        if (tokenBadge) {
          tokenBadge.textContent = Auth.isSet() ? "Aktyvus" : "Nenustatytas";
          tokenBadge.className = Auth.isSet() ? "pill pill-success" : "pill pill-gray";
        }
      };

      document.getElementById("btnSaveToken").addEventListener("click", () => {
        const token = Auth.normalize(tokenInput.value);
        if (token) {
          Auth.set(token);
          tokenInput.value = token;
          tokenStatus.textContent = "Žetonas išsaugotas.";
          showToast("Žetonas išsaugotas", "success");
        } else {
          Auth.remove();
          tokenStatus.textContent = "Žetonas ištrintas.";
        }
        if (tokenBadge) {
          tokenBadge.textContent = Auth.isSet() ? "Aktyvus" : "Nenustatytas";
          tokenBadge.className = Auth.isSet() ? "pill pill-success" : "pill pill-gray";
        }
      });

      document.getElementById("btnGenerate").addEventListener("click", async () => {
        try {
          tokenStatus.textContent = "Generuojamas žetonas...";
          const token = await Auth.generate();
          if (token) {
            tokenInput.value = token;
            tokenStatus.textContent = "Žetonas sugeneruotas.";
            showToast("Žetonas sugeneruotas", "success");
          } else {
            tokenStatus.textContent = "Žetono generavimas nepavyko.";
          }
        } catch (err) {
          tokenStatus.textContent = err.message || "Žetono generavimas nepavyko.";
        }
        if (tokenBadge) {
          tokenBadge.textContent = Auth.isSet() ? "Aktyvus" : "Nenustatytas";
          tokenBadge.className = Auth.isSet() ? "pill pill-success" : "pill pill-gray";
        }
      });

            const loadMiniTriage = async () => {
        try {
          const resp = await fetchWithAuth("/api/v1/admin/appointments/mini-triage?limit=10");
          const data = await resp.json();
          const container = document.getElementById("attentionCards");
          const section = document.getElementById("attentionTriage");
          if (!container || !section) return;
          const items = data.items || [];
          if (items.length === 0) {
            section.style.display = "none";
            return;
          }
          section.style.display = "block";
          container.innerHTML = items.map((t) => {
            const time = _fmtDate(t.starts_at);
            const cls = t.overdue ? "triage-card row-urgency-high" : "triage-card";
            const pa = t.primary_action || {};
            return `<div class="${cls}" data-id="${escapeHtml(t.appointment_id)}">
              <div class="triage-contact">${escapeHtml(time)}</div>
              <div class="triage-reason">Projektas: ${escapeHtml(t.project_id || t.call_request_id || "-")}</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" data-action="confirm" data-id="${escapeHtml(t.appointment_id)}">Patvirtinti</button>
                <button class="btn btn-ghost btn-sm" data-action="reschedule" data-id="${escapeHtml(t.appointment_id)}">Pasiūlyti kitą laiką</button>
              </div>
            </div>`;
          }).join("");
          container.querySelectorAll("button[data-action='confirm']").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-id");
              try {
                await fetchWithAuth(`/api/v1/admin/appointments/${id}/confirm-hold`, { method: "POST" });
                showToast("Patvirtinta", "success");
                loadMiniTriage();
                loadAppointments(true);
              } catch (err) {
                setStatus(err.message || "Nepavyko", true);
              }
            });
          });
          container.querySelectorAll("button[data-action='reschedule']").forEach((btn) => {
            btn.addEventListener("click", () => {
              document.getElementById("reschedRouteDate")?.focus();
              showToast("Naudokite Perplanavimas skiltį žemiau", "info");
            });
          });
        } catch {
          document.getElementById("attentionTriage").style.display = "none";
        }
      };

      initToken();
      // Atidėti duomenų įkėlimą, kad puslapis pirmiau nupieštų – vengiama „užšaldimo“ jausmo
      setTimeout(() => {
        loadAppointments(true);
        loadMiniTriage();
      }, 0);
    </script>
  </body>
</html>
