<!DOCTYPE html>
<html lang="lt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="description" content="VejaPRO – finansų knyga ir dokumentai." />
    <title>VejaPRO – Finansai</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" />
    <link rel="stylesheet" href="/static/admin-shared.css?v=3.1" />
    <style>
      .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; }
      .summary-card { padding: 16px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; }
      .summary-card .label { font-size: 12px; color: var(--ink-muted); text-transform: uppercase; margin-bottom: 6px; }
      .summary-card .value { font-size: 24px; font-weight: 700; }
      .value-green { color: var(--success); }
      .value-red { color: var(--error); }
      .value-blue { color: var(--info); }
      /* Tabs are styled by admin-shared.css (.tabs/.tab-item/.tab-content). */
      .empty-row { text-align: center; padding: 24px; color: var(--ink-muted); }
    </style>
  </head>
  <body>
    <button class="hamburger" aria-label="Meniu">&#9776;</button>
    <div class="sidebar-overlay"></div>
    <div class="admin-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/"><img src="/static/logo.png" alt="VejaPRO" class="logo" /></a>
          <span class="brand">VejaPRO</span>
        </div>
        <nav class="sidebar-nav" id="sidebarNav"></nav>
        <div class="sidebar-footer">V3.1 Admin - Modern Design</div>
      </aside>
      <main class="main-content">
        <div class="page-header">
          <h1>Finansai</h1>
        </div>
        <div class="content-area" style="display:flex;flex-direction:column;gap:20px;">
      <!-- Token -->
      <div class="token-card">
        <div class="token-card-header">
          <span>&#128274; Bearer žetonas</span>
          <span id="tokenBadge" class="pill pill-gray">Nenustatytas</span>
        </div>
        <div class="token-card-body">
          <div class="form-grid" style="grid-template-columns: 1fr auto auto;">
            <div class="form-group">
              <label for="token">Prieigos žetonas</label>
              <input id="token" type="password" class="form-input" placeholder="Įklijuokite JWT žetoną" />
            </div>
            <button class="btn" id="generateToken">Generuoti</button>
            <button class="btn btn-secondary" id="saveToken">Išsaugoti</button>
          </div>
          <div class="hint" id="tokenStatus" style="margin-top:6px;color:var(--ink-muted);">Žetonas nenustatytas.</div>
        </div>
      </div>

      <!-- Summary -->
      <div class="card">
        <div class="section">
          <h2>Suvestinė</h2>
          <div class="summary-grid" id="summaryCards">
            <div class="summary-card">
              <div class="label">Pajamos</div>
              <div class="value value-green" id="sumIncome">-</div>
            </div>
            <div class="summary-card">
              <div class="label">Išlaidos</div>
              <div class="value value-red" id="sumExpenses">-</div>
            </div>
            <div class="summary-card">
              <div class="label">Grynos išlaidos</div>
              <div class="value value-red" id="sumNet">-</div>
            </div>
            <div class="summary-card">
              <div class="label">Pelnas</div>
              <div class="value value-blue" id="sumProfit">-</div>
            </div>
            <div class="summary-card">
              <div class="label">Projektų</div>
              <div class="value" id="sumProjects">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main tabs panel -->
      <div class="card">
        <div class="section">
          <div class="tabs">
            <button class="tab-item active" data-tab="ledger" type="button">Knygos įrašai</button>
            <button class="tab-item" data-tab="documents" type="button">Dokumentai</button>
            <button class="tab-item" data-tab="vendors" type="button">Tiekėjų taisyklės</button>
            <button class="tab-item" data-tab="metrics" type="button">Metrika (live)</button>
          </div>

          <!-- TAB: Ledger -->
          <div class="tab-content active" id="tab-ledger">
            <form id="ledgerForm" class="form-grid" style="margin-bottom:16px">
              <div>
                <label for="ledgerEntryType">Tipas</label>
                <select id="ledgerEntryType">
                  <option value="EXPENSE">Išlaidos</option>
                  <option value="TAX">Mokesčiai</option>
                  <option value="ADJUSTMENT">Koregavimas</option>
                </select>
              </div>
              <div>
                <label for="ledgerCategory">Kategorija</label>
                <select id="ledgerCategory">
                  <option value="FUEL">Kuras</option>
                  <option value="REPAIR">Remontas</option>
                  <option value="MATERIALS">Medžiagos</option>
                  <option value="SUBCONTRACTOR">Subrangovas</option>
                  <option value="TAXES">Mokesčiai</option>
                  <option value="INSURANCE">Draudimas</option>
                  <option value="TOOLS">Įrankiai</option>
                  <option value="OTHER">Kita</option>
                </select>
              </div>
              <div>
                <label for="ledgerAmount">Suma</label>
                <input id="ledgerAmount" type="number" step="0.01" min="0.01" required />
              </div>
              <div>
                <label for="ledgerDesc">Aprašymas</label>
                <input id="ledgerDesc" type="text" placeholder="pvz., Degalai VW" />
              </div>
              <div>
                <label for="ledgerProject">Projekto ID (nebūtina)</label>
                <input id="ledgerProject" type="text" placeholder="UUID arba tuščia" />
              </div>
              <div>
                <button class="btn btn-primary" type="submit">Pridėti</button>
              </div>
            </form>
            <div class="status" id="ledgerFormStatus"></div>

            <table class="data-table">
              <thead>
                <tr>
                  <th>Tipas</th>
                  <th>Kategorija</th>
                  <th>Suma</th>
                  <th>Aprašymas</th>
                  <th>Projektas</th>
                  <th>Data</th>
                  <th>Veiksmai</th>
                </tr>
              </thead>
              <tbody id="ledgerRows"></tbody>
            </table>
            <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
              <button class="btn btn-ghost btn-sm" id="ledgerLoadMore" style="display:none">Įkelti daugiau</button>
              <span style="color: var(--ink-muted);" id="ledgerCount"></span>
            </div>
          </div>

          <!-- TAB: Documents -->
          <div class="tab-content" id="tab-documents">
            <form id="docUploadForm" style="margin-bottom:16px;display:flex;gap:12px;align-items:end;flex-wrap:wrap">
              <div>
                <label for="docFile">Dokumentas</label>
                <input id="docFile" type="file" accept=".pdf,.jpg,.jpeg,.png,.webp" required />
              </div>
              <div>
                <label for="docNotes">Pastabos</label>
                <input id="docNotes" type="text" placeholder="nebūtina" />
              </div>
              <div>
                <button class="btn btn-primary" type="submit">Įkelti</button>
              </div>
            </form>
            <div class="status" id="docFormStatus"></div>

            <table class="data-table">
              <thead>
                <tr>
                  <th>Failas</th>
                  <th>Būsena</th>
                  <th>Pastabos</th>
                  <th>Data</th>
                  <th>Veiksmai</th>
                </tr>
              </thead>
              <tbody id="docRows"></tbody>
            </table>
            <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
              <button class="btn btn-ghost btn-sm" id="docLoadMore" style="display:none">Įkelti daugiau</button>
            </div>
          </div>

          <!-- TAB: Vendor Rules -->
          <div class="tab-content" id="tab-vendors">
            <form id="vendorForm" class="form-grid" style="margin-bottom:16px">
              <div>
                <label for="vendorPattern">Tiekėjo šablonas</label>
                <input id="vendorPattern" type="text" placeholder="pvz., shell, maxima" required />
              </div>
              <div>
                <label for="vendorCategory">Kategorija</label>
                <select id="vendorCategory">
                  <option value="FUEL">Kuras</option>
                  <option value="REPAIR">Remontas</option>
                  <option value="MATERIALS">Medžiagos</option>
                  <option value="SUBCONTRACTOR">Subrangovas</option>
                  <option value="TAXES">Mokesčiai</option>
                  <option value="INSURANCE">Draudimas</option>
                  <option value="TOOLS">Įrankiai</option>
                  <option value="OTHER">Kita</option>
                </select>
              </div>
              <div>
                <button class="btn btn-primary" type="submit">Sukurti taisyklę</button>
              </div>
            </form>
            <div class="status" id="vendorFormStatus"></div>

            <table class="data-table">
              <thead>
                <tr>
                  <th>Šablonas</th>
                  <th>Kategorija</th>
                  <th>Tipas</th>
                  <th>Sukurta</th>
                  <th>Veiksmai</th>
                </tr>
              </thead>
              <tbody id="vendorRows"></tbody>
            </table>
          </div>
          </div>

          <!-- TAB: Metrics (V2.3 SSE) -->
          <div class="tab-content" id="tab-metrics">
            <h2 style="margin-bottom:16px">Realaus laiko finansų metrika</h2>
            <div class="summary-grid" style="margin-bottom:20px">
              <div class="summary-card">
                <div class="label">Šiandienos apyvarta</div>
                <div class="value value-green" id="metricDailyVolume">—</div>
              </div>
              <div class="summary-card">
                <div class="label">Manual / Stripe</div>
                <div class="value" id="metricManualRatio">—</div>
              </div>
              <div class="summary-card">
                <div class="label">Vidut. bandymai</div>
                <div class="value" id="metricAvgAttempts">—</div>
              </div>
              <div class="summary-card">
                <div class="label">Atmetimo dažnis</div>
                <div class="value value-red" id="metricRejectRate">—</div>
              </div>
              <div class="summary-card">
                <div class="label">Vidut. patvirt. laikas</div>
                <div class="value value-blue" id="metricAvgConfirmTime">—</div>
              </div>
              <div class="summary-card">
                <div class="label">Iš viso patvirtinimų</div>
                <div class="value" id="metricTotalConfirmations">—</div>
              </div>
            </div>
            <div style="font-size:12px;color:var(--ink-muted)">
              <span id="metricsStatus">Jungiamasi...</span> •
              <span>Atnaujinama kas 5s</span> •
              <span id="metricsTimestamp">—</span>
            </div>
          </div>
        </div>
      </div>

        </div>
      </main>
    </div>

    <script src="/static/admin-shared.js?v=3.1"></script>
    <script>
      document.getElementById("sidebarNav").innerHTML = sidebarHTML("/admin/finance");

      const tokenInput = document.getElementById("token");
      const tokenStatus = document.getElementById("tokenStatus");
      const tokenBadge = document.getElementById("tokenBadge");

      const updateTokenBadge = () => {
        if (!tokenBadge) return;
        if (Auth.isSet()) {
          tokenBadge.textContent = "Aktyvus";
          tokenBadge.className = "pill pill-success";
        } else {
          tokenBadge.textContent = "Nenustatytas";
          tokenBadge.className = "pill pill-gray";
        }
      };

      const esc = (v) => escapeHtml(v);

      const fmtDate = (v) => {
        if (!v) return "-";
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return v;
        return d.toLocaleDateString("lt-LT") + " " + d.toLocaleTimeString("lt-LT", { hour: "2-digit", minute: "2-digit" });
      };

      const fmtMoney = (v) => {
        const n = Number(v);
        if (Number.isNaN(n)) return "-";
        return n.toLocaleString("lt-LT", { style: "currency", currency: "EUR" });
      };

      const typeBadge = (t) => {
        const map = {
          EXPENSE: { cls: "pill-error", label: "Išlaidos" },
          TAX: { cls: "pill-warning", label: "Mokesčiai" },
          ADJUSTMENT: { cls: "pill-info", label: "Koregavimas" },
        };
        const v = map[t] || { cls: "pill-gray", label: t || "-" };
        return `<span class="pill ${v.cls}">${esc(v.label)}</span>`;
      };

      const statusBadge = (s) => {
        const map = {
          NEW: { cls: "pill-gray", label: "NEW" },
          EXTRACTED: { cls: "pill-info", label: "EXTRACTED" },
          READY: { cls: "pill-info", label: "READY" },
          POSTED: { cls: "pill-success", label: "POSTED" },
          REJECTED: { cls: "pill-error", label: "REJECTED" },
        };
        const v = map[s] || { cls: "pill-gray", label: s || "-" };
        return `<span class="pill ${v.cls}">${esc(v.label)}</span>`;
      };

      // ---- Token ----
      const loadToken = () => {
        const stored = Auth.get();
        tokenInput.value = stored;
        tokenStatus.textContent = stored ? "Žetonas įkeltas." : "Žetonas nenustatytas.";
        updateTokenBadge();
      };

      document.getElementById("saveToken").addEventListener("click", () => {
        const t = Auth.normalize(tokenInput.value);
        if (t) {
          Auth.set(t);
          tokenInput.value = t;
          tokenStatus.textContent = "Žetonas išsaugotas.";
          showToast("Žetonas išsaugotas", "success");
        } else {
          Auth.remove();
          tokenStatus.textContent = "Žetonas ištrintas.";
        }
        updateTokenBadge();
      });

      document.getElementById("generateToken").addEventListener("click", async () => {
        tokenStatus.textContent = "Generuojamas...";
        try {
          const token = await Auth.generate();
          if (token) {
            tokenInput.value = token;
            tokenStatus.textContent = "Žetonas sugeneruotas.";
            showToast("Žetonas sugeneruotas", "success");
          } else {
            tokenStatus.textContent = "Nepavyko.";
          }
        } catch (err) {
          tokenStatus.textContent = err.message || "Tinklo klaida.";
        }
        updateTokenBadge();
      });

      // ---- Tabs ----
      let metricsEventSource = null;
      
      document.querySelectorAll(".tab-item").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab-item").forEach((b) => b.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
          
          // Start/stop SSE metrics
          if (btn.dataset.tab === "metrics") {
            startMetricsSSE();
          } else {
            stopMetricsSSE();
          }
        });
      });
      
      const startMetricsSSE = () => {
        if (metricsEventSource) return; // already connected
        
        const token = Auth.normalize(tokenInput.value) || Auth.get();
        if (!token) {
          document.getElementById("metricsStatus").textContent = "Žetonas reikalingas";
          return;
        }
        
        const url = `/api/v1/admin/finance/metrics?token=${encodeURIComponent(token)}`;
        metricsEventSource = new EventSource(url);
        
        metricsEventSource.onopen = () => {
          document.getElementById("metricsStatus").textContent = "Prijungta";
        };
        
        metricsEventSource.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            document.getElementById("metricDailyVolume").textContent = fmtMoney(data.daily_volume);
            document.getElementById("metricManualRatio").textContent = 
              `${data.manual_count || 0} / ${data.stripe_count || 0} (${(data.manual_ratio * 100).toFixed(1)}%)`;
            document.getElementById("metricAvgAttempts").textContent = data.avg_attempts?.toFixed(2) || "0";
            document.getElementById("metricRejectRate").textContent = `${(data.reject_rate * 100).toFixed(1)}%`;
            document.getElementById("metricAvgConfirmTime").textContent = `${data.avg_confirm_time_minutes || 0} min`;
            document.getElementById("metricTotalConfirmations").textContent = data.total_confirmations || "0";
            document.getElementById("metricsTimestamp").textContent = 
              data.timestamp ? new Date(data.timestamp).toLocaleTimeString("lt-LT") : "—";
          } catch (err) {
            console.error("Metrics parse error:", err);
          }
        };
        
        metricsEventSource.onerror = () => {
          document.getElementById("metricsStatus").textContent = "Klaida / atjungta";
          stopMetricsSSE();
        };
      };
      
      const stopMetricsSSE = () => {
        if (metricsEventSource) {
          metricsEventSource.close();
          metricsEventSource = null;
          document.getElementById("metricsStatus").textContent = "Atjungta";
        }
      };

      // ---- Summary ----
      const fetchSummary = async () => {
        try {
          const resp = await authFetch("/api/v1/admin/finance/summary");
          if (!resp.ok) return;
          const d = await resp.json();
          document.getElementById("sumIncome").textContent = fmtMoney(d.total_income);
          document.getElementById("sumExpenses").textContent = fmtMoney(d.total_expenses);
          document.getElementById("sumNet").textContent = fmtMoney(d.net_expenses);
          document.getElementById("sumProfit").textContent = fmtMoney(d.profit);
          document.getElementById("sumProjects").textContent = d.project_count;
        } catch {}
      };

      // ---- Ledger ----
      let ledgerCursor = null;
      const ledgerRows = document.getElementById("ledgerRows");
      const ledgerStatus = document.getElementById("ledgerFormStatus");
      const ledgerCount = document.getElementById("ledgerCount");
      const ledgerLoadMore = document.getElementById("ledgerLoadMore");

      const fetchLedger = async (append) => {
        let url = "/api/v1/admin/finance/ledger?limit=50";
        if (append && ledgerCursor) url += "&cursor=" + encodeURIComponent(ledgerCursor);
        try {
          const resp = await authFetch(url);
          if (!resp.ok) { ledgerStatus.textContent = `Klaida (${resp.status})`; return; }
          const d = await resp.json();
          if (!append) ledgerRows.innerHTML = "";
          if (!d.items.length && !append) {
            ledgerRows.innerHTML = '<tr><td colspan="7" class="empty-row">Įrašų nėra.</td></tr>';
          }
          for (const e of d.items) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td data-label="Tipas">${typeBadge(e.entry_type)}</td>
              <td data-label="Kategorija">${esc(e.category)}</td>
              <td data-label="Suma">${fmtMoney(e.amount)}</td>
              <td data-label="Aprašymas">${esc(e.description || "-")}</td>
              <td data-label="Projektas" style="color: var(--ink-muted);">${esc(e.project_id ? e.project_id.substring(0, 8) + "..." : "Bendros")}</td>
              <td data-label="Data" style="color: var(--ink-muted);">${fmtDate(e.created_at)}</td>
              <td data-label="Veiksmai">${e.reverses_entry_id ? '<span style="color: var(--ink-muted);">Korekc.</span>' : `<button class="btn btn-ghost btn-sm" onclick="reverseLedger('${esc(e.id)}')">Koreguoti</button>`}</td>
            `;
            ledgerRows.appendChild(tr);
          }
          ledgerCursor = d.next_cursor;
          ledgerLoadMore.style.display = d.has_more ? "" : "none";
        } catch { ledgerStatus.textContent = "Tinklo klaida."; }
      };

      ledgerLoadMore.addEventListener("click", () => fetchLedger(true));

      window.reverseLedger = async (id) => {
        const reason = prompt("Koregavimo priežastis:");
        if (!reason) return;
        try {
          await authFetch(`/api/v1/admin/finance/ledger/${id}/reverse`, {
            method: "POST",
            body: JSON.stringify({ reason }),
          });
          await fetchLedger(false);
          await fetchSummary();
        } catch { alert("Tinklo klaida."); }
      };

      document.getElementById("ledgerForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        ledgerStatus.textContent = "";
        const body = {
          entry_type: document.getElementById("ledgerEntryType").value,
          category: document.getElementById("ledgerCategory").value,
          amount: Number(document.getElementById("ledgerAmount").value),
          description: document.getElementById("ledgerDesc").value || "",
        };
        const pid = document.getElementById("ledgerProject").value.trim();
        if (pid) body.project_id = pid;

        try {
          await authFetch("/api/v1/admin/finance/ledger", {
            method: "POST",
            body: JSON.stringify(body),
          });
          ledgerStatus.textContent = "Įrašas pridėtas.";
          document.getElementById("ledgerAmount").value = "";
          document.getElementById("ledgerDesc").value = "";
          await fetchLedger(false);
          await fetchSummary();
        } catch { ledgerStatus.textContent = "Tinklo klaida."; }
      });

      // ---- Documents ----
      const docRows = document.getElementById("docRows");
      const docStatus = document.getElementById("docFormStatus");
      const docLoadMore = document.getElementById("docLoadMore");
      let docCursor = null;

      const fetchDocs = async (append) => {
        let url = "/api/v1/admin/finance/documents?limit=50";
        if (append && docCursor) url += "&cursor=" + encodeURIComponent(docCursor);
        try {
          const resp = await authFetch(url);
          if (!resp.ok) return;
          const d = await resp.json();
          if (!append) docRows.innerHTML = "";
          if (!d.items.length && !append) {
            docRows.innerHTML = '<tr><td colspan="5" class="empty-row">Dokumentų nėra.</td></tr>';
          }
          for (const doc of d.items) {
            const tr = document.createElement("tr");
            const canExtract = doc.status === "NEW";
            const canPost = doc.status === "EXTRACTED" || doc.status === "READY";
            tr.innerHTML = `
              <td data-label="Failas">${esc(doc.original_filename || "nežinomas")}</td>
              <td data-label="Būsena">${statusBadge(doc.status)}</td>
              <td data-label="Pastabos" style="color: var(--ink-muted);">${esc(doc.notes || "-")}</td>
              <td data-label="Data" style="color: var(--ink-muted);">${fmtDate(doc.created_at)}</td>
              <td data-label="Veiksmai">
                ${canExtract ? `<button class="btn btn-ghost btn-sm" onclick="extractDoc('${esc(doc.id)}')">Nuskaityti</button>` : ""}
                ${canPost ? `<button class="btn btn-ghost btn-sm" onclick="postDoc('${esc(doc.id)}')">Registruoti</button>` : ""}
              </td>
            `;
            docRows.appendChild(tr);
          }
          docCursor = d.next_cursor;
          docLoadMore.style.display = d.has_more ? "" : "none";
        } catch {}
      };

      docLoadMore.addEventListener("click", () => fetchDocs(true));

      window.extractDoc = async (id) => {
        try {
          await authFetch(`/api/v1/admin/finance/documents/${id}/extract`, { method: "POST" });
          await fetchDocs(false);
        } catch (err) { alert(err.message || "Nuskaitymas nepavyko."); }
      };

      window.postDoc = async (id) => {
        const amount = prompt("Suma (EUR):");
        if (!amount || Number(amount) <= 0) return;
        try {
          await authFetch(`/api/v1/admin/finance/documents/${id}/post`, {
            method: "POST",
            body: JSON.stringify({ amount: Number(amount) }),
          });
          await fetchDocs(false);
          await fetchLedger(false);
          await fetchSummary();
        } catch (err) { alert(err.message || "Tinklo klaida."); }
      };

      document.getElementById("docUploadForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        docStatus.textContent = "";
        const fileInput = document.getElementById("docFile");
        if (!fileInput.files.length) return;

        const fd = new FormData();
        fd.append("file", fileInput.files[0]);
        const notes = document.getElementById("docNotes").value.trim();
        if (notes) fd.append("notes", notes);

        try {
          await authFetch("/api/v1/admin/finance/documents", {
            method: "POST",
            body: fd,
          });
          docStatus.textContent = "Dokumentas įkeltas.";
          fileInput.value = "";
          document.getElementById("docNotes").value = "";
          await fetchDocs(false);
        } catch (err) {
          docStatus.innerHTML = err.status === 409
            ? `<span style="color:var(--error)">Dublikatas: ${esc(err.message || "")}</span>`
            : `<span style="color:var(--error)">${esc(err.message || "Tinklo klaida.")}</span>`;
        }
      });

      // ---- Vendor Rules ----
      const vendorRows = document.getElementById("vendorRows");
      const vendorStatus = document.getElementById("vendorFormStatus");

      const fetchVendors = async () => {
        try {
          const resp = await authFetch("/api/v1/admin/finance/vendor-rules");
          if (!resp.ok) return;
          const d = await resp.json();
          vendorRows.innerHTML = "";
          if (!d.items.length) {
            vendorRows.innerHTML = '<tr><td colspan="5" class="empty-row">Taisyklių nėra.</td></tr>';
            return;
          }
          for (const r of d.items) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td data-label="Šablonas">${esc(r.vendor_pattern)}</td>
              <td data-label="Kategorija">${esc(r.default_category)}</td>
              <td data-label="Tipas">${esc(r.default_entry_type)}</td>
              <td data-label="Sukurta" style="color: var(--ink-muted);">${fmtDate(r.created_at)}</td>
              <td data-label="Veiksmai"><button class="btn btn-danger btn-sm" onclick="deleteVendor('${esc(r.id)}')">Šalinti</button></td>
            `;
            vendorRows.appendChild(tr);
          }
        } catch {}
      };

      window.deleteVendor = async (id) => {
        if (!confirm("Pašalinti tiekėjo taisyklę?")) return;
        try {
          await authFetch(`/api/v1/admin/finance/vendor-rules/${id}`, { method: "DELETE" });
          await fetchVendors();
        } catch { alert("Tinklo klaida."); }
      };

      document.getElementById("vendorForm").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        vendorStatus.textContent = "";
        const body = {
          vendor_pattern: document.getElementById("vendorPattern").value.trim(),
          default_category: document.getElementById("vendorCategory").value,
        };
        try {
          await authFetch("/api/v1/admin/finance/vendor-rules", {
            method: "POST",
            body: JSON.stringify(body),
          });
          vendorStatus.textContent = "Taisyklė sukurta.";
          document.getElementById("vendorPattern").value = "";
          await fetchVendors();
        } catch (err) {
          vendorStatus.innerHTML = `<span style="color:var(--error)">${esc(err.message || "Tinklo klaida.")}</span>`;
        }
      });

      // ---- Init ----
      loadToken();
      fetchSummary();
      fetchLedger(false);
      fetchDocs(false);
      fetchVendors();
    </script>
  </body>
</html>
