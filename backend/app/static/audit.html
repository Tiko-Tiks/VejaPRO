<!DOCTYPE html>
<html lang="lt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VejaPRO – Auditas</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" />
    <link rel="stylesheet" href="/static/admin-shared.css?v=3.1" />
    <style>
      .filters { padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
      .export-row, .views-row { display: flex; gap: 10px; align-items: center; padding: 0 20px 20px; flex-wrap: wrap; }
      .views-row { align-items: flex-end; }
      .meta-preview { color: var(--ink-muted); font-size: 12px; max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      pre { background: #fafaf9; padding: 12px; border-radius: var(--radius); max-height: 320px; overflow: auto; font-size: 12px; }
      .copy-row { display: flex; justify-content: flex-end; margin-bottom: 8px; }
    </style>
  </head>
  <body>
    <button class="hamburger" aria-label="Meniu">&#9776;</button>
    <div class="sidebar-overlay"></div>
    <div class="admin-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/"><img src="/static/logo.png" alt="VejaPRO" class="logo" /></a>
          <span class="brand">VejaPRO</span>
        </div>
        <nav class="sidebar-nav" id="sidebarNav"></nav>
        <div class="sidebar-footer">V3.1 Admin - Modern Design</div>
      </aside>
      <main class="main-content">
        <div class="page-header">
          <h1>Audito žurnalas</h1>
        </div>
        <div class="content-area">
          <div class="token-card">
            <div class="token-card-header">
              <span>&#128274; Bearer žetonas</span>
              <span id="tokenBadge" class="pill pill-gray">Nenustatytas</span>
            </div>
            <div class="token-card-body">
              <div class="form-grid" style="grid-template-columns: 1fr auto auto;">
                <div class="form-group">
                  <label for="token">Prieigos žetonas</label>
                  <input id="token" type="password" class="form-input" placeholder="Įklijuokite JWT žetoną" />
                </div>
                <button class="btn" id="generateToken" type="button">Generuoti</button>
                <button class="btn btn-secondary" id="saveToken" type="button">Išsaugoti</button>
              </div>
              <div class="hint" id="tokenStatus" style="margin-top: 6px; font-size: 12px; color: var(--ink-muted);">Žetonas nenustatytas.</div>
            </div>
          </div>

      <div class="card">
        <div class="filters" style="border-bottom:1px solid var(--border);">
          <div>
            <label>Objekto tipas</label>
            <select id="entity_type">
              <option value="">Bet koks</option>
              <option value="project">project</option>
              <option value="payment">payment</option>
              <option value="sms_confirmation">sms_confirmation</option>
              <option value="system">system</option>
            </select>
          </div>
          <div>
            <label>Objekto ID</label>
            <input id="entity_id" placeholder="UUID" />
          </div>
          <div>
            <label>Veiksmas</label>
            <input id="action" placeholder="STATUS_CHANGE" />
          </div>
          <div>
            <label>Vykdytojo tipas</label>
            <select id="actor_type">
              <option value="">Bet koks</option>
              <option value="CLIENT">CLIENT</option>
              <option value="SUBCONTRACTOR">SUBCONTRACTOR</option>
              <option value="EXPERT">EXPERT</option>
              <option value="ADMIN">ADMIN</option>
              <option value="SYSTEM">SYSTEM</option>
              <option value="SYSTEM_STRIPE">SYSTEM_STRIPE</option>
              <option value="SYSTEM_TWILIO">SYSTEM_TWILIO</option>
              <option value="SYSTEM_EMAIL">SYSTEM_EMAIL</option>
            </select>
          </div>
          <div>
            <label>Vykdytojo ID</label>
            <input id="actor_id" placeholder="UUID" />
          </div>
          <div>
            <label>Nuo</label>
            <input id="from_ts" type="datetime-local" />
          </div>
          <div>
            <label>Iki</label>
            <input id="to_ts" type="datetime-local" />
          </div>
          <div>
            <label>Limitas</label>
            <select id="limit">
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>
          <div class="form-group" style="display:flex;gap:10px;align-items:flex-end;">
            <button class="btn btn-primary" id="apply">Taikyti</button>
            <button class="btn btn-ghost" id="clear">Valyti</button>
          </div>
        </div>

        <div class="hint" id="status" style="padding:12px 20px;border-bottom:1px solid var(--border);">Paruošta</div>

        <div class="export-row">
          <div style="min-width: 0; width: 100%;">
            <label>Eksporto limitas</label>
            <select id="export_limit">
              <option value="10000">10 000</option>
              <option value="50000">50 000</option>
              <option value="100000">100 000</option>
            </select>
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-primary" id="downloadCsv">Atsisiųsti CSV</button>
            <button class="btn btn-ghost" id="downloadNextCsv" disabled>Atsisiųsti kitą dalį</button>
          </div>
        </div>

        <div class="views-row">
          <div style="min-width: 0; width: 100%;">
            <label>Išsaugoti rodiniai</label>
            <select id="savedViews">
              <option value="">Pasirinkite rodinį</option>
            </select>
          </div>
          <div style="flex: 1;">
            <label>Rodinio pavadinimas</label>
            <input id="viewName" placeholder="pvz., Patvirtinimai per 24 val." />
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-primary" id="saveView">Išsaugoti rodinį</button>
            <button class="btn btn-ghost" id="deleteView" disabled>Ištrinti rodinį</button>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Laiko žyma</th>
                <th>Veiksmas</th>
                <th>Objektas</th>
                <th>Objekto ID</th>
                <th>Vykdytojas</th>
                <th>Vykdytojo ID</th>
                <th>IP</th>
                <th>Metaduomenys</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div class="section" style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;">
          <span id="count">0 įrašų</span>
          <button class="btn btn-primary" id="loadMore">Įkelti daugiau</button>
        </div>
      </div>
        </div>
      </main>
    </div>

    <div class="modal-backdrop" id="modal">
      <div class="modal" style="max-width:900px;">
        <div class="modal-header">
          <strong>Audito įrašo JSON</strong>
          <button class="btn btn-ghost" id="closeModal">Uždaryti</button>
        </div>
        <div class="modal-body">
          <div class="copy-row">
            <button class="btn btn-ghost" id="copyJson">Kopijuoti JSON</button>
          </div>
          <pre id="jsonView">{}</pre>
        </div>
      </div>
    </div>

    <script src="/static/admin-shared.js?v=3.1"></script>
    <script>
      document.getElementById("sidebarNav").innerHTML = sidebarHTML("/admin/audit");

      const rowsEl = document.getElementById("rows");
      const statusEl = document.getElementById("status");
      const countEl = document.getElementById("count");
      const loadMoreBtn = document.getElementById("loadMore");
      const modalEl = document.getElementById("modal");
      const jsonView = document.getElementById("jsonView");
      const tokenInput = document.getElementById("token");
      const tokenStatus = document.getElementById("tokenStatus");
      const tokenBadge = document.getElementById("tokenBadge");
      const generateTokenBtn = document.getElementById("generateToken");
      const saveTokenBtn = document.getElementById("saveToken");
      const downloadBtn = document.getElementById("downloadCsv");
      const downloadNextBtn = document.getElementById("downloadNextCsv");
      const exportLimitSelect = document.getElementById("export_limit");
      const savedViewsSelect = document.getElementById("savedViews");
      const viewNameInput = document.getElementById("viewName");
      const saveViewBtn = document.getElementById("saveView");
      const deleteViewBtn = document.getElementById("deleteView");

      let nextCursor = null;
      let items = [];
      let itemIds = new Set();
      let exportCursor = null;
      let exportPart = 1;

      const SAVED_VIEWS_KEY = "audit_saved_views_v1";
      const MAX_VIEWS = 20;

      const setStatus = (message, isError = false) => {
        statusEl.textContent = message;
        statusEl.style.color = isError ? "var(--error)" : "var(--ink-muted)";
      };

      const updateTokenBadge = () => {
        if (!tokenBadge) return;
        if (Auth.isSet()) {
          tokenBadge.textContent = "Aktyvus";
          tokenBadge.className = "pill pill-success";
        } else {
          tokenBadge.textContent = "Nenustatytas";
          tokenBadge.className = "pill pill-gray";
        }
      };

      const setTokenStatus = (message, isError = false) => {
        if (!tokenStatus) return;
        tokenStatus.textContent = message;
        tokenStatus.style.color = isError ? "var(--error)" : "var(--ink-muted)";
      };

      const loadToken = () => {
        const stored = Auth.get();
        if (stored && !tokenInput.value) {
          tokenInput.value = stored;
        }
        setTokenStatus(Auth.isSet() ? "Žetonas įkeltas iš naršyklės saugyklos." : "Žetonas nenustatytas.");
        updateTokenBadge();
      };

      const getFilters = () => {
        const fromRaw = document.getElementById("from_ts").value;
        const toRaw = document.getElementById("to_ts").value;
        return {
          entity_type: document.getElementById("entity_type").value || null,
          entity_id: document.getElementById("entity_id").value || null,
          action: document.getElementById("action").value || null,
          actor_type: document.getElementById("actor_type").value || null,
          actor_id: document.getElementById("actor_id").value || null,
          from_ts: fromRaw ? new Date(fromRaw).toISOString() : null,
          to_ts: toRaw ? new Date(toRaw).toISOString() : null,
          limit: document.getElementById("limit").value || "50",
        };
      };

      const applyFilters = (filters) => {
        document.getElementById("entity_type").value = filters.entity_type || "";
        document.getElementById("entity_id").value = filters.entity_id || "";
        document.getElementById("action").value = filters.action || "";
        document.getElementById("actor_type").value = filters.actor_type || "";
        document.getElementById("actor_id").value = filters.actor_id || "";
        document.getElementById("from_ts").value = filters.from_ts
          ? new Date(filters.from_ts).toISOString().slice(0, 16)
          : "";
        document.getElementById("to_ts").value = filters.to_ts
          ? new Date(filters.to_ts).toISOString().slice(0, 16)
          : "";
        document.getElementById("limit").value = filters.limit || "50";
      };

      const loadSavedViews = () => {
        const raw = localStorage.getItem(SAVED_VIEWS_KEY);
        try {
          return raw ? JSON.parse(raw) : [];
        } catch (err) {
          return [];
        }
      };

      const persistSavedViews = (views) => {
        localStorage.setItem(SAVED_VIEWS_KEY, JSON.stringify(views));
      };

      const refreshSavedViewsSelect = (selectedName = "") => {
        const views = loadSavedViews();
        savedViewsSelect.innerHTML = `<option value="">Pasirinkite rodinį</option>`;
        views.forEach((view) => {
          const option = document.createElement("option");
          option.value = view.name;
          option.textContent = view.name;
          savedViewsSelect.appendChild(option);
        });
        savedViewsSelect.value = selectedName || "";
        deleteViewBtn.disabled = !savedViewsSelect.value;
      };

      const buildQuery = (filters, cursor) => {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
          if (value) params.append(key, value);
        });
        if (cursor) params.append("cursor", cursor);
        return params.toString();
      };

      const renderRows = () => {
        rowsEl.innerHTML = "";
        items.forEach((item) => {
          const tr = document.createElement("tr");
          const metadataText = JSON.stringify(item.metadata || {});
          tr.innerHTML = `
            <td data-label="Laiko žyma">${escapeHtml(item.timestamp || "-")}</td>
            <td data-label="Veiksmas">${escapeHtml(item.action)}</td>
            <td data-label="Objektas">${escapeHtml(item.entity_type)}</td>
            <td data-label="Objekto ID">${escapeHtml(item.entity_id)}</td>
            <td data-label="Vykdytojas">${escapeHtml(item.actor_type)}</td>
            <td data-label="Vykdytojo ID">${escapeHtml(item.actor_id || "-")}</td>
            <td data-label="IP">${escapeHtml(item.ip_address || "-")}</td>
            <td data-label="Metaduomenys" class="meta-preview">${escapeHtml(metadataText)}</td>
          `;
          tr.addEventListener("click", () => openModal(item));
          rowsEl.appendChild(tr);
        });
        countEl.textContent = `${items.length} įrašų`;
        loadMoreBtn.disabled = !nextCursor;
      };

      const resetExportState = () => {
        exportCursor = null;
        exportPart = 1;
        downloadNextBtn.disabled = true;
      };

      const openModal = (item) => {
        const full = {
          id: item.id,
          timestamp: item.timestamp,
          entity_type: item.entity_type,
          entity_id: item.entity_id,
          action: item.action,
          actor_type: item.actor_type,
          actor_id: item.actor_id,
          ip_address: item.ip_address,
          user_agent: item.user_agent,
          old_value: item.old_value,
          new_value: item.new_value,
          metadata: item.metadata,
        };
        jsonView.textContent = JSON.stringify(full, null, 2);
        modalEl.classList.add("active");
      };

      const closeModal = () => {
        modalEl.classList.remove("active");
      };

      const fetchLogs = async ({ reset } = { reset: false }) => {
        if (reset) {
          items = [];
          nextCursor = null;
          itemIds = new Set();
          resetExportState();
          renderRows();
        }

        const filters = getFilters();
        const query = buildQuery(filters, nextCursor);

        setStatus("Kraunama...");
        try {
          const resp = await authFetch(`/api/v1/audit-logs?${query}`);

          if (resp.status === 403) {
            setStatus("Prieiga uždrausta.", true);
            return;
          }
          if (resp.status === 400) {
            setStatus("Neteisingi filtrai arba žymeklis.", true);
            return;
          }
          if (!resp.ok) {
            setStatus("Netikėta klaida.", true);
            return;
          }

          const data = await resp.json();
          const newItems = (data.items || []).filter((item) => {
            if (itemIds.has(item.id)) return false;
            itemIds.add(item.id);
            return true;
          });
          items = items.concat(newItems);
          nextCursor = data.next_cursor;
          renderRows();
          setStatus(data.has_more ? "Įkelta. Yra daugiau." : "Įkelta.");
        } catch (err) {
          setStatus("Tinklo klaida.", true);
        }
      };

      document.getElementById("apply").addEventListener("click", () => fetchLogs({ reset: true }));
      document.getElementById("clear").addEventListener("click", () => {
        ["entity_type", "entity_id", "action", "actor_type", "actor_id", "from_ts", "to_ts"].forEach((id) => {
          document.getElementById(id).value = "";
        });
        document.getElementById("limit").value = "50";
        resetExportState();
        fetchLogs({ reset: true });
      });

      loadMoreBtn.addEventListener("click", () => {
        if (!nextCursor) {
          setStatus("Daugiau rezultatų nėra.");
          return;
        }
        fetchLogs({ reset: false });
      });

      document.getElementById("closeModal").addEventListener("click", closeModal);
      modalEl.addEventListener("click", (event) => {
        if (event.target === modalEl) closeModal();
      });

      document.getElementById("copyJson").addEventListener("click", () => {
        copyToClipboard(jsonView.textContent || "{}");
      });

      saveTokenBtn.addEventListener("click", () => {
        const token = Auth.normalize(tokenInput.value);
        if (token) {
          Auth.set(token);
          tokenInput.value = token;
          setTokenStatus("Žetonas išsaugotas.");
          showToast("Žetonas išsaugotas", "success");
        } else {
          Auth.remove();
          setTokenStatus("Žetonas ištrintas.");
        }
        updateTokenBadge();
      });

      generateTokenBtn.addEventListener("click", async () => {
        setTokenStatus("Generuojamas žetonas...");
        try {
          const token = await Auth.generate();
          if (!token) {
            setTokenStatus("Žetono generavimas nepavyko.", true);
            return;
          }
          tokenInput.value = token;
          setTokenStatus("Žetonas sugeneruotas.");
          showToast("Žetonas sugeneruotas", "success");
        } catch (err) {
          setTokenStatus(err.message || "Tinklo klaida.", true);
        }
        updateTokenBadge();
      });

      const downloadCsv = async ({ cursorOverride } = {}) => {
        const filters = getFilters();
        filters.limit = exportLimitSelect.value || "10000";
        const cursorValue = cursorOverride || exportCursor;
        const query = buildQuery(filters, cursorValue);

        setStatus("Ruošiamas CSV...");
        try {
          const resp = await authFetch(`/api/v1/audit-logs/export?${query}`);

          const hasMore = (resp.headers.get("X-Has-More") || "").toLowerCase() === "true";
          const next = resp.headers.get("X-Next-Cursor");
          exportCursor = hasMore ? next : null;
          downloadNextBtn.disabled = !hasMore;

          const blob = await resp.blob();
          const now = new Date();
          const stamp = `${now.getUTCFullYear()}${String(now.getUTCMonth() + 1).padStart(2, "0")}${String(
            now.getUTCDate()
          ).padStart(2, "0")}_${String(now.getUTCHours()).padStart(2, "0")}${String(now.getUTCMinutes()).padStart(2, "0")}`;
          const filename = `audit_export_${stamp}_part${exportPart}.csv`;
          exportPart += 1;

          const url = window.URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          link.remove();
          window.URL.revokeObjectURL(url);

          setStatus(hasMore ? "CSV atsisiųstas. Yra daugiau." : "CSV atsisiųstas.");
        } catch (err) {
          setStatus("Netikėta klaida.", true);
        }
      };

      downloadBtn.addEventListener("click", () => {
        exportPart = 1;
        exportCursor = null;
        downloadCsv();
      });

      downloadNextBtn.addEventListener("click", () => {
        if (!exportCursor) {
          setStatus("Daugiau CSV dalių nėra.");
          return;
        }
        downloadCsv({ cursorOverride: exportCursor });
      });

      refreshSavedViewsSelect();
      loadToken();

      saveViewBtn.addEventListener("click", () => {
        const name = viewNameInput.value.trim();
        if (!name) {
          setStatus("Įveskite rodinio pavadinimą.", true);
          return;
        }
        const views = loadSavedViews();
        const existingIndex = views.findIndex((view) => view.name === name);
        const entry = {
          name,
          created_at: new Date().toISOString(),
          filters: getFilters(),
        };
        if (existingIndex >= 0) {
          views[existingIndex] = entry;
        } else {
          if (views.length >= MAX_VIEWS) {
            setStatus("Pasiektas rodinių limitas.", true);
            return;
          }
          views.push(entry);
        }
        persistSavedViews(views);
        refreshSavedViewsSelect(name);
        setStatus("Rodinys išsaugotas.");
      });

      savedViewsSelect.addEventListener("change", () => {
        const name = savedViewsSelect.value;
        deleteViewBtn.disabled = !name;
        if (!name) return;
        const views = loadSavedViews();
        const selected = views.find((view) => view.name === name);
        if (!selected) {
          setStatus("Rodinys nerastas.", true);
          return;
        }
        applyFilters(selected.filters || {});
        resetExportState();
        fetchLogs({ reset: true });
        setStatus("Rodinys įkeltas.");
      });

      deleteViewBtn.addEventListener("click", () => {
        const name = savedViewsSelect.value;
        if (!name) return;
        const views = loadSavedViews().filter((view) => view.name !== name);
        persistSavedViews(views);
        refreshSavedViewsSelect("");
        setStatus("Rodinys ištrintas.");
      });
    </script>
  </body>
</html>
