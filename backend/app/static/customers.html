<!DOCTYPE html>
<html lang="lt" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="description" content="VejaPRO – klientų sąrašas ir profiliai." />
    <title>VejaPRO – Klientai</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" />
    <link rel="stylesheet" href="/static/admin-shared.css?v=6.6" />
    <script>try{var t=localStorage.getItem("vejapro_theme")||"light";document.documentElement.dataset.theme=t;}catch(e){}</script>
  </head>
  <body data-layout="topbar">
      <main class="main-content">
        <div class="page-header">
          <h1>Klientai</h1>
          <div class="actions">
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;">
              <input type="checkbox" id="showAll" />
              Rodyti visus
            </label>
          </div>
        </div>

        <div class="content-area">
          <!-- Quick filter chips -->
          <div class="filter-chips" id="filterChips">
            <button class="filter-chip" data-attention="">Visos</button>
            <button class="filter-chip" data-attention="pending_confirmation">Laukia patvirtinimo</button>
            <button class="filter-chip" data-attention="failed_outbox">Nepavykę pranešimai</button>
          </div>

          <!-- Loading -->
          <div id="loading" class="loading-overlay">
            <div class="loading-spinner"></div>
            <span>Kraunama...</span>
          </div>

          <!-- Empty state -->
          <div id="emptyState" class="empty-state" style="display:none;">
            <div class="empty-icon">&#128100;</div>
            <h3>Nera klientu</h3>
            <p>Kai bus projektu, klientai atsiras automatiskai.</p>
          </div>

          <!-- Table -->
          <div class="table-container" id="tableContainer" style="display:none;">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="width:18%">Vardas</th>
                  <th style="width:22%">Kontaktas</th>
                  <th style="width:12%">Projektai</th>
                  <th style="width:10%">Statusas</th>
                  <th style="width:10%">Depozitas</th>
                  <th style="width:10%">Galutinis</th>
                  <th style="width:16%">Demesys</th>
                  <th style="width:14%">Aktyvumas</th>
                  <th style="width:8%">Veiksmai</th>
                </tr>
              </thead>
              <tbody id="customersBody"></tbody>
            </table>
          </div>
        </div>
      </main>

    <script src="/static/admin-shared.js?v=6.6"></script>
    <script>
      const showAllCheckbox = document.getElementById("showAll");
      let currentData = [];
      let currentAttention = "";

      function getAttentionFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("attention") || "";
      }

      function setActiveFilterChip(attention) {
        document.querySelectorAll(".filter-chip").forEach(chip => {
          chip.classList.toggle("active", (chip.dataset.attention || "") === attention);
        });
      }

      async function loadCustomers() {
        const loading = document.getElementById("loading");
        const empty = document.getElementById("emptyState");
        const table = document.getElementById("tableContainer");

        loading.style.display = "flex";
        empty.style.display = "none";
        table.style.display = "none";

        if (!Auth.isSet()) {
          loading.innerHTML = '<span style="color:var(--ink-muted);">Sugeneruokite zetona.</span>';
          return;
        }

        try {
          const attentionOnly = !showAllCheckbox.checked;
          currentAttention = getAttentionFromUrl();
          const params = new URLSearchParams({ attention_only: attentionOnly, limit: 100 });
          if (currentAttention) params.set("attention", currentAttention);
          const resp = await authFetch(`/api/v1/admin/customers?${params.toString()}`);
          const data = await resp.json();
          currentData = data.items || [];

          // UX safeguard: default inbox view may be empty even when clients exist.
          // If no attention filter is selected, auto-fallback to "show all".
          if (currentData.length === 0 && attentionOnly && !currentAttention) {
            const fallbackParams = new URLSearchParams({ attention_only: false, limit: 100 });
            const fallbackResp = await authFetch(`/api/v1/admin/customers?${fallbackParams.toString()}`);
            const fallbackData = await fallbackResp.json();
            const fallbackItems = fallbackData.items || [];
            if (fallbackItems.length > 0) {
              showAllCheckbox.checked = true;
              currentData = fallbackItems;
              showToast("Nera klientu, kuriems reikia demesio. Rodomi visi klientai.", "info");
            }
          }

          loading.style.display = "none";

          if (currentData.length === 0) {
            empty.style.display = "block";
            return;
          }

          table.style.display = "block";
          renderTable(currentData);
        } catch (err) {
          if (err instanceof AuthError) return;
          loading.innerHTML = '<span style="color:var(--error);">Nepavyko ikelti klientu.</span>';
        }
      }

      function urgencyFromFlags(flags) {
        if (!flags || !flags.length) return "low";
        if (flags.includes("pending_confirmation")) return "high";
        if (flags.includes("failed_outbox")) return "medium";
        return "low";
      }

      function renderTable(items) {
        const tbody = document.getElementById("customersBody");
        tbody.innerHTML = items.map(c => {
          const flags = c.attention_flags || [];
          const flagsHtml = flags.map(f => attentionPill(f)).join(" ");
          const urgency = urgencyFromFlags(flags);
          const tooltip = flags.length ? "Kodėl: " + flags.join(", ") : "";
          const depPill = c.deposit_state === "PAID"
            ? '<span class="pill pill-success" title="PAID">Apmoketas</span>'
            : '<span class="pill pill-yellow" title="PENDING">Laukia</span>';
          const finalPill = c.final_state === "CONFIRMED"
            ? '<span class="pill pill-success" title="CONFIRMED">Patvirtinta</span>'
            : c.final_state === "AWAITING_CONFIRMATION"
              ? '<span class="pill pill-warning" title="AWAITING">Laukia patv.</span>'
              : '<span class="pill pill-gray" title="PENDING">Laukia</span>';

          const lastProj = c.last_project || {};
          const nba = c.next_best_action;
          const nbaBtn = nba && nba.project_id
            ? `<button class="btn btn-xs" title="${escapeHtml(nba.type || '')}" onclick="event.stopPropagation(); runNextAction('${escapeHtml(nba.type || '')}','${escapeHtml(nba.project_id)}')">${escapeHtml(nba.label || nba.type)}</button>`
            : "";
          const projBtn = lastProj.id
            ? `<a class="btn btn-xs btn-ghost" onclick="event.stopPropagation();" href="/admin/projects#${escapeHtml(lastProj.id)}">Projektas</a>`
            : "";

          return `<tr class="row-urgency-${urgency}" style="cursor:pointer;" onclick="openProfile('${escapeHtml(c.client_key)}')" title="${escapeHtml(tooltip)}">
            <td data-label="Vardas">
              <strong>${escapeHtml(c.display_name)}</strong>
              ${c.client_key_confidence === "LOW" ? '<span class="pill pill-gray" title="Zemas tikrumas" style="margin-left:4px;">?</span>' : ""}
            </td>
            <td data-label="Kontaktas">${escapeHtml(c.contact_masked)}</td>
            <td data-label="Projektai">
              ${c.project_count} &middot; ${statusPill(lastProj.status || "")}
            </td>
            <td data-label="Statusas">${statusPill(lastProj.status || "")}</td>
            <td data-label="Depozitas">${depPill}</td>
            <td data-label="Galutinis">${finalPill}</td>
            <td data-label="Demesys">${flagsHtml || '<span style="color:var(--ink-light);">—</span>'}</td>
            <td data-label="Aktyvumas">${formatDate(c.last_activity)}</td>
            <td data-label="Veiksmai" style="white-space:nowrap;">${projBtn} ${nbaBtn}</td>
          </tr>`;
        }).join("");
      }

      function openProfile(clientKey) {
        window.location.href = "/admin/customers/" + encodeURIComponent(clientKey);
      }

      function runNextAction(type, projectId) {
        if (!type) return;
        switch (type) {
          case "record_deposit":
            window.location.href = "/admin/projects#manual-deposit-" + projectId;
            break;
          case "record_final":
            window.location.href = "/admin/projects#manual-final-" + projectId;
            break;
          case "schedule_visit":
            window.location.href = "/admin/calendar";
            break;
          case "resend_confirmation":
            showToast("Persiuntimas galimas kliento profilyje.", "info");
            break;
          default:
            showToast("Veiksmas: " + type, "info");
        }
      }

      showAllCheckbox.addEventListener("change", loadCustomers);

      document.querySelectorAll(".filter-chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const att = chip.dataset.attention || "";
          const url = new URL(window.location.href);
          if (att) url.searchParams.set("attention", att);
          else url.searchParams.delete("attention");
          history.replaceState({}, "", url.toString());
          setActiveFilterChip(att);
          loadCustomers();
        });
      });

      setActiveFilterChip(getAttentionFromUrl());

      loadCustomers();
    </script>
  </body>
</html>
