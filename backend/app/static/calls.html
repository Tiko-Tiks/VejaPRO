<!DOCTYPE html>
<html lang="lt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VejaPRO Administravimas – Skambučiai</title>
    <link
      rel="stylesheet"
      href="/static/vendor/flatpickr/flatpickr.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap");

      :root {
        --bg: #f4f1ec;
        --panel: #ffffff;
        --ink: #161616;
        --muted: #585858;
        --accent: #1e3a8a;
        --accent-dark: #162c6c;
        --border: #e1dcd6;
        --shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        --radius: 16px;
        --radius-sm: 10px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", sans-serif;
        color: var(--ink);
        background: radial-gradient(900px 500px at 10% 0%, #dfe7f3 0%, transparent 60%),
          radial-gradient(900px 500px at 90% -10%, #efe1d2 0%, transparent 60%),
          var(--bg);
      }

      header {
        max-width: 1200px;
        margin: 0 auto;
        padding: 28px 24px 16px;
      }

      .header-brand {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 6px;
      }

      .header-brand img {
        height: 32px;
        width: auto;
        display: block;
      }

      h1 {
        margin: 0 0 6px;
        font-size: 28px;
      }

      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .nav {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .nav a {
        text-decoration: none;
        color: var(--ink);
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #fff;
      }

      .nav a.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto 40px;
        padding: 0 24px 40px;
      }

      .panel {
        background: var(--panel);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .section {
        padding: 20px;
        border-bottom: 1px solid var(--border);
      }

      .section:last-child {
        border-bottom: none;
      }

      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }

      input,
      select,
      button,
      textarea {
        font-family: "Space Grotesk", sans-serif;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: #fff;
        font-size: 14px;
      }

      textarea {
        min-height: 70px;
        resize: vertical;
      }

      .flatpickr-wrapper {
        display: block;
        width: 100%;
      }

      .flatpickr-input {
        display: block;
        width: 100%;
        box-sizing: border-box;
      }

      button {
        border: none;
        border-radius: var(--radius-sm);
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover {
        background: var(--accent-dark);
      }

      .btn-ghost {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--ink);
      }

      .token-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .status-bar {
        padding: 12px 20px;
        font-size: 14px;
        color: var(--muted);
        border-top: 1px solid var(--border);
      }

      .error {
        color: #a91c1c;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #f0ede7;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      th,
      td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        vertical-align: top;
      }

      tbody tr:hover {
        background: #faf7f2;
      }

      .mono {
        font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal.open {
        display: flex;
      }

      .modal-content {
        background: #fff;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 520px;
        padding: 20px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 14px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e3a8a;
        font-size: 12px;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        header { padding: 20px 16px 12px; }
        .container { padding: 0 16px 32px; }
        h1 { font-size: 22px; }
        .nav { gap: 6px; }
        .nav a { padding: 8px 14px; font-size: 11px; min-height: 40px; display: inline-flex; align-items: center; }
        .section { padding: 16px; }
        .form-grid { grid-template-columns: 1fr; }
        .token-row { grid-template-columns: 1fr; gap: 8px; }
        .actions { flex-wrap: wrap; }
        .btn, .btn-primary, .btn-ghost { padding: 12px 18px; min-height: 44px; font-size: 14px; }
        input, select, textarea { padding: 12px; min-height: 44px; font-size: 16px; }

        /* Table -> cards on mobile */
        table { border: 0; }
        table thead { display: none; }
        table tbody tr {
          display: block;
          margin-bottom: 12px;
          border: 1px solid var(--border);
          border-radius: var(--radius-sm);
          padding: 12px;
          background: #fff;
        }
        table tbody td {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 6px 0;
          border: none;
          font-size: 14px;
        }
        table tbody td::before {
          content: attr(data-label);
          font-weight: 600;
          font-size: 12px;
          color: var(--muted);
          min-width: 100px;
        }

        .modal-content { width: 95%; margin: 16px; padding: 20px 16px; max-height: 90vh; overflow-y: auto; }
        .modal-actions { flex-direction: column; }
        .modal-actions button { width: 100%; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-brand">
        <a href="/"><img src="/static/logo.png" alt="VejaPRO" /></a>
        <h1>Skambučių užklausos</h1>
      </div>
      <p class="subtitle">Administravimo skydelis (rankiniai įrankiai).</p>
      <nav class="nav">
        <a href="/admin">Apžvalga</a>
        <a href="/admin/projects">Projektai</a>
        <a href="/admin/calls" class="active">Skambučiai</a>
        <a href="/admin/calendar">Kalendorius</a>
        <a href="/admin/audit">Auditas</a>
        <a href="/admin/margins">Maržos</a>
        <a href="/admin/finance">Finansai</a>
        <a href="/admin/ai">AI Monitor</a>
      </nav>
    </header>

    <div class="container">
      <div class="panel">
        <div class="section">
          <div class="token-row">
            <div>
              <label for="token">Prieigos žetonas</label>
              <input id="token" type="password" placeholder="Įklijuokite JWT žetoną" />
            </div>
            <div style="display: flex; gap: 8px; align-items: end;">
              <button class="btn-ghost" id="generateToken">Generuoti žetoną</button>
              <button class="btn-ghost" id="saveToken">Išsaugoti žetoną</button>
            </div>
          </div>
          <div class="hint" id="tokenStatus" style="margin-top: 6px; font-size: 12px; color: var(--muted);">
            Žetonas nenustatytas.
          </div>
        </div>

        <div class="section">
          <strong>Nauja skambučio užklausa (vieša)</strong>
          <div class="form-grid" style="margin-top: 12px;">
            <div>
              <label>Vardas</label>
              <input id="newName" placeholder="Kliento vardas" />
            </div>
            <div>
              <label>Telefonas</label>
              <input id="newPhone" placeholder="+370..." />
            </div>
            <div>
              <label>El. paštas</label>
              <input id="newEmail" placeholder="klientas@email.com" />
            </div>
            <div>
              <label>Pageidaujamas laikas</label>
              <input id="newPreferredTime" type="text" placeholder="Pasirinkite datą ir laiką" />
            </div>
            <div style="grid-column: 1 / -1;">
              <label>Pastabos</label>
              <textarea id="newNotes" placeholder="Neprivaloma pastaba"></textarea>
            </div>
            <button class="btn-primary" id="createCallRequest">Sukurti skambučio užklausą</button>
          </div>
        </div>

        <div class="section">
          <div class="form-grid">
            <div>
              <label>Būsena</label>
              <select id="statusFilter">
                <option value="">Bet kuri</option>
                <option value="NEW">NAUJA</option>
                <option value="CONTACTED">SUSISIEKTA</option>
                <option value="SCHEDULED">SUPLANUOTA</option>
                <option value="CLOSED">UŽDARYTA</option>
              </select>
            </div>
            <div>
              <label>Limitas</label>
              <select id="limitSelect">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
            </div>
            <div style="align-self: end; display: flex; gap: 8px;">
              <button class="btn-primary" id="applyFilters">Taikyti</button>
              <button class="btn-ghost" id="clearFilters">Valyti</button>
            </div>
          </div>
        </div>

        <div class="section">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Vardas</th>
                <th>Telefonas</th>
                <th>El. paštas</th>
                <th>Pageidaujamas laikas</th>
                <th>Būsena</th>
                <th>Sukurta</th>
                <th>Veiksmai</th>
              </tr>
            </thead>
            <tbody id="callTableBody">
              <tr><td colspan="8">Nėra įrašų</td></tr>
            </tbody>
          </table>
        </div>

        <div class="pagination">
          <div id="pageInfo">Paruošta</div>
          <button class="btn-primary" id="loadMore">Įkelti daugiau</button>
        </div>
        <div class="status-bar" id="statusMessage"></div>
      </div>
    </div>

    <div class="modal" id="editModal">
      <div class="modal-content">
        <div class="modal-header">
          <strong>Atnaujinti skambučio užklausą</strong>
          <button class="btn-ghost" id="closeModal">Uždaryti</button>
        </div>
        <div class="form-grid">
          <div>
            <label>Būsena</label>
            <select id="editStatus">
              <option value="NEW">NAUJA</option>
              <option value="CONTACTED">SUSISIEKTA</option>
              <option value="SCHEDULED">SUPLANUOTA</option>
              <option value="CLOSED">UŽDARYTA</option>
            </select>
          </div>
          <div>
            <label>Pageidaujamas laikas</label>
            <input id="editPreferredTime" type="text" placeholder="Pasirinkite datą ir laiką" />
          </div>
          <div style="grid-column: 1 / -1;">
            <label>Pastabos</label>
            <textarea id="editNotes"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-ghost" id="cancelEdit">Atšaukti</button>
          <button class="btn-primary" id="saveEdit">Išsaugoti</button>
        </div>
      </div>
    </div>

    <script src="/static/vendor/flatpickr/flatpickr.min.js"></script>
    <script src="/static/vendor/flatpickr/l10n/lt.js"></script>
    <script>
      const STORAGE_KEY = "vejapro_admin_token";
      const tokenInput = document.getElementById("token");
      const tokenStatus = document.getElementById("tokenStatus");
      const statusMessage = document.getElementById("statusMessage");
      const callTableBody = document.getElementById("callTableBody");
      const pageInfo = document.getElementById("pageInfo");

      let nextCursor = null;
      let editingId = null;

      const normalizeToken = (value) => {
        if (!value) return "";
        return value.replace(/^Bearer\\s+/i, "").replace(/\\s+/g, "").trim();
      };

      const escapeHtml = (value) => {
        if (value === null || value === undefined) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      };

      const setStatus = (message, isError = false) => {
        statusMessage.textContent = message;
        statusMessage.classList.toggle("error", isError);
      };

      const getToken = () => {
        return normalizeToken(tokenInput.value) || normalizeToken(localStorage.getItem(STORAGE_KEY) || "");
      };

      const fetchWithAuth = async (url, options = {}) => {
        const token = getToken();
        if (!token) {
          throw new Error("Trūksta prieigos žetono.");
        }
        const headers = Object.assign({}, options.headers || {}, {
          Authorization: `Bearer ${token}`,
        });
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || `Užklausa nepavyko (${response.status})`);
        }
        return response;
      };

      const pad = (value) => String(value).padStart(2, "0");

      const toLocalIso = (value) => {
        if (!value) return null;
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return null;
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        const seconds = pad(date.getSeconds());
        const offsetMinutes = -date.getTimezoneOffset();
        const sign = offsetMinutes >= 0 ? "+" : "-";
        const offsetAbs = Math.abs(offsetMinutes);
        const offsetHours = pad(Math.floor(offsetAbs / 60));
        const offsetMins = pad(offsetAbs % 60);
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${sign}${offsetHours}:${offsetMins}`;
      };

      const toLocalInputValue = (value) => {
        if (!value) return "";
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return "";
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      };

      const datePickerLocale = flatpickr && flatpickr.l10ns && flatpickr.l10ns.lt
        ? { ...flatpickr.l10ns.lt, firstDayOfWeek: 1 }
        : null;

      const setPickerValue = (input, value) => {
        if (!input) return;
        if (input._flatpickr) {
          if (value) {
            input._flatpickr.setDate(value, false);
          } else {
            input._flatpickr.clear();
          }
          return;
        }
        input.value = value ? toLocalInputValue(value) : "";
      };

      const formatDate = (value) => {
        if (!value) return "-";
        try {
          return new Date(value).toLocaleString("lt-LT", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hourCycle: "h23",
          });
        } catch (err) {
          return value;
        }
      };

      const clearTable = () => {
        callTableBody.innerHTML = "";
      };

      const appendRow = (item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="mono" data-label="ID">${escapeHtml(item.id)}</td>
          <td data-label="Vardas">${escapeHtml(item.name || "-")}</td>
          <td data-label="Telefonas">${escapeHtml(item.phone || "-")}</td>
          <td data-label="El. paštas">${escapeHtml(item.email || "-")}</td>
          <td data-label="Pageidaujamas laikas">${escapeHtml(formatDate(item.preferred_time))}</td>
          <td data-label="Būsena"><span class="pill">${escapeHtml(item.status)}</span></td>
          <td data-label="Sukurta">${escapeHtml(formatDate(item.created_at))}</td>
          <td data-label="Veiksmai"><button class="btn-ghost" data-action="edit">Redaguoti</button></td>
        `;
        row.querySelector('[data-action="edit"]').addEventListener("click", () => openEdit(item));
        callTableBody.appendChild(row);
      };

      const loadCalls = async (reset = false) => {
        try {
          if (reset) {
            nextCursor = null;
            clearTable();
          }
          setStatus("Įkeliamos skambučių užklausos...");
          const status = document.getElementById("statusFilter").value;
          const limit = document.getElementById("limitSelect").value;
          const params = new URLSearchParams();
          if (status) params.set("status", status);
          if (limit) params.set("limit", limit);
          if (nextCursor) params.set("cursor", nextCursor);

          const resp = await fetchWithAuth(`/api/v1/admin/call-requests?${params.toString()}`);
          const data = await resp.json();

          if (!data.items || data.items.length === 0) {
            if (reset) {
              callTableBody.innerHTML = `<tr><td colspan="8">Nėra įrašų</td></tr>`;
            }
            setStatus("Daugiau įrašų nėra.");
          } else {
            data.items.forEach(appendRow);
            setStatus(`Įkelta skambučių užklausų: ${data.items.length}.`);
          }

          nextCursor = data.has_more ? data.next_cursor : null;
          pageInfo.textContent = data.has_more ? "Yra daugiau" : "Sąrašo pabaiga";
        } catch (err) {
          setStatus(err.message || "Netikėta klaida.", true);
          callTableBody.innerHTML = `<tr><td colspan="8">Netikėta klaida.</td></tr>`;
        }
      };

      const openEdit = (item) => {
        editingId = item.id;
        document.getElementById("editStatus").value = item.status || "NEW";
        setPickerValue(document.getElementById("editPreferredTime"), item.preferred_time);
        document.getElementById("editNotes").value = item.notes || "";
        document.getElementById("editModal").classList.add("open");
      };

      const closeEdit = () => {
        editingId = null;
        document.getElementById("editModal").classList.remove("open");
      };

      document.getElementById("closeModal").addEventListener("click", closeEdit);
      document.getElementById("cancelEdit").addEventListener("click", closeEdit);

      document.getElementById("saveEdit").addEventListener("click", async () => {
        if (!editingId) return;
        try {
          const payload = {};
          const status = document.getElementById("editStatus").value;
          const preferredTime = toLocalIso(document.getElementById("editPreferredTime").value);
          const notes = document.getElementById("editNotes").value.trim();

          if (status) payload.status = status;
          if (preferredTime !== null) payload.preferred_time = preferredTime;
          payload.notes = notes;

          await fetchWithAuth(`/api/v1/admin/call-requests/${encodeURIComponent(editingId)}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          closeEdit();
          await loadCalls(true);
        } catch (err) {
          setStatus(err.message || "Atnaujinti nepavyko.", true);
        }
      });

      document.getElementById("applyFilters").addEventListener("click", () => loadCalls(true));
      document.getElementById("clearFilters").addEventListener("click", () => {
        document.getElementById("statusFilter").value = "";
        document.getElementById("limitSelect").value = "50";
        loadCalls(true);
      });

      document.getElementById("loadMore").addEventListener("click", () => {
        if (nextCursor) {
          loadCalls(false);
        }
      });

      document.getElementById("createCallRequest").addEventListener("click", async () => {
        try {
          const payload = {
            name: document.getElementById("newName").value.trim(),
            phone: document.getElementById("newPhone").value.trim(),
            email: document.getElementById("newEmail").value.trim() || null,
            preferred_time: toLocalIso(document.getElementById("newPreferredTime").value),
            notes: document.getElementById("newNotes").value.trim() || null,
          };
          if (!payload.name || !payload.phone) {
            setStatus("Vardas ir telefonas yra privalomi.", true);
            return;
          }
          const resp = await fetch("/api/v1/call-requests", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(text || `Sukurti nepavyko (${resp.status})`);
          }
          setStatus("Skambučio užklausa sukurta.");
          document.getElementById("newName").value = "";
          document.getElementById("newPhone").value = "";
          document.getElementById("newEmail").value = "";
          setPickerValue(document.getElementById("newPreferredTime"), null);
          document.getElementById("newNotes").value = "";
          await loadCalls(true);
        } catch (err) {
          setStatus(err.message || "Sukurti nepavyko.", true);
        }
      });

      [document.getElementById("newPreferredTime"), document.getElementById("editPreferredTime")].forEach((input) => {
        flatpickr(input, {
          enableTime: true,
          time_24hr: true,
          dateFormat: "Y-m-d\\TH:i",
          altInput: true,
          altFormat: "d.m.Y H:i",
          allowInput: true,
          locale: datePickerLocale || undefined,
        });
      });

      const initToken = () => {
        const stored = localStorage.getItem(STORAGE_KEY) || "";
        if (stored && !tokenInput.value) {
          tokenInput.value = stored;
          tokenStatus.textContent = "Žetonas įkeltas iš naršyklės saugyklos.";
        }
      };

      document.getElementById("saveToken").addEventListener("click", () => {
        const token = normalizeToken(tokenInput.value);
        if (token) {
          localStorage.setItem(STORAGE_KEY, token);
          tokenInput.value = token;
          tokenStatus.textContent = "Žetonas išsaugotas.";
        } else {
          localStorage.removeItem(STORAGE_KEY);
          tokenStatus.textContent = "Žetonas ištrintas.";
        }
      });

      document.getElementById("generateToken").addEventListener("click", async () => {
        try {
          tokenStatus.textContent = "Generuojamas žetonas...";
          const resp = await fetch("/api/v1/admin/token");
          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(text || `Žetono generavimas nepavyko (${resp.status})`);
          }
          const data = await resp.json();
          if (!data.token) {
            throw new Error("Žetono generavimas nepavyko.");
          }
          localStorage.setItem(STORAGE_KEY, data.token);
          tokenInput.value = data.token;
          tokenStatus.textContent = "Žetonas sugeneruotas.";
        } catch (err) {
          tokenStatus.textContent = err.message || "Žetono generavimas nepavyko.";
        }
      });

      initToken();
      loadCalls(true);
    </script>
  </body>
</html>
