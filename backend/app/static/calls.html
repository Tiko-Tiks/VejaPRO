<!DOCTYPE html>
<html lang="lt" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="description" content="VejaPRO - skambuciu uzklausos." />
    <title>VejaPRO - Skambuciai</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" />
    <link href="/static/admin-shared.css?v=6.0" rel="stylesheet" />
    <link href="/static/vendor/flatpickr/flatpickr.min.css" rel="stylesheet" />
    <style>
      .calls-page .section { padding: 14px 16px; border-bottom: 1px solid var(--border); }
      .calls-page .section:last-child { border-bottom: none; }
      .calls-page .btn { padding: 7px 12px; font-size: 12px; }
      .calls-page .btn-xs { padding: 4px 8px; font-size: 11px; }
      .calls-page textarea { min-height: 66px; resize: vertical; }
      .calls-page .flatpickr-wrapper { display: block; width: 100%; }
      .calls-page .flatpickr-input { display: block; width: 100%; box-sizing: border-box; }
      .calls-page .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius-lg); background: var(--surface); }
      .calls-page .data-table.calls th:nth-child(1) { width: 24%; }
      .calls-page .data-table.calls th:nth-child(2) { width: 20%; }
      .calls-page .data-table.calls th:nth-child(3) { width: 20%; }
      .calls-page .data-table.calls th:nth-child(4) { width: 14%; }
      .calls-page .data-table.calls th:nth-child(5) { width: 14%; }
      .calls-page .data-table.calls th:nth-child(6) { width: 8%; }
      .calls-page .data-table.calls td { vertical-align: top; }
      .calls-page .row-main { font-weight: 600; color: var(--ink-heading); margin-bottom: 4px; }
      .calls-page .row-sub { color: var(--ink-muted); font-size: 12px; line-height: 1.35; }
      .calls-page .compact-toolbar { display: flex; justify-content: space-between; gap: 10px; align-items: center; margin: 8px 0 12px; }
      .calls-page .compact-toolbar .filter-chips { margin: 0; }
      .calls-page .pagination-row { display:flex; justify-content:space-between; align-items:center; }
      .calls-page .inline-note { color: var(--ink-muted); font-size: 12px; }
      .calls-page details.operator-create { border: 1px solid var(--border); border-radius: var(--radius-lg); background: var(--surface); margin-bottom: 12px; }
      .calls-page details.operator-create > summary { cursor: pointer; padding: 10px 14px; font-weight: 600; color: var(--ink-heading); }
      .calls-page details.operator-create > summary::marker { color: var(--ink-muted); }
      .calls-page details.operator-create[open] > summary { border-bottom: 1px solid var(--border); }
      .calls-page .control-header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:12px; }
      .calls-page .control-meta { display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
      .calls-page .control-contact { color: var(--ink-muted); font-size: 12px; margin-top: 4px; }
      .calls-page .control-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .calls-page .control-actions { margin-top: 10px; display:flex; gap:6px; flex-wrap:wrap; }
      .calls-page #offerInfo { margin-top: 10px; padding: 10px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
      .calls-page #offerDetails { color: var(--ink-muted); font-size: 12px; line-height: 1.35; }
      .calls-page #intakeStatus { margin-top: 8px; font-size: 12px; color: var(--ink-muted); }
      .calls-page .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 14px; }
      .calls-page #editModal .modal-content.control-modal-content {
        width: min(860px, calc(100vw - 16px));
        max-height: calc(100vh - 16px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .calls-page #editModal .modal-header {
        flex: 0 0 auto;
        padding: 12px 16px;
      }
      .calls-page #editModal .control-scroll {
        flex: 1 1 auto;
        overflow: auto;
        padding: 12px 16px;
      }
      .calls-page #editModal label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: var(--ink-heading);
        margin-bottom: 4px;
      }
      .calls-page #editModal input,
      .calls-page #editModal select,
      .calls-page #editModal textarea {
        width: 100%;
        box-sizing: border-box;
      }
      .calls-page #editModal textarea {
        min-height: 78px;
      }
      .calls-page .control-block {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--surface);
        padding: 10px;
      }
      .calls-page #editModal .modal-actions {
        flex: 0 0 auto;
        margin: 0;
        padding: 10px 16px 14px;
        border-top: 1px solid var(--border);
      }
      .calls-page #editModal .control-actions {
        justify-content: flex-start;
        gap: 8px;
      }
      .calls-page #editModal #intakeStatus {
        padding: 8px 10px;
        border: 1px dashed var(--border);
        border-radius: var(--radius);
        background: var(--surface);
      }
      .calls-page #editModal .control-contact {
        line-height: 1.35;
        overflow-wrap: anywhere;
      }
      .calls-page .data-table.calls tbody tr {
        cursor: pointer;
      }
      @media (max-width: 980px) {
        .calls-page .control-grid { grid-template-columns: 1fr; }
      }
    </style>
    <script>try{var t=localStorage.getItem("vejapro_theme")||"light";document.documentElement.dataset.theme=t;}catch(e){}</script>
  </head>
  <body>
    <button class="hamburger" aria-label="Meniu">&#9776;</button>
    <div class="sidebar-overlay"></div>

    <div class="admin-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/"><img src="/static/logo.png" alt="VejaPRO" class="logo" /></a>
        </div>
        <nav class="sidebar-nav" id="sidebarNav"></nav>
        <div class="sidebar-token token-card">
          <div class="token-card-header">
            <span>&#128274; Zetonas</span>
            <span id="tokenBadge" class="pill pill-gray">Nenustatytas</span>
          </div>
          <div class="token-card-body">
            <input id="tokenInput" type="password" class="form-input" placeholder="JWT zetonas" />
            <div style="display:flex;gap:6px;margin-top:8px;">
              <button class="btn btn-sm" id="btnGenerate" type="button">Gen.</button>
              <button class="btn btn-sm btn-secondary" id="btnSaveToken" type="button">Issaug.</button>
            </div>
            <div id="tokenStatus" style="font-size:11px;color:var(--sidebar-ink-muted);margin-top:6px;"></div>
          </div>
        </div>
        <div class="sidebar-footer">V6.0</div>
      </aside>

      <main class="main-content calls-page">
        <div class="page-header">
          <h1>Skambuciai</h1>
        </div>

        <div class="content-area">
          <details class="operator-create" id="newCallPanel">
            <summary>Nauja skambucio uzklausa (retai naudojama)</summary>
            <div class="section">
              <div class="form-grid">
                <div>
                  <label>Vardas</label>
                  <input id="newName" placeholder="Kliento vardas" />
                </div>
                <div>
                  <label>Telefonas</label>
                  <input id="newPhone" placeholder="+370..." />
                </div>
                <div>
                  <label>El. pastas</label>
                  <input id="newEmail" placeholder="klientas@email.com" />
                </div>
                <div>
                  <label>Pageidaujamas laikas</label>
                  <input id="newPreferredTime" type="text" placeholder="Pasirinkite data ir laika" />
                </div>
                <div style="grid-column: 1 / -1;">
                  <label>Pastabos</label>
                  <textarea id="newNotes" placeholder="Neprivaloma pastaba"></textarea>
                </div>
                <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end;">
                  <button class="btn btn-primary btn-sm" id="createCallRequest">Sukurti uzklausa</button>
                </div>
              </div>
            </div>
          </details>

          <div class="compact-toolbar">
            <div class="filter-chips" id="filterChips">
              <button class="filter-chip active" data-status="NEW">Nauji <span id="newBadge" class="badge pill pill-error" style="display:none;">0</span></button>
              <button class="filter-chip" data-status="">Visi</button>
              <button class="filter-chip" data-status="CONTACTED">Susisiekta</button>
              <button class="filter-chip" data-status="SCHEDULED">Suplanuota</button>
              <button class="filter-chip" data-status="CLOSED">Uzdaryta</button>
            </div>
            <div class="inline-note" id="callsHint">Valdymas: tik aktualus statusas, etapas ir kontaktas.</div>
          </div>

          <div class="section">
            <div class="table-container">
              <table class="data-table calls">
                <thead>
                  <tr>
                    <th>Klientas</th>
                    <th>Kontaktas</th>
                    <th>Etapas</th>
                    <th>Busena</th>
                    <th>Atnaujinta</th>
                    <th>Veiksmas</th>
                  </tr>
                </thead>
                <tbody id="callTableBody">
                  <tr><td colspan="6">Nera irasu</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="section pagination-row">
            <div id="pageInfo">Paruosta</div>
            <button class="btn btn-secondary btn-sm" id="loadMore">Ikelti daugiau</button>
          </div>
          <div class="status-bar" id="statusMessage"></div>
        </div>
      </main>
    </div>

    <div class="modal" id="editModal">
      <div class="modal-content control-modal-content">
        <div class="modal-header">
          <strong>Skambucio valdymo langas</strong>
          <button class="btn btn-ghost btn-sm" id="closeModal">Uzdaryti</button>
        </div>

        <div class="control-scroll">
          <div class="control-header">
            <div>
              <div class="row-main" id="controlClientName">-</div>
              <div class="control-contact" id="controlContact">-</div>
            </div>
            <div class="control-meta">
              <span class="pill pill-gray" id="controlStatusPill">Busena: -</span>
              <span class="pill pill-info" id="controlPhasePill">Etapas: -</span>
            </div>
          </div>

          <div class="control-block">
            <div class="control-grid">
              <div>
                <label>Busena</label>
                <select id="editStatus">
                  <option value="NEW">NAUJA</option>
                  <option value="CONTACTED">SUSISIEKTA</option>
                  <option value="SCHEDULED">SUPLANUOTA</option>
                  <option value="CLOSED">UZDARYTA</option>
                </select>
              </div>
              <div>
                <label>Pageidaujamas laikas</label>
                <input id="editPreferredTime" type="text" placeholder="Pasirinkite data ir laika" />
              </div>
              <div style="grid-column: 1 / -1;">
                <label>Pastabos operatoriui</label>
                <textarea id="editNotes"></textarea>
              </div>
            </div>
          </div>

          <div id="intakeSection" class="control-block" style="margin-top: 12px;">
            <div class="row-main">Kliento anketa</div>
            <div class="control-grid" style="margin-top: 8px;">
              <div>
                <label>El. pastas</label>
                <input id="intakeEmail" placeholder="klientas@email.com" />
              </div>
              <div>
                <label>Adresas</label>
                <input id="intakeAddress" placeholder="Gatve, miestas" />
              </div>
              <div>
                <label>Paslaugos tipas</label>
                <input id="intakeServiceType" placeholder="pvz. vejos pjovimas" />
              </div>
              <div>
                <label>WhatsApp sutikimas</label>
                <select id="intakeWhatsapp">
                  <option value="false">Ne</option>
                  <option value="true">Taip</option>
                </select>
              </div>
            </div>
            <div class="control-actions">
              <button class="btn btn-secondary btn-sm" id="saveIntake">Issaugoti anketa</button>
              <button class="btn btn-ghost btn-sm" id="prepareOffer">Paruosti pasiulyma</button>
              <button class="btn btn-primary btn-sm" id="sendOffer">Siusti pasiulyma</button>
            </div>
            <div id="intakeStatus"></div>

            <div id="offerInfo" style="display: none;">
              <div class="row-main" style="font-size:13px; margin-bottom:4px;">Pasiulymo bukle</div>
              <div id="offerDetails"></div>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-ghost btn-sm" id="cancelEdit">Atsaukti</button>
          <button class="btn btn-primary btn-sm" id="saveEdit">Issaugoti pakeitimus</button>
        </div>
      </div>
    </div>

    <script src="/static/admin-shared.js?v=6.0"></script>
    <script src="/static/vendor/flatpickr/flatpickr.min.js"></script>
    <script src="/static/vendor/flatpickr/l10n/lt.js"></script>
    <script>
      document.getElementById("sidebarNav").innerHTML = sidebarHTML("/admin/calls");
      if (typeof initSidebar === "function") initSidebar();
      if (typeof initTokenCard === "function") initTokenCard();

      const tokenInput = document.getElementById("tokenInput");
      const tokenStatus = document.getElementById("tokenStatus");
      const tokenBadge = document.getElementById("tokenBadge");
      const statusMessage = document.getElementById("statusMessage");
      const callTableBody = document.getElementById("callTableBody");
      const pageInfo = document.getElementById("pageInfo");

      let nextCursor = null;
      let editingId = null;
      let editingItem = null;
      let currentStatusFilter = "NEW";
      let lastNewCount = 0;

      const setStatus = (message, isError = false) => {
        statusMessage.textContent = message;
        statusMessage.classList.toggle("error", isError);
      };

      const fetchWithAuth = async (url, options = {}) => {
        const resp = await authFetch(url, { ...options, headers: { ...(options.headers || {}), ...Auth.headers() } });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `Uzklausa nepavyko (${resp.status})`);
        }
        return resp;
      };

      const updateTokenBadge = () => {
        if (!tokenBadge) return;
        if (Auth.isSet()) {
          tokenBadge.textContent = "Aktyvus";
          tokenBadge.className = "pill pill-success";
        } else {
          tokenBadge.textContent = "Nenustatytas";
          tokenBadge.className = "pill pill-gray";
        }
      };

      const initToken = () => {
        const stored = Auth.get();
        if (stored && !tokenInput.value) {
          tokenInput.value = Auth.normalize(stored);
          tokenStatus.textContent = "Zetonas ikeltas is narsykles saugyklos.";
        }
        updateTokenBadge();
      };

      const pad = (value) => String(value).padStart(2, "0");

      const toLocalIso = (value) => {
        if (!value) return null;
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return null;
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        const seconds = pad(date.getSeconds());
        const offsetMinutes = -date.getTimezoneOffset();
        const sign = offsetMinutes >= 0 ? "+" : "-";
        const offsetAbs = Math.abs(offsetMinutes);
        const offsetHours = pad(Math.floor(offsetAbs / 60));
        const offsetMins = pad(offsetAbs % 60);
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${sign}${offsetHours}:${offsetMins}`;
      };

      const toLocalInputValue = (value) => {
        if (!value) return "";
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return "";
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      };

      const datePickerLocale = flatpickr && flatpickr.l10ns && flatpickr.l10ns.lt
        ? { ...flatpickr.l10ns.lt, firstDayOfWeek: 1 }
        : null;

      const setPickerValue = (input, value) => {
        if (!input) return;
        if (input._flatpickr) {
          if (value) {
            input._flatpickr.setDate(value, false);
          } else {
            input._flatpickr.clear();
          }
          return;
        }
        input.value = value ? toLocalInputValue(value) : "";
      };

      const _fmtDate = (value) => {
        if (!value) return "-";
        try {
          return new Date(value).toLocaleString("lt-LT", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hourCycle: "h23",
          });
        } catch (err) {
          return value;
        }
      };

      const CALLS_COLS = 6;
      const STATUS_LABELS = {
        NEW: "Nauja",
        CONTACTED: "Susisiekta",
        SCHEDULED: "Suplanuota",
        CLOSED: "Uzdaryta",
      };
      const PHASE_LABELS = {
        QUESTIONNAIRE_DONE: "Anketa uzpildyta",
        OFFER_PREPARED: "Pasiulymas paruostas",
        OFFER_SENT: "Pasiulymas issiustas",
        INSPECTION_SCHEDULED: "Apziura suplanuota",
        OFFER_REJECTED_NO_SLOTS: "Atmesta, nera slotu",
      };

      const clearTable = () => {
        callTableBody.innerHTML = "";
      };

      const phaseFromState = (state) => {
        if (!state || typeof state !== "object") return "";
        const wf = state.workflow || {};
        return String(wf.phase || state.workflow_stage || "").trim();
      };

      const questionnaireCompleteFromState = (state) => {
        const q = (state && state.questionnaire) || {};
        const fields = ["email", "address", "service_type"];
        return fields.every((key) => {
          const raw = q[key];
          if (raw && typeof raw === "object") return Boolean(raw.value);
          return Boolean(raw);
        });
      };

      const formatPhaseLabel = (phase) => PHASE_LABELS[phase] || (phase ? phase : "-");

      const updateControlHeader = (item, state) => {
        if (!item) return;
        const phase = phaseFromState(state || item.intake_state || {});
        const status = item.status || "NEW";
        document.getElementById("controlClientName").textContent = item.name || "-";
        document.getElementById("controlContact").textContent = `${maskPhone(item.phone || "")} | ${maskEmail(item.email || "")}`;
        document.getElementById("controlStatusPill").textContent = `Busena: ${STATUS_LABELS[status] || status}`;
        document.getElementById("controlPhasePill").textContent = `Etapas: ${formatPhaseLabel(phase)}`;
      };

      const updateActionVisibility = (state) => {
        const prepareBtn = document.getElementById("prepareOffer");
        const sendBtn = document.getElementById("sendOffer");
        const intakeReady = questionnaireCompleteFromState(state);
        const offerState = String(((state || {}).active_offer || {}).state || "NONE").toUpperCase();

        prepareBtn.disabled = !intakeReady;
        sendBtn.disabled = !intakeReady;

        if (!intakeReady) {
          sendBtn.textContent = "Siusti pasiulyma";
          return;
        }

        if (offerState === "SENT") {
          sendBtn.textContent = "Siusti dar karta";
          return;
        }
        if (offerState === "PREPARED") {
          sendBtn.textContent = "Siusti pasiulyma";
          return;
        }
        sendBtn.textContent = "Siusti pasiulyma";
      };

      const appendRow = (item) => {
        const row = document.createElement("tr");
        const state = item.intake_state || {};
        const phase = phaseFromState(state);
        const status = item.status || "-";
        const sentiment = state.sentiment_analysis;
        const sentimentPill = sentiment && sentiment.label === "NEGATIVE"
          ? ' <span class="pill pill-warning">Neigiamas tonas</span>' : "";
        const preferred = _fmtDate(item.preferred_time);
        const updated = _fmtDate(item.updated_at || item.created_at);
        const maskedPhone = escapeHtml(maskPhone(item.phone || ""));
        const maskedEmail = escapeHtml(maskEmail(item.email || ""));

        row.innerHTML = `
          <td data-label="Klientas">
            <div class="row-main">${escapeHtml(item.name || "-")}</div>
            <div class="row-sub">Pageidaujamas laikas: ${escapeHtml(preferred)}</div>
          </td>
          <td data-label="Kontaktas">
            <div class="row-sub">${maskedPhone}</div>
            <div class="row-sub">${maskedEmail}</div>
          </td>
          <td data-label="Etapas">
            <span class="pill pill-info">${escapeHtml(formatPhaseLabel(phase))}</span>
          </td>
          <td data-label="Busena">
            <span class="pill">${escapeHtml(STATUS_LABELS[status] || status)}</span>${sentimentPill}
          </td>
          <td data-label="Atnaujinta">
            <div class="row-sub">${escapeHtml(updated)}</div>
          </td>
          <td data-label="Veiksmas">
            <button class="btn btn-secondary btn-xs" data-action="edit">Valdyti</button>
          </td>
        `;

        row.addEventListener("click", () => openEdit(item));
        row.querySelector('[data-action="edit"]').addEventListener("click", (e) => {
          e.stopPropagation();
          openEdit(item);
        });
        callTableBody.appendChild(row);
      };

      const updateNewBadge = (count) => {
        const badge = document.getElementById("newBadge");
        const hint = document.getElementById("callsHint");
        if (!badge) return;
        lastNewCount = count;
        badge.textContent = count;
        badge.style.display = count > 0 ? "inline" : "none";
        if (hint) {
          hint.textContent = count > 0
            ? `Yra ${count} naujos uzklausos. Prioritetas: NEW.`
            : "Nauju uzklausu nera. Galite perziureti visa srauta.";
        }
      };

      const loadCalls = async (reset = false) => {
        if (!Auth.isSet()) {
          callTableBody.innerHTML = `<tr><td colspan="${CALLS_COLS}" style="text-align:center;color:var(--ink-muted);padding:32px;">Prisijunkite arba sugeneruokite zetona (sonine juosta apacioje).</td></tr>`;
          setStatus("");
          return;
        }
        try {
          if (reset) {
            nextCursor = null;
            clearTable();
          }
          setStatus("Ikeliamos skambuciu uzklausos...");
          const limit = "50";
          const params = new URLSearchParams();
          if (currentStatusFilter) params.set("status", currentStatusFilter);
          params.set("limit", limit);
          if (nextCursor) params.set("cursor", nextCursor);

          const resp = await fetchWithAuth(`/api/v1/admin/call-requests?${params.toString()}`);
          const data = await resp.json();

          if (!data.items || data.items.length === 0) {
            if (reset) {
              callTableBody.innerHTML = `<tr><td colspan="${CALLS_COLS}">Nera irasu</td></tr>`;
            }
            setStatus("Daugiau irasu nera.");
          } else {
            data.items.forEach(appendRow);
            setStatus(`Ikelta: ${data.items.length}.`);
          }

          if (data.stats && data.stats.new_count !== undefined) {
            updateNewBadge(data.stats.new_count);
          }

          nextCursor = data.has_more ? data.next_cursor : null;
          pageInfo.textContent = data.has_more ? "Yra daugiau" : "Saraso pabaiga";
        } catch (err) {
          setStatus(err.message || "Netiketa klaida.", true);
          callTableBody.innerHTML = `<tr><td colspan="${CALLS_COLS}">Netiketa klaida.</td></tr>`;
        }
      };

      const openEdit = (item) => {
        editingId = item.id;
        editingItem = { ...item };
        document.getElementById("editStatus").value = item.status || "NEW";
        setPickerValue(document.getElementById("editPreferredTime"), item.preferred_time);
        document.getElementById("editNotes").value = item.notes || "";
        document.getElementById("editModal").classList.add("open");
        updateControlHeader(editingItem, item.intake_state || {});
        updateActionVisibility(item.intake_state || {});

        // Load intake state
        const intakeStatus = document.getElementById("intakeStatus");
        const offerInfo = document.getElementById("offerInfo");
        const offerDetails = document.getElementById("offerDetails");
        offerInfo.style.display = "none";
        intakeStatus.textContent = "";

        // Pre-fill intake fields from item data (fallback)
        const populateIntake = (state) => {
          const q = (state && state.questionnaire) || {};
          document.getElementById("intakeEmail").value = (q.email && q.email.value) || item.email || "";
          document.getElementById("intakeAddress").value = (q.address && q.address.value) || "";
          document.getElementById("intakeServiceType").value = (q.service_type && q.service_type.value) || "";
          const whatsappValue = q.whatsapp_consent && typeof q.whatsapp_consent === "object"
            ? Boolean(q.whatsapp_consent.value)
            : Boolean(q.whatsapp_consent);
          document.getElementById("intakeWhatsapp").value = whatsappValue ? "true" : "false";
          if (editingItem && editingItem.id === item.id) {
            editingItem.intake_state = state || {};
          }
          updateControlHeader(editingItem || item, state || {});
          updateActionVisibility(state || {});

          // Show offer state if exists
          const ao = (state && state.active_offer) || {};
          if (ao.state && ao.state !== "NONE") {
            offerInfo.style.display = "block";
            const slot = ao.slot || {};
            offerDetails.innerHTML =
              `<div>Busena: <span class="pill">${escapeHtml(ao.state)}</span></div>` +
              `<div>Laikas: ${escapeHtml(slot.start || "-")} - ${escapeHtml(slot.end || "-")}</div>` +
              `<div>Bandymas: ${escapeHtml(ao.attempt_no || 0)}</div>` +
              (ao.hold_expires_at ? `<div>Hold iki: ${escapeHtml(ao.hold_expires_at)}</div>` : "");
          } else {
            offerInfo.style.display = "none";
            offerDetails.innerHTML = "";
          }

          // Show workflow stage
          const wf = phaseFromState(state || {});
          if (wf) {
            intakeStatus.textContent = `Intake etapas: ${wf}`;
          } else {
            intakeStatus.textContent = "";
          }
        };

        // Try loading intake state from API first
        (async () => {
          try {
            const resp = await fetchWithAuth(`/api/v1/admin/intake/${encodeURIComponent(item.id)}/state`);
            const data = await resp.json();
            populateIntake(data);
          } catch (err) {
            // Fallback to data from list
            populateIntake(item.intake_state || {});
          }
        })();
      };

      const closeEdit = () => {
        editingId = null;
        editingItem = null;
        document.getElementById("editModal").classList.remove("open");
      };

      document.getElementById("closeModal").addEventListener("click", closeEdit);
      document.getElementById("cancelEdit").addEventListener("click", closeEdit);
      document.getElementById("editStatus").addEventListener("change", (e) => {
        if (!editingItem) return;
        editingItem.status = e.target.value || "NEW";
        updateControlHeader(editingItem, editingItem.intake_state || {});
      });

      document.getElementById("saveEdit").addEventListener("click", async () => {
        if (!editingId) return;
        try {
          const payload = {};
          const status = document.getElementById("editStatus").value;
          const preferredTime = toLocalIso(document.getElementById("editPreferredTime").value);
          const notes = document.getElementById("editNotes").value.trim();

          if (status) payload.status = status;
          if (preferredTime !== null) payload.preferred_time = preferredTime;
          payload.notes = notes;

          await fetchWithAuth(`/api/v1/admin/call-requests/${encodeURIComponent(editingId)}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          closeEdit();
          await loadCalls(true);
        } catch (err) {
          setStatus(err.message || "Atnaujinti nepavyko.", true);
        }
      });

      document.querySelectorAll("#filterChips .filter-chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          document.querySelectorAll("#filterChips .filter-chip").forEach((c) => c.classList.remove("active"));
          chip.classList.add("active");
          currentStatusFilter = (chip.dataset.status || "").trim();
          loadCalls(true);
        });
      });

      document.getElementById("loadMore").addEventListener("click", () => {
        if (nextCursor) {
          loadCalls(false);
        }
      });

      document.getElementById("createCallRequest").addEventListener("click", async () => {
        try {
          const payload = {
            name: document.getElementById("newName").value.trim(),
            phone: document.getElementById("newPhone").value.trim(),
            email: document.getElementById("newEmail").value.trim() || null,
            preferred_time: toLocalIso(document.getElementById("newPreferredTime").value),
            notes: document.getElementById("newNotes").value.trim() || null,
          };
          if (!payload.name || !payload.phone) {
            setStatus("Vardas ir telefonas yra privalomi.", true);
            return;
          }
          const resp = await fetch("/api/v1/call-requests", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(text || `Sukurti nepavyko (${resp.status})`);
          }
          setStatus("Skambucio uzklausa sukurta.");
          document.getElementById("newName").value = "";
          document.getElementById("newPhone").value = "";
          document.getElementById("newEmail").value = "";
          setPickerValue(document.getElementById("newPreferredTime"), null);
          document.getElementById("newNotes").value = "";
          await loadCalls(true);
        } catch (err) {
          setStatus(err.message || "Sukurti nepavyko.", true);
        }
      });

      [document.getElementById("newPreferredTime"), document.getElementById("editPreferredTime")].forEach((input) => {
        flatpickr(input, {
          enableTime: true,
          time_24hr: true,
          dateFormat: "Y-m-d\\TH:i",
          altInput: true,
          altFormat: "d.m.Y H:i",
          allowInput: true,
          locale: datePickerLocale || undefined,
        });
      });

      document.getElementById("btnSaveToken").addEventListener("click", () => {
        const token = Auth.normalize(tokenInput.value);
        if (token) {
          Auth.set(token);
          tokenInput.value = token;
          tokenStatus.textContent = "Zetonas issaugotas.";
          showToast("Zetonas issaugotas", "success");
        } else {
          Auth.remove();
          tokenStatus.textContent = "Zetonas istrintas.";
        }
        updateTokenBadge();
      });

      document.getElementById("btnGenerate").addEventListener("click", async () => {
        tokenStatus.textContent = "Generuojamas zetonas...";
        try {
          const token = await Auth.generate();
          if (token) {
            tokenInput.value = token;
            tokenStatus.textContent = "Zetonas sugeneruotas.";
            showToast("Zetonas sugeneruotas", "success");
          } else {
            tokenStatus.textContent = "Zetono generavimas nepavyko.";
          }
        } catch (err) {
          tokenStatus.textContent = err.message || "Zetono generavimas nepavyko.";
        }
        updateTokenBadge();
      });

      // Intake handlers

      document.getElementById("saveIntake").addEventListener("click", async () => {
        if (!editingId) return;
        const intakeStatus = document.getElementById("intakeStatus");
        try {
          intakeStatus.textContent = "Saugoma...";
          const patch = {};
          const email = document.getElementById("intakeEmail").value.trim();
          const address = document.getElementById("intakeAddress").value.trim();
          const serviceType = document.getElementById("intakeServiceType").value.trim();
          const whatsapp = document.getElementById("intakeWhatsapp").value === "true";

          if (email) patch.email = email;
          if (address) patch.address = address;
          if (serviceType) patch.service_type = serviceType;
          patch.whatsapp_consent = whatsapp;

          const resp = await fetchWithAuth(
            `/api/v1/admin/intake/${encodeURIComponent(editingId)}/questionnaire`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(patch),
            }
          );
          const data = await resp.json();
          updateActionVisibility(data || {});
          intakeStatus.textContent = data.questionnaire_complete
            ? "Anketa pilna. Galite ruosti pasiulyma."
            : "Anketa issaugota (truksta lauku).";
        } catch (err) {
          intakeStatus.textContent = err.message || "Issaugoti nepavyko.";
        }
      });

      document.getElementById("prepareOffer").addEventListener("click", async () => {
        if (!editingId) return;
        const intakeStatus = document.getElementById("intakeStatus");
        const offerInfo = document.getElementById("offerInfo");
        const offerDetails = document.getElementById("offerDetails");
        try {
          intakeStatus.textContent = "Ruosiamas pasiulymas...";
          const resp = await fetchWithAuth(
            `/api/v1/admin/intake/${encodeURIComponent(editingId)}/prepare-offer`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ kind: "INSPECTION" }),
            }
          );
          const data = await resp.json();
          updateActionVisibility({ active_offer: { state: "PREPARED" }, questionnaire: {
            email: { value: document.getElementById("intakeEmail").value.trim() },
            address: { value: document.getElementById("intakeAddress").value.trim() },
            service_type: { value: document.getElementById("intakeServiceType").value.trim() },
          }});
          if (editingItem && data && data.phase) {
            editingItem.intake_state = {
              ...(editingItem.intake_state || {}),
              workflow: { ...((editingItem.intake_state || {}).workflow || {}), phase: data.phase },
            };
            updateControlHeader(editingItem, editingItem.intake_state || {});
          }
          offerInfo.style.display = "block";
          offerDetails.innerHTML =
            `<div>Busena: <span class="pill">PREPARED</span></div>` +
            `<div>Laikas: ${escapeHtml(data.slot_start || "-")} - ${escapeHtml(data.slot_end || "-")}</div>`;
          intakeStatus.textContent = `Pasiulymas paruostas: ${data.slot_start || "?"} - ${data.slot_end || "?"}`;
        } catch (err) {
          intakeStatus.textContent = err.message || "Paruosti nepavyko.";
        }
      });

      document.getElementById("sendOffer").addEventListener("click", async () => {
        if (!editingId) return;
        const intakeStatus = document.getElementById("intakeStatus");
        const offerInfo = document.getElementById("offerInfo");
        const offerDetails = document.getElementById("offerDetails");
        try {
          intakeStatus.textContent = "Siunciamas pasiulymas...";
          const resp = await fetchWithAuth(
            `/api/v1/admin/intake/${encodeURIComponent(editingId)}/send-offer`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: "{}",
            }
          );
          const data = await resp.json();
          updateActionVisibility({ active_offer: { state: "SENT" }, questionnaire: {
            email: { value: document.getElementById("intakeEmail").value.trim() },
            address: { value: document.getElementById("intakeAddress").value.trim() },
            service_type: { value: document.getElementById("intakeServiceType").value.trim() },
          }});
          if (editingItem && data && data.phase) {
            editingItem.intake_state = {
              ...(editingItem.intake_state || {}),
              workflow: { ...((editingItem.intake_state || {}).workflow || {}), phase: data.phase },
            };
            updateControlHeader(editingItem, editingItem.intake_state || {});
          }
          offerInfo.style.display = "block";
          offerDetails.innerHTML =
            `<div>Busena: <span class="pill">SENT</span></div>` +
            `<div>Hold iki: ${escapeHtml(data.hold_expires_at || "-")}</div>` +
            `<div>Bandymas: ${escapeHtml(data.attempt_no || 0)}</div>`;
          intakeStatus.textContent = `Pasiulymas issiustas! Hold iki: ${data.hold_expires_at || "?"}. Bandymas #${data.attempt_no}.`;
        } catch (err) {
          intakeStatus.textContent = err.message || "Siusti nepavyko.";
        }
      });

      window.addEventListener("dashboard-sse-call-created", (e) => {
        const n = (e.detail && e.detail.new_count) || 0;
        showToast(n === 1 ? "1 nauja skambucio uzklausa" : n + " naujos skambuciu uzklausos", "info");
        loadCalls(true);
      });

      initToken();
      if (Auth.isSet() && typeof startDashboardSSE === "function") startDashboardSSE();
      loadCalls(true);
    </script>
  </body>
</html>
