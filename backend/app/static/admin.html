<!DOCTYPE html>
<html lang="lt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="description" content="VejaPRO administravimo panelė – projektai, klientai, skambučiai, kalendorius." />
    <title>VejaPRO – Administravimas</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" />
    <link rel="stylesheet" href="/static/admin-shared.css?v=3.1" />
  </head>
  <body>
    <!-- Mobile hamburger -->
    <button class="hamburger" aria-label="Meniu">&#9776;</button>
    <div class="sidebar-overlay"></div>

    <div class="admin-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <a href="/"><img src="/static/logo.png" alt="VejaPRO" class="logo" /></a>
          <span class="brand">VejaPRO</span>
        </div>
        <nav class="sidebar-nav" id="sidebarNav"></nav>
        <div class="sidebar-footer">V3.1 Admin - Modern Design</div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <div class="page-header">
          <h1>Dashboard</h1>
        </div>

        <div class="content-area">
          <!-- Token Card (collapsible) -->
          <div class="token-card">
            <div class="token-card-header">
              <span>&#128274; Bearer zetonas</span>
              <span id="tokenBadge" class="pill pill-gray">Nenustatytas</span>
            </div>
            <div class="token-card-body">
              <div style="display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:end; margin-bottom:8px;">
                <input id="tokenInput" type="password" class="form-input" placeholder="Iklijuokite JWT zetona" />
                <button class="btn" id="btnGenerate">Generuoti</button>
                <button class="btn btn-secondary" id="btnSaveToken">Issaugoti</button>
              </div>
              <div class="token-display" id="tokenDisplay" style="display:none;"></div>
              <div id="tokenStatus" style="font-size:12px; color:var(--ink-muted);"></div>
            </div>
          </div>

          <!-- Stats Grid -->
          <div id="statsLoading" class="loading-overlay">
            <div class="loading-spinner"></div>
            <span>Kraunama statistika...</span>
          </div>

          <div class="stats-grid" id="statsGrid" style="display:none;">
            <div class="card-stat">
              <div class="stat-label">Projektai</div>
              <div class="stat-value" id="statProjects">—</div>
              <div class="stat-breakdown" id="statProjectBreakdown"></div>
              <a href="/admin/projects" class="stat-link">Atidaryti projektus &rarr;</a>
            </div>
            <div class="card-stat">
              <div class="stat-label">Klientai</div>
              <div class="stat-value" id="statClients">—</div>
              <div class="stat-breakdown" id="statClientsBreakdown"></div>
              <a href="/admin/customers" class="stat-link">Atidaryti klientus &rarr;</a>
            </div>
            <div class="card-stat">
              <div class="stat-label">Skambuciu uzklausos</div>
              <div class="stat-value" id="statCalls">—</div>
              <div class="stat-breakdown" id="statCallsBreakdown"></div>
              <a href="/admin/calls" class="stat-link">Atidaryti skambucius &rarr;</a>
            </div>
            <div class="card-stat">
              <div class="stat-label">Vizitai siandien</div>
              <div class="stat-value" id="statAppointments">—</div>
              <div class="stat-breakdown" id="statAppointmentsBreakdown"></div>
              <a href="/admin/calendar" class="stat-link">Atidaryti kalendoriu &rarr;</a>
            </div>
            <div class="card-stat">
              <div class="stat-label">Audito irasai</div>
              <div class="stat-value" id="statAudit">—</div>
              <a href="/admin/audit" class="stat-link">Atidaryti audita &rarr;</a>
            </div>
          </div>

          <!-- Info -->
          <div class="card" style="margin-top:12px;">
            <div style="font-size:12px; color:var(--ink-muted);">
              Zetonas saugomas tik jusu narsklyneje. Administravimo puslapiai apsaugoti IP leistiniu sarasu ir bearer zetonu.
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="/static/admin-shared.js?v=3.1"></script>
    <script>
      /* Sidebar nav */
      document.getElementById("sidebarNav").innerHTML = sidebarHTML("/admin");

      /* Token management */
      const tokenInput = document.getElementById("tokenInput");
      const tokenStatus = document.getElementById("tokenStatus");
      const tokenBadge = document.getElementById("tokenBadge");

      function updateTokenBadge() {
        if (Auth.isSet()) {
          tokenBadge.textContent = "Aktyvus";
          tokenBadge.className = "pill pill-success";
        } else {
          tokenBadge.textContent = "Nenustatytas";
          tokenBadge.className = "pill pill-gray";
        }
      }

      /* Load saved token */
      if (Auth.isSet()) {
        tokenInput.value = Auth.get();
        tokenStatus.textContent = "Zetonas ikeltas is narsklynes.";
      }
      updateTokenBadge();

      /* Save token */
      document.getElementById("btnSaveToken").addEventListener("click", () => {
        const val = Auth.normalize(tokenInput.value);
        if (val) {
          Auth.set(val);
          tokenInput.value = val;
          tokenStatus.textContent = "Zetonas issaugotas.";
          showToast("Zetonas issaugotas", "success");
        } else {
          Auth.remove();
          tokenStatus.textContent = "Zetonas istrintas.";
        }
        updateTokenBadge();
        setTimeout(loadDashboard, 300);
      });

      /* Generate token — manual only */
      document.getElementById("btnGenerate").addEventListener("click", async () => {
        tokenStatus.textContent = "Generuojamas...";
        try {
          const token = await Auth.generate();
          if (token) {
            tokenInput.value = token;
            tokenStatus.textContent = "Zetonas sugeneruotas ir issaugotas.";
            showToast("Zetonas sugeneruotas", "success");
            updateTokenBadge();
            setTimeout(loadDashboard, 300);
          } else {
            tokenStatus.textContent = "Zetono generavimas nepavyko.";
          }
        } catch (err) {
          tokenStatus.textContent = err.message || "Tinklo klaida.";
          showToast("Nepavyko sugeneruoti zetono", "error");
        }
      });

      /* Dashboard stats */
      async function loadDashboard() {
        if (!Auth.isSet()) {
          document.getElementById("statsLoading").innerHTML = '<span style="color:var(--ink-muted);">Sugeneruokite zetona noredami matyti statistika.</span>';
          document.getElementById("statsGrid").style.display = "none";
          return;
        }

        document.getElementById("statsLoading").innerHTML = '<div class="loading-spinner"></div><span>Kraunama...</span>';
        document.getElementById("statsLoading").style.display = "flex";
        document.getElementById("statsGrid").style.display = "none";

        try {
          const [projResp, callsResp, apptResp, auditResp, custStatsResp] = await Promise.allSettled([
            authFetch("/api/v1/admin/projects?limit=200"),
            authFetch("/api/v1/admin/call-requests?limit=100"),
            authFetch("/api/v1/admin/appointments?limit=100"),
            authFetch("/api/v1/audit-logs?limit=1"),
            authFetch("/api/v1/admin/customers/stats"),
          ]);

          document.getElementById("statsLoading").style.display = "none";
          document.getElementById("statsGrid").style.display = "grid";

          /* Projects */
          if (projResp.status === "fulfilled") {
            const data = await projResp.value.json();
            const items = data.items || [];
            document.getElementById("statProjects").textContent = items.length;
            const counts = {};
            items.forEach(p => { const s = p.status || "—"; counts[s] = (counts[s] || 0) + 1; });
            document.getElementById("statProjectBreakdown").textContent =
              Object.entries(counts).map(([k, v]) => `${k}: ${v}`).join(" · ");

            // Clients count is loaded via /api/v1/admin/customers/stats (derived keys, no raw PII).
          }

          /* Call requests */
          if (callsResp.status === "fulfilled") {
            const data = await callsResp.value.json();
            const items = data.items || [];
            document.getElementById("statCalls").textContent = items.length;
            const newC = items.filter(c => c.status === "NEW" || c.status === "new").length;
            const inP = items.filter(c => c.status === "IN_PROGRESS" || c.status === "in_progress").length;
            const parts = [];
            if (newC) parts.push("Nauji: " + newC);
            if (inP) parts.push("Vykdomi: " + inP);
            document.getElementById("statCallsBreakdown").textContent = parts.join(" · ") || "Visi apdoroti";
          }

          /* Appointments */
          if (apptResp.status === "fulfilled") {
            const data = await apptResp.value.json();
            const items = data.items || [];
            const today = new Date().toISOString().slice(0, 10);
            const todayA = items.filter(a => (a.starts_at || "").slice(0, 10) === today);
            document.getElementById("statAppointments").textContent = todayA.length;
            const confirmed = todayA.filter(a => a.status === "CONFIRMED").length;
            const held = todayA.filter(a => a.status === "HELD").length;
            const parts = [];
            if (confirmed) parts.push("Patvirtinti: " + confirmed);
            if (held) parts.push("Laukia: " + held);
            document.getElementById("statAppointmentsBreakdown").textContent = parts.join(" · ") || "Nera vizitu";
          }

          /* Audit */
          if (auditResp.status === "fulfilled") {
            const data = await auditResp.value.json();
            document.getElementById("statAudit").textContent = data.total || (data.items || []).length || "—";
          }

          /* Customers stats */
          if (custStatsResp.status === "fulfilled") {
            const data = await custStatsResp.value.json();
            document.getElementById("statClients").textContent = data.unique_clients_12m ?? "—";
            document.getElementById("statClientsBreakdown").textContent = "Unikalus per 12 men.";
          }
        } catch (err) {
          if (err instanceof AuthError) return; // Already handled
          document.getElementById("statsLoading").innerHTML = '<span style="color:var(--error);">Nepavyko ikelti statistikos.</span>';
          document.getElementById("statsLoading").style.display = "flex";
          document.getElementById("statsGrid").style.display = "none";
        }
      }

      /* Auto-load */
      if (Auth.isSet()) loadDashboard();
    </script>
  </body>
</html>
