<!doctype html>
<html lang="lt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VejaPRO – Klientu portalas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700;1,9..40,400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/public-shared.css?v=1.2" />
    <style>
      /* ── Client-specific overrides ── */
      @media (max-width: 768px) {
        body { padding-bottom: 0; }
      }

      .vp-nav a.active {
        color: var(--vp-primary);
        background: var(--vp-primary-mist);
      }

      #app { min-height: 60vh; }

      /* ── Badges ── */
      .cl-badge {
        display: inline-flex;
        align-items: center;
        padding: 5px 14px;
        border-radius: var(--vp-radius-full);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .cl-badge-DRAFT { background: rgba(138,138,138,0.12); color: #5a5a5a; }
      .cl-badge-PAID { background: rgba(59,130,246,0.12); color: #2563eb; }
      .cl-badge-SCHEDULED { background: rgba(234,179,8,0.12); color: #a16207; }
      .cl-badge-PENDING_EXPERT { background: rgba(249,115,22,0.12); color: #c2410c; }
      .cl-badge-CERTIFIED { background: rgba(5,150,105,0.12); color: #047857; }
      .cl-badge-ACTIVE { background: rgba(22,163,74,0.15); color: #15803d; }

      /* ── Dashboard hero CTAs ── */
      .cl-hero-ctas {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 32px;
      }
      .cl-hero-ctas .vp-btn {
        padding: 18px 24px;
        font-size: 16px;
        justify-content: center;
      }

      /* ── Section title ── */
      .cl-section-title {
        font-size: 18px;
        font-weight: 700;
        margin: 28px 0 16px;
        color: var(--vp-ink);
      }

      /* ── Action cards ── */
      .cl-action-card {
        background: var(--vp-bg-white);
        border: 1px solid var(--vp-border-light);
        border-left: 4px solid var(--vp-accent);
        border-radius: var(--vp-radius);
        padding: 20px 24px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }
      .cl-action-info { flex: 1; min-width: 200px; }
      .cl-action-info h4 { font-size: 15px; font-weight: 600; margin: 6px 0 4px; }
      .cl-action-info p { font-size: 13px; color: var(--vp-ink-secondary); margin: 0; }

      /* ── Project grid ── */
      .cl-project-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }
      .cl-project-card {
        background: var(--vp-bg-white);
        border: 1px solid var(--vp-border-light);
        border-radius: var(--vp-radius);
        padding: 24px;
        transition: box-shadow 0.3s, border-color 0.3s;
      }
      .cl-project-card:hover {
        border-color: var(--vp-border);
        box-shadow: var(--vp-shadow-md);
      }
      .cl-project-card h3 { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
      .cl-project-card p { color: var(--vp-ink-secondary); font-size: 14px; margin: 8px 0 14px; }

      /* ── Upsell grid ── */
      .cl-upsell-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
      }
      .cl-upsell-card {
        background: var(--vp-bg-white);
        border: 1px solid var(--vp-border-light);
        border-radius: var(--vp-radius);
        padding: 20px;
      }
      .cl-upsell-card h4 { font-size: 15px; font-weight: 700; margin-bottom: 6px; }
      .cl-upsell-price { font-weight: 700; color: var(--vp-primary); font-size: 15px; margin-bottom: 4px; }
      .cl-upsell-card p { font-size: 13px; color: var(--vp-ink-secondary); margin-bottom: 12px; }

      /* ── Status card (project detail) ── */
      .cl-status-card {
        background: var(--vp-bg-white);
        border: 1px solid var(--vp-border-light);
        border-radius: var(--vp-radius-lg);
        padding: 32px;
        margin-bottom: 24px;
      }
      .cl-status-card h3 { font-size: 16px; color: var(--vp-ink-secondary); margin: 12px 0 4px; }
      .cl-status-card .cl-next-step { font-size: 15px; color: var(--vp-ink); margin: 0 0 16px; }

      /* ── Timeline ── */
      .cl-timeline {
        display: flex;
        align-items: flex-start;
        margin: 24px 0;
        gap: 0;
      }
      .cl-timeline-step {
        flex: 1;
        text-align: center;
        position: relative;
        min-width: 80px;
      }
      .cl-timeline-dot {
        width: 32px; height: 32px;
        border-radius: 50%;
        border: 2px dashed var(--vp-border);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        font-size: 13px;
        font-weight: 700;
        background: var(--vp-bg-white);
        position: relative;
        z-index: 2;
        color: var(--vp-ink-muted);
      }
      .cl-timeline-step.done .cl-timeline-dot {
        background: var(--vp-primary);
        border: 2px solid var(--vp-primary);
        color: #fff;
      }
      .cl-timeline-step.current .cl-timeline-dot {
        border: 2px solid var(--vp-primary);
        color: var(--vp-primary);
        box-shadow: 0 0 0 4px rgba(45,122,80,0.15);
      }
      .cl-timeline-label {
        font-size: 11px;
        font-weight: 500;
        color: var(--vp-ink-muted);
      }
      .cl-timeline-step.done .cl-timeline-label,
      .cl-timeline-step.current .cl-timeline-label { color: var(--vp-ink); }
      .cl-timeline-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 16px;
        left: calc(50% + 20px);
        width: calc(100% - 40px);
        height: 2px;
        background: var(--vp-border);
        z-index: 1;
      }
      .cl-timeline-step.done:not(:last-child)::after { background: var(--vp-primary); }

      /* ── Detail grid ── */
      .cl-detail-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 24px;
        margin-top: 24px;
      }
      .cl-detail-card {
        background: var(--vp-bg-white);
        border: 1px solid var(--vp-border-light);
        border-radius: var(--vp-radius);
        padding: 24px;
      }
      .cl-detail-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }

      /* ── Documents ── */
      .cl-doc-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--vp-border-light);
        font-size: 14px;
      }
      .cl-doc-item:last-child { border-bottom: none; }
      .cl-doc-item a { color: var(--vp-primary); font-weight: 500; }
      .cl-doc-item a:hover { text-decoration: underline; }

      /* ── Payments ── */
      .cl-pay-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        font-size: 14px;
        border-bottom: 1px solid var(--vp-border-light);
      }
      .cl-pay-row:last-child { border-bottom: none; }
      .cl-pay-status { font-weight: 600; }
      .cl-pay-status.paid { color: var(--vp-success); }
      .cl-pay-status.pending { color: var(--vp-accent); }

      /* ── Wizard progress ── */
      .cl-wizard-progress {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 32px;
      }
      .cl-wizard-dot {
        width: 36px; height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        border: 2px solid var(--vp-border);
        color: var(--vp-ink-muted);
        background: var(--vp-bg-white);
      }
      .cl-wizard-dot.active {
        border-color: var(--vp-primary);
        color: var(--vp-primary);
        box-shadow: 0 0 0 4px rgba(45,122,80,0.12);
      }
      .cl-wizard-dot.done {
        background: var(--vp-primary);
        border-color: var(--vp-primary);
        color: #fff;
      }
      .cl-wizard-line {
        width: 40px;
        height: 2px;
        background: var(--vp-border);
      }
      .cl-wizard-line.done { background: var(--vp-primary); }

      /* ── Service grid ── */
      .cl-service-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }
      .cl-service-card {
        background: var(--vp-bg-white);
        border: 1px solid var(--vp-border-light);
        border-radius: var(--vp-radius);
        padding: 28px 24px;
        transition: all 0.3s;
      }
      .cl-service-card:hover {
        border-color: var(--vp-border);
        box-shadow: var(--vp-shadow-md);
        transform: translateY(-2px);
      }
      .cl-service-card h3 { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
      .cl-service-price { font-size: 18px; font-weight: 700; color: var(--vp-primary); margin-bottom: 8px; }
      .cl-service-card p { color: var(--vp-ink-secondary); font-size: 14px; margin-bottom: 16px; }

      /* ── Modal ── */
      .cl-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 500;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .cl-modal-overlay.open { display: flex; }
      .cl-modal-content {
        background: var(--vp-bg-white);
        border-radius: var(--vp-radius-lg);
        padding: 32px;
        max-width: 480px;
        width: 100%;
        position: relative;
        box-shadow: var(--vp-shadow-lg);
        max-height: 90vh;
        overflow-y: auto;
      }
      .cl-modal-content h3 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
      .cl-modal-close {
        position: absolute;
        top: 16px; right: 16px;
        width: 36px; height: 36px;
        border-radius: 50%;
        border: none;
        background: var(--vp-bg);
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--vp-ink-secondary);
        transition: background 0.2s;
      }
      .cl-modal-close:hover { background: var(--vp-border-light); }

      /* ── Help ── */
      .cl-help-contacts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 40px;
      }
      .cl-help-contact {
        background: var(--vp-bg-white);
        border: 1px solid var(--vp-border-light);
        border-radius: var(--vp-radius);
        padding: 24px;
        text-align: center;
      }
      .cl-help-icon { font-size: 28px; margin-bottom: 12px; }
      .cl-help-contact h4 { font-size: 14px; font-weight: 500; color: var(--vp-ink-secondary); margin-bottom: 4px; }
      .cl-help-contact p { font-size: 16px; font-weight: 600; }
      .cl-faq-item {
        background: var(--vp-bg-white);
        border: 1px solid var(--vp-border-light);
        border-radius: var(--vp-radius);
        padding: 20px 24px;
        margin-bottom: 12px;
      }
      .cl-faq-item h4 { font-size: 15px; font-weight: 700; margin-bottom: 8px; }
      .cl-faq-item p { font-size: 14px; color: var(--vp-ink-secondary); line-height: 1.6; }

      /* ── Toast ── */
      .cl-toast {
        display: none;
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--vp-primary-deep);
        color: #fff;
        padding: 14px 28px;
        border-radius: var(--vp-radius);
        font-size: 14px;
        font-weight: 500;
        z-index: 600;
        box-shadow: var(--vp-shadow-lg);
        animation: vpFadeUp 0.3s ease;
      }
      .cl-toast.show { display: block; }

      /* ── Responsive ── */
      @media (max-width: 968px) {
        .cl-hero-ctas { grid-template-columns: 1fr; }
        .cl-detail-grid { grid-template-columns: 1fr; }
        .cl-project-grid { grid-template-columns: 1fr; }
      }
      @media (max-width: 768px) {
        .cl-action-card { flex-direction: column; align-items: flex-start; }
        .cl-timeline {
          flex-direction: column;
          gap: 0;
        }
        .cl-timeline-step {
          display: flex;
          align-items: center;
          gap: 12px;
          text-align: left;
          padding: 6px 0;
          min-width: auto;
        }
        .cl-timeline-step:not(:last-child)::after { display: none; }
        .cl-timeline-dot { margin: 0; flex-shrink: 0; width: 28px; height: 28px; font-size: 12px; }
        .cl-status-card { padding: 24px 20px; }
        .cl-modal-content { padding: 24px 20px; margin: 16px; }
      }
      @media (max-width: 480px) {
        .cl-service-grid { grid-template-columns: 1fr; }
        .cl-upsell-grid { grid-template-columns: 1fr; }
        .cl-help-contacts { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <!-- ── Header ── -->
    <header class="vp-header client-header scrolled">
      <div class="vp-container">
        <div class="vp-header-inner">
          <a href="/client" class="vp-logo">
            <img src="/static/logo.png?v=2" alt="VejaPRO" />
          </a>

          <nav class="vp-nav" id="clientNav">
            <a href="#/estimate">Ivertinti kaina</a>
            <a href="#/projects">Mano projektai</a>
            <a href="#/help">Pagalba</a>
          </nav>

          <div class="vp-header-auth">
            <button class="vp-btn vp-btn-outline vp-btn-sm" id="logoutBtn">Atsijungti</button>
          </div>

          <button class="vp-hamburger" id="hamburgerBtn" aria-label="Meniu">
            <span></span><span></span><span></span>
          </button>
        </div>
      </div>
    </header>

    <!-- ── Mobile menu ── -->
    <div class="vp-mobile-menu" id="mobileMenu">
      <a href="#/estimate">Ivertinti kaina</a>
      <a href="#/projects">Mano projektai</a>
      <a href="#/help">Pagalba</a>
      <button class="vp-btn vp-btn-outline" id="mobileLogoutBtn" style="margin-top: 12px;">Atsijungti</button>
    </div>

    <!-- ── Main ── -->
    <main>
      <div class="vp-container" style="padding-top: 96px; padding-bottom: 40px;">
        <div id="app"></div>
      </div>
    </main>

    <!-- ── Footer ── -->
    <footer class="vp-footer">
      <div class="vp-container">
        <div class="vp-footer-bottom" style="border-top: none; padding-top: 0;">
          <span>&copy; 2026 UAB VejaPRO. Visos teises saugomos.</span>
          <a href="mailto:info@vejapro.lt">info@vejapro.lt</a>
        </div>
      </div>
    </footer>

    <!-- ── Service order modal ── -->
    <div class="cl-modal-overlay" id="serviceModal">
      <div class="cl-modal-content">
        <button class="cl-modal-close" id="modalClose">&times;</button>
        <h3 id="modalTitle">Uzsakyti paslauga</h3>
        <form id="modalForm">
          <div id="modalQuestions"></div>
          <div class="vp-form-group" style="margin-top: 16px;">
            <button type="submit" class="vp-btn vp-btn-primary" style="width: 100%;" id="modalSubmitBtn">Pateikti uzsakyma</button>
          </div>
          <div id="modalMsg" class="vp-form-msg" style="margin-top: 12px;"></div>
        </form>
      </div>
    </div>

    <!-- ── Toast ── -->
    <div class="cl-toast" id="toast"></div>

    <!-- ── App script ── -->
    <script>
    (function () {
      'use strict';

      var STATUS_LABELS = {
        DRAFT: 'Juodrastis', PAID: 'Avansas gautas', SCHEDULED: 'Suplanuota',
        PENDING_EXPERT: 'Laukiama eksperto', CERTIFIED: 'Sertifikuota', ACTIVE: 'Aktyvus'
      };
      var STATUS_KEYS = ['DRAFT', 'PAID', 'SCHEDULED', 'PENDING_EXPERT', 'CERTIFIED', 'ACTIVE'];

      // ─── Toast ───────────────────────────────────────────────────────
      var toastTimer = null;
      function showToast(msg) {
        var el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(function () { el.classList.remove('show'); }, 3500);
      }

      // ─── Auth ────────────────────────────────────────────────────────
      var Auth = {
        KEY: 'vejapro_client_session',
        getSession: function () {
          try {
            var raw = sessionStorage.getItem(this.KEY);
            return raw ? JSON.parse(raw) : null;
          } catch (e) { return null; }
        },
        getToken: function () {
          var s = this.getSession();
          if (!s || !s.access_token) return null;
          if (s.expires_at && (Date.now() / 1000) > (s.expires_at - 60)) {
            this.logout();
            return null;
          }
          return s.access_token;
        },
        check: function () {
          if (!this.getToken()) this.logout();
        },
        logout: function () {
          sessionStorage.removeItem(this.KEY);
          localStorage.removeItem('vejapro_client_token');
          localStorage.removeItem('vejapro_client_project');
          window.location.href = '/login';
        }
      };

      // ─── API ─────────────────────────────────────────────────────────
      var API = {
        get: function (url) {
          var token = Auth.getToken();
          if (!token) { Auth.logout(); return Promise.resolve(null); }
          return fetch(url, { headers: { Authorization: 'Bearer ' + token } })
            .then(function (r) {
              if (r.status === 401) { Auth.logout(); return null; }
              return r.ok ? r.json() : null;
            })
            .catch(function () { return null; });
        },
        post: function (url, body, opts) {
          var token = Auth.getToken();
          if (!token) { Auth.logout(); return Promise.resolve(null); }
          var fetchOpts = {
            method: 'POST',
            headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          };
          if (opts && opts.signal) fetchOpts.signal = opts.signal;
          return fetch(url, fetchOpts)
            .then(function (r) {
              if (r.status === 401) { Auth.logout(); return null; }
              return r;
            })
            .catch(function (err) { if (err && err.name === 'AbortError') return Promise.reject(err); return null; });
        },
        put: function (url, body) {
          var token = Auth.getToken();
          if (!token) { Auth.logout(); return Promise.resolve(null); }
          return fetch(url, {
            method: 'PUT',
            headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          })
            .then(function (r) {
              if (r.status === 401) { Auth.logout(); return null; }
              return r;
            })
            .catch(function () { return null; });
        }
      };

      // ─── Session helpers ─────────────────────────────────────────────
      function getSessionEmail() {
        var s = Auth.getSession();
        if (!s || !s.access_token) return '';
        try {
          var p = s.access_token.split('.')[1];
          return JSON.parse(atob(p.replace(/-/g, '+').replace(/_/g, '/'))).email || '';
        } catch (e) { return ''; }
      }

      // ─── Utilities ───────────────────────────────────────────────────
      var U = {
        esc: function (s) {
          if (s == null) return '';
          return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        },
        money: function (v) {
          if (v == null) return '–';
          return new Intl.NumberFormat('lt-LT', { style: 'currency', currency: 'EUR' }).format(v);
        },
        date: function (v) {
          if (!v) return '–';
          var d = new Date(v);
          return isNaN(d) ? '–' : d.toLocaleDateString('lt-LT', { year: 'numeric', month: '2-digit', day: '2-digit' });
        },
        badge: function (status) {
          return '<span class="cl-badge cl-badge-' + this.esc(status) + '">' + this.esc(STATUS_LABELS[status] || status) + '</span>';
        },
        loader: function () {
          return '<div class="vp-loader"><div class="vp-loader-spinner"></div><p>Kraunama...</p></div>';
        },
        empty: function (icon, title, text) {
          return '<div class="vp-empty"><div class="vp-empty-icon">' + icon + '</div>' +
            '<h3>' + this.esc(title) + '</h3><p>' + this.esc(text) + '</p></div>';
        }
      };

      // ─── Router ──────────────────────────────────────────────────────
      var Router = {
        parse: function () {
          var hash = (location.hash || '#/').slice(1) || '/';
          var m = hash.match(/^\/projects\/([^/]+)$/);
          if (m) return { route: 'project-detail', id: m[1] };
          if (hash === '/projects') return { route: 'projects' };
          if (hash === '/estimate') return { route: 'estimate' };
          if (hash === '/services') return { route: 'services' };
          if (hash === '/help') return { route: 'help' };
          return { route: 'dashboard' };
        },
        setActiveNav: function (route) {
          var map = { projects: '#/projects', 'project-detail': '#/projects',
            estimate: '#/estimate', help: '#/help' };
          var href = map[route] || '#/estimate';
          document.querySelectorAll('#clientNav a').forEach(function (a) {
            a.classList.toggle('active', a.getAttribute('href') === href);
          });
        },
        dispatch: function () {
          var r = this.parse();
          this.setActiveNav(r.route);
          var app = document.getElementById('app');
          closeMobileMenu();

          if (r.route === 'dashboard') { location.hash = '#/projects'; return; }
          else if (r.route === 'projects') screenProjects(app);
          else if (r.route === 'project-detail') screenProjectDetail(app, r.id);
          else if (r.route === 'estimate') screenEstimate(app);
          else if (r.route === 'services') screenServices(app);
          else if (r.route === 'help') screenHelp(app);
          else { app.innerHTML = U.empty('&#x1F50D;', 'Nerasta', 'Puslapis nerastas.'); }
        },
        init: function () {
          var self = this;
          window.addEventListener('hashchange', function () { self.dispatch(); });
          if (!location.hash || location.hash === '#') location.hash = '#/estimate';
          self.dispatch();
        }
      };

      // ─── Action handler ──────────────────────────────────────────────
      function handleAction(action, projectId) {
        if (!action) return;
        var key = action.action_key;

        // Navigation actions
        if (key === 'open_project' || key === 'view_quote_status' || key === 'view_schedule') {
          location.hash = '#/projects/' + projectId;
          return;
        }
        if (key === 'order_maintenance') {
          location.hash = '#/services';
          return;
        }
        if (action.href) {
          if (action.href.charAt(0) === '#') location.hash = action.href;
          else window.open(action.href, '_blank', 'noopener');
          return;
        }

        // API actions
        var endpoint = '/api/v1/client/actions/' + key.replace(/_/g, '-');
        var body = { project_id: projectId };
        if (action.payload) {
          Object.keys(action.payload).forEach(function (k) { body[k] = action.payload[k]; });
        }

        API.post(endpoint, body).then(function (res) {
          if (!res) { showToast('Ivyko klaida.'); return; }
          if (res.ok) {
            res.json().then(function (data) {
              if (data.navigate) location.hash = data.navigate;
              else if (data.url) window.open(data.url, '_blank', 'noopener');
              if (data.message) showToast(data.message);
              else if (!data.navigate && !data.url) Router.dispatch();
            });
          } else {
            res.json().then(function (d) { showToast(d.detail || 'Klaida'); }).catch(function () { showToast('Klaida'); });
          }
        });
      }

      function actionBtn(action, projectId, cls) {
        if (!action) return '';
        return '<button type="button" class="vp-btn ' + (cls || 'vp-btn-primary vp-btn-sm') +
          '" data-action=\'' + U.esc(JSON.stringify(action)) +
          '\' data-pid="' + U.esc(projectId) + '">' + U.esc(action.label) + '</button>';
      }

      function bindActions(container) {
        container.querySelectorAll('[data-action][data-pid]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var action = JSON.parse(btn.getAttribute('data-action'));
            var pid = btn.getAttribute('data-pid');
            handleAction(action, pid);
          });
        });
      }

      // ─── Geocoding (atstumas nuo bazes) ─────────────────────────────
      var BASE_COORDS = { lat: 54.095, lng: 24.397 }; // Kruminiai, Varenos raj.

      function haversineKm(lat1, lon1, lat2, lon2) {
        var R = 6371;
        var dLat = (lat2 - lat1) * Math.PI / 180;
        var dLon = (lon2 - lon1) * Math.PI / 180;
        var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      function calcDistance(address, cb) {
        var url = 'https://nominatim.openstreetmap.org/search?q=' +
          encodeURIComponent(address + ', Lietuva') + '&format=json&limit=1&countrycodes=lt';
        fetch(url, {
          headers: { 'User-Agent': 'VejaPRO-Client/1.0 (info@vejapro.lt)' }
        }).then(function (r) { return r.json(); }).then(function (data) {
          if (data && data.length) {
            var km = haversineKm(BASE_COORDS.lat, BASE_COORDS.lng,
              parseFloat(data[0].lat), parseFloat(data[0].lon));
            cb(Math.round(km * 1.3));
          } else { cb(0); }
        }).catch(function () { cb(0); });
      }

      // ─── Screen: Dashboard ───────────────────────────────────────────
      function screenDashboard(app) {
        app.innerHTML = U.loader();
        API.get('/api/v1/client/dashboard').then(function (data) {
          if (!data) { app.innerHTML = U.empty('&#x26A0;', 'Klaida', 'Nepavyko ikrauti duomenu.'); return; }
          var h = '<h2 style="margin-bottom: 20px;">Sveiki!</h2>';

          // Hero CTAs
          var hasProjects = data.projects && data.projects.length > 0;
          h += '<div class="cl-hero-ctas">';
          if (!hasProjects) {
            h += '<a href="#/estimate" class="vp-btn vp-btn-primary">Ivertinti nauja sklypa</a>';
          }
          h += '<a href="#/services" class="vp-btn vp-btn-outline">Uzsakyti papildoma paslauga</a>';
          h += '</div>';

          // Action required
          if (data.action_required && data.action_required.length) {
            h += '<h3 class="cl-section-title">Reikia jusu veiksmo</h3>';
            data.action_required.forEach(function (item) {
              h += '<div class="cl-action-card"><div class="cl-action-info">' +
                U.badge(item.status) +
                '<h4>' + U.esc(item.title) + '</h4>' +
                '<p>' + U.esc(item.next_step_text) + '</p>' +
                '</div>' +
                actionBtn(item.primary_action, item.project_id) +
                '</div>';
            });
          }

          // Projects
          if (data.projects && data.projects.length) {
            h += '<h3 class="cl-section-title">Mano projektai</h3>';
            h += '<div class="cl-project-grid">';
            data.projects.forEach(function (p) {
              h += '<div class="cl-project-card">' +
                '<h3>' + U.esc(p.title) + '</h3>' +
                U.badge(p.status) +
                '<p>' + U.esc(p.summary) + '</p>' +
                '<a href="#/projects/' + U.esc(p.id) + '" class="vp-btn vp-btn-outline vp-btn-sm">Atidaryti projekta</a>' +
                '</div>';
            });
            h += '</div>';
          }

          // Upsell
          if (data.upsell_cards && data.upsell_cards.length) {
            h += '<h3 class="cl-section-title">Papildomos paslaugos</h3>';
            h += '<div class="cl-upsell-grid">';
            data.upsell_cards.forEach(function (c) {
              h += '<div class="cl-upsell-card">' +
                '<h4>' + U.esc(c.title) + '</h4>' +
                '<div class="cl-upsell-price">' + U.esc(c.price_display) + '</div>' +
                '<p>' + U.esc(c.benefit) + '</p>' +
                '<a href="#/services" class="vp-btn vp-btn-ghost vp-btn-sm">Uzsakyti</a>' +
                '</div>';
            });
            h += '</div>';
          }

          // Empty state
          if (!data.action_required?.length && !data.projects?.length) {
            h += U.empty('&#x1F331;', 'Projektu dar nera', 'Pradekite nuo ivertinimo — spauskite "Ivertinti nauja sklypa".');
          }

          app.innerHTML = h;
          bindActions(app);
        });
      }

      // ─── Screen: Projects ────────────────────────────────────────────
      function screenProjects(app) {
        app.innerHTML = U.loader();
        API.get('/api/v1/client/dashboard').then(function (data) {
          if (!data) { app.innerHTML = U.empty('&#x26A0;', 'Klaida', 'Nepavyko ikrauti.'); return; }
          var hasProjects = data.projects && data.projects.length > 0;
          var h = '<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px;">';
          h += '<h2 style="margin:0;">Mano projektai</h2>';
          if (!hasProjects) {
            h += '<a href="#/estimate" class="vp-btn vp-btn-primary vp-btn-sm">+ Naujas projektas</a>';
          }
          h += '</div>';
          if (data.projects && data.projects.length) {
            h += '<div class="cl-project-grid">';
            data.projects.forEach(function (p) {
              h += '<div class="cl-project-card">' +
                '<h3>' + U.esc(p.title) + '</h3>' +
                U.badge(p.status) +
                '<p>' + U.esc(p.summary) + '</p>' +
                '<a href="#/projects/' + U.esc(p.id) + '" class="vp-btn vp-btn-outline vp-btn-sm">Atidaryti</a>' +
                '</div>';
            });
            h += '</div>';
          } else {
            h += U.empty('&#x1F4C2;', 'Projektu nera', 'Pradekite nuo ivertinimo.');
            h += '<div style="text-align:center; margin-top:16px;"><a href="#/estimate" class="vp-btn vp-btn-primary">Ivertinti nauja sklypa</a></div>';
          }
          app.innerHTML = h;
        });
      }

      // ─── Screen: Project Detail ──────────────────────────────────────
      function screenProjectDetail(app, id) {
        app.innerHTML = U.loader();
        API.get('/api/v1/client/projects/' + encodeURIComponent(id) + '/view').then(function (data) {
          if (!data) { app.innerHTML = U.empty('&#x1F50D;', 'Nerasta', 'Projektas nerastas arba neturite prieigos.'); return; }
          var h = '<a href="#/projects" style="display:inline-flex;align-items:center;gap:6px;font-size:14px;color:var(--vp-ink-secondary);margin-bottom:16px;">&larr; Grizti i projektus</a>';

          // Status card
          h += '<div class="cl-status-card">';
          h += U.badge(data.status);
          h += '<h3>' + U.esc(data.status_hint) + '</h3>';
          h += '<p class="cl-next-step"><strong>Kitas zingsnis:</strong> ' + U.esc(data.next_step_text) + '</p>';
          if (data.primary_action) {
            h += actionBtn(data.primary_action, id, 'vp-btn-primary');
          }
          if (data.secondary_actions && data.secondary_actions.length) {
            data.secondary_actions.forEach(function (sa) {
              h += ' ' + actionBtn(sa, id, 'vp-btn-outline');
            });
          }
          h += '</div>';

          // Timeline
          if (data.timeline && data.timeline.length) {
            h += '<div class="cl-timeline">';
            data.timeline.forEach(function (step, i) {
              var cls = step.done ? 'done' : (step.current ? 'current' : '');
              h += '<div class="cl-timeline-step ' + cls + '">' +
                '<div class="cl-timeline-dot">' + (i + 1) + '</div>' +
                '<span class="cl-timeline-label">' + U.esc(step.label) + '</span>' +
                '</div>';
            });
            h += '</div>';
          }

          // Estimate info card
          if (data.estimate_info) {
            var ei = data.estimate_info;
            h += '<div class="cl-detail-card" style="margin-top:24px;">';
            h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">';
            h += '<h3 style="margin:0;">Jusu uzklausos duomenys</h3>';
            if (data.editable) {
              h += '<button type="button" class="vp-btn vp-btn-outline vp-btn-sm" id="editDraftBtn">Redaguoti</button>';
            }
            h += '</div>';
            h += '<div class="cl-pay-row"><span>Paslauga</span><span>' + U.esc(ei.service_label) + ' (' + U.esc(ei.method_label) + ')</span></div>';
            h += '<div class="cl-pay-row"><span>Plotas</span><span>' + U.esc(ei.area_m2) + ' m\u00B2</span></div>';
            h += '<div class="cl-pay-row"><span>Adresas</span><span>' + U.esc(ei.address) + '</span></div>';
            if (ei.km_one_way) {
              h += '<div class="cl-pay-row"><span>Atstumas</span><span>' + U.esc(ei.km_one_way) + ' km</span></div>';
            }
            h += '<div class="cl-pay-row"><span>Telefonas</span><span>' + U.esc(ei.phone) + '</span></div>';
            if (ei.addons_selected && ei.addons_selected.length) {
              h += '<div class="cl-pay-row"><span>Priedai</span><span>' + U.esc(ei.addons_selected.join(', ')) + '</span></div>';
            }
            if (ei.preferred_slot) {
              h += '<div class="cl-pay-row"><span>Pageidaujamas vizitas</span><span>' + U.esc(ei.preferred_slot) + '</span></div>';
            }
            h += '<div class="cl-pay-row" style="font-weight:700;"><span>Orientacine kaina</span><span>' + U.money(ei.total_eur) + '</span></div>';
            if (ei.submitted_at) {
              h += '<div class="cl-pay-row"><span>Pateikta</span><span>' + U.date(ei.submitted_at) + '</span></div>';
            }
            if (ei.extras) {
              h += '<div class="cl-pay-row"><span>Pastabos</span><span style="max-width:300px;text-align:right;">' + U.esc(ei.extras) + '</span></div>';
            }
            h += '</div>';
          }

          // Visits info
          if (data.visits && data.visits.length) {
            h += '<div class="cl-detail-card" style="margin-top:24px;">';
            h += '<h3>Vizitai</h3>';
            data.visits.forEach(function (v) {
              var typeLabel = v.visit_type === 'SECONDARY' ? 'Antrasis vizitas' : 'Pirmasis vizitas';
              var statusLabel = v.status === 'CONFIRMED' ? 'Patvirtintas' : (v.status === 'HELD' ? 'Laikinas' : v.status);
              h += '<div class="cl-pay-row"><span>' + U.esc(typeLabel) + '</span>';
              h += '<span>' + U.esc(statusLabel);
              if (v.label) h += ' — ' + U.esc(v.label);
              h += '</span></div>';
            });
            h += '</div>';
          }

          // Secondary slot picker or saved preference
          if (data.can_request_secondary_slot) {
            h += '<div class="cl-detail-card" style="margin-top:24px;" id="secondarySlotCard">';
            h += '<h3>Antrojo vizito laikas</h3>';
            if (data.preferred_secondary_slot) {
              h += '<p style="font-size:14px;">Pageidaujamas laikas: <strong>' + U.esc(data.preferred_secondary_slot) + '</strong></p>';
              h += '<p style="font-size:13px;color:var(--vp-ink-secondary);margin-top:8px;">Administratorius patvirtins arba pasiulys kita laika.</p>';
            } else {
              h += '<div id="secondarySlotContent">';
              h += '<p style="font-size:13px;color:var(--vp-ink-muted);">Kraunami laisvi laikai...</p>';
              h += '</div>';
            }
            h += '</div>';
          }

          // Detail grid: Documents + Payments
          var hasDocs = data.documents && data.documents.length;
          var hasPay = data.payments_summary;
          if (hasDocs || hasPay) {
            h += '<div class="cl-detail-grid">';

            // Documents
            if (hasDocs) {
              h += '<div class="cl-detail-card"><h3>Dokumentai</h3>';
              data.documents.forEach(function (doc) {
                h += '<div class="cl-doc-item"><span>' + U.esc(doc.label) + '</span>';
                if (doc.url) {
                  h += '<a href="' + U.esc(doc.url) + '" target="_blank" rel="noreferrer">Atidaryti</a>';
                } else {
                  h += '<span style="color:var(--vp-ink-muted);font-size:13px;">Neprieinamas</span>';
                }
                h += '</div>';
              });
              h += '</div>';
            }

            // Payments
            if (hasPay) {
              var ps = data.payments_summary;
              h += '<div class="cl-detail-card"><h3>Mokejimai</h3>';
              h += '<div class="cl-pay-row"><span>Depozitas</span><span class="cl-pay-status ' +
                (ps.deposit_state === 'PAID' ? 'paid' : 'pending') + '">' +
                U.esc(ps.deposit_state === 'PAID' ? 'Apmoketas' : 'Laukiama') + '</span></div>';
              if (ps.final_state) {
                h += '<div class="cl-pay-row"><span>Galutinis</span><span class="cl-pay-status ' +
                  (ps.final_state === 'PAID' ? 'paid' : 'pending') + '">' +
                  U.esc(ps.final_state === 'PAID' ? 'Apmoketas' : 'Laukiama') + '</span></div>';
              }
              h += '<p style="font-size:13px;color:var(--vp-ink-secondary);margin-top:12px;">' + U.esc(ps.next_text) + '</p>';
              h += '</div>';
            }

            h += '</div>'; // cl-detail-grid
          }

          app.innerHTML = h;
          bindActions(app);

          // Load secondary slot picker async
          if (data.can_request_secondary_slot && !data.preferred_secondary_slot) {
            var slotContent = document.getElementById('secondarySlotContent');
            if (slotContent) {
              API.get('/api/v1/client/schedule/available-slots').then(function (slotsData) {
                if (!slotsData || !slotsData.slots || !slotsData.slots.length) {
                  slotContent.innerHTML = '<p style="font-size:13px;color:var(--vp-ink-muted);">Siuo metu laisvu laiku nera. Susisiekite su mumis.</p>';
                  return;
                }
                var sh = '<p style="font-size:13px;color:var(--vp-ink-secondary);margin-bottom:16px;">Pasirinkite pageidaujama laika antrajam vizitui:</p>';
                slotsData.slots.forEach(function (slot) {
                  sh += '<label style="display:block;margin-bottom:8px;cursor:pointer;">';
                  sh += '<input type="radio" name="secondarySlot" value="' + U.esc(slot.starts_at) + '" /> ';
                  sh += U.esc(slot.label) + '</label>';
                });
                sh += '<label style="display:block;margin-bottom:8px;cursor:pointer;">';
                sh += '<input type="radio" name="secondarySlot" value="" checked /> ';
                sh += 'Kitas laikas (susitarsime)</label>';
                sh += '<button type="button" class="vp-btn vp-btn-primary vp-btn-sm" id="submitSecondarySlot" style="margin-top:12px;">Issaugoti pageidavima</button>';
                sh += '<div id="secondarySlotMsg" style="margin-top:8px;"></div>';
                slotContent.innerHTML = sh;

                document.getElementById('submitSecondarySlot').addEventListener('click', function () {
                  var btn = this;
                  var radio = document.querySelector('input[name="secondarySlot"]:checked');
                  var slotVal = radio ? radio.value : '';
                  if (!slotVal) {
                    showToast('Pasirinkite pageidaujama laika arba "Kitas laikas".');
                    return;
                  }
                  btn.disabled = true; btn.textContent = 'Saugoma...';
                  API.post('/api/v1/client/projects/' + encodeURIComponent(id) + '/preferred-secondary-slot', {
                    preferred_slot_start: slotVal
                  }).then(function (res) {
                    if (res && res.ok) {
                      res.json().then(function (result) {
                        showToast(result.message || 'Issaugota!');
                        screenProjectDetail(document.getElementById('app'), id);
                      });
                    } else {
                      btn.disabled = false; btn.textContent = 'Issaugoti pageidavima';
                      if (res) {
                        res.json().then(function (d) { showToast(d.detail || 'Nepavyko issaugoti.'); }).catch(function () { showToast('Nepavyko issaugoti.'); });
                      } else {
                        showToast('Nepavyko issaugoti.');
                      }
                    }
                  });
                });
              });
            }
          }

          // Edit draft modal
          if (data.editable && data.estimate_info) {
            var editBtn = document.getElementById('editDraftBtn');
            if (editBtn) {
              editBtn.addEventListener('click', function () {
                openDraftEditModal(id, data.estimate_info, data);
              });
            }
          }
        });
      }

      function openDraftEditModal(projectId, ei, viewData) {
        var overlay = document.getElementById('serviceModal');
        document.getElementById('modalTitle').textContent = 'Redaguoti uzklausos duomenis';
        var qDiv = document.getElementById('modalQuestions');
        var mh = '';
        mh += '<div class="vp-form-group"><label class="vp-form-label">Telefonas</label>';
        mh += '<input type="tel" name="draft_phone" class="vp-form-input" value="' + U.esc(ei.phone) + '" /></div>';
        mh += '<div class="vp-form-group"><label class="vp-form-label">Adresas</label>';
        mh += '<input type="text" name="draft_address" class="vp-form-input" value="' + U.esc(ei.address) + '" /></div>';
        mh += '<div class="vp-form-group"><label class="vp-form-label">Plotas (m\u00B2)</label>';
        mh += '<input type="number" name="draft_area" class="vp-form-input" value="' + U.esc(ei.area_m2) + '" min="1" max="100000" /></div>';
        mh += '<div class="vp-form-group"><label class="vp-form-label">Pastabos</label>';
        mh += '<textarea name="draft_notes" class="vp-form-textarea">' + U.esc(ei.extras || '') + '</textarea></div>';
        qDiv.innerHTML = mh;
        var msg = document.getElementById('modalMsg');
        msg.className = 'vp-form-msg'; msg.textContent = '';
        var submitBtn = document.getElementById('modalSubmitBtn');
        submitBtn.disabled = false; submitBtn.textContent = 'Issaugoti';
        overlay.classList.add('open');

        // Override form submit for draft update
        var form = document.getElementById('modalForm');
        var handler = function (e) {
          e.preventDefault();
          submitBtn.disabled = true; submitBtn.textContent = 'Saugoma...';
          var body = {};
          var phoneVal = (document.querySelector('[name="draft_phone"]').value || '').trim();
          var addrVal = (document.querySelector('[name="draft_address"]').value || '').trim();
          var areaVal = parseFloat(document.querySelector('[name="draft_area"]').value);
          var notesVal = (document.querySelector('[name="draft_notes"]').value || '').trim();
          if (phoneVal && phoneVal !== ei.phone) body.phone = phoneVal;
          if (addrVal && addrVal !== ei.address) body.address = addrVal;
          if (areaVal && areaVal > 0 && areaVal !== ei.area_m2) body.area_m2 = areaVal;
          if (notesVal !== (ei.extras || '')) body.user_notes = notesVal;
          if (Object.keys(body).length === 0) {
            overlay.classList.remove('open');
            form.removeEventListener('submit', handler);
            return;
          }
          API.put('/api/v1/client/projects/' + encodeURIComponent(projectId) + '/draft', body).then(function (res) {
            if (res && res.ok) {
              res.json().then(function (result) {
                msg.textContent = result.message || 'Issaugota!';
                msg.className = 'vp-form-msg success';
                if (result.total_eur !== null && result.total_eur !== undefined) {
                  msg.textContent += ' Nauja kaina: ' + U.money(result.total_eur);
                }
                submitBtn.textContent = 'Issaugota';
                setTimeout(function () {
                  overlay.classList.remove('open');
                  form.removeEventListener('submit', handler);
                  screenProjectDetail(document.getElementById('app'), projectId);
                }, 1500);
              });
            } else {
              msg.textContent = 'Nepavyko issaugoti pakeitimu.';
              msg.className = 'vp-form-msg error';
              submitBtn.disabled = false; submitBtn.textContent = 'Issaugoti';
            }
          });
        };
        form.addEventListener('submit', handler);
      }

      // ─── Screen: Estimate (4-step wizard, V2 pricing) ──────────────
      var est = null;

      function screenEstimate(app) {
        app.innerHTML = U.loader();
        // Check if user already has projects — redirect if so
        API.get('/api/v1/client/dashboard').then(function (dash) {
          if (dash && dash.projects && dash.projects.length > 0) {
            showToast('Jus jau turite pateikta uzklausa.', 'info');
            location.hash = '#/projects';
            return;
          }
          est = { step: 1, rules: null, rulesVersion: null, service: '', method: '', area: 0, km: 0,
                  phone: '', address: '',
                  photos: [], notes: '', extras: [], selectedAddons: [], priceResult: null,
                  isPricing: false, priceAbort: null, priceSeq: 0, availableSlots: [], selectedSlot: null };
          API.get('/api/v1/client/estimate/rules').then(function (rules) {
            if (!rules) { app.innerHTML = U.empty('&#x26A0;', 'Nepavyko', 'Nepavyko ikrauti kainu taisykliu.'); return; }
            est.rules = rules;
            est.rulesVersion = rules.rules_version || null;
            renderEstStep(app);
          });
        });
      }

      function wizardDots(step) {
        var h = '<div class="cl-wizard-progress">';
        for (var i = 1; i <= 4; i++) {
          var cls = i < step ? 'done' : (i === step ? 'active' : '');
          h += '<div class="cl-wizard-dot ' + cls + '">' + i + '</div>';
          if (i < 4) h += '<div class="cl-wizard-line ' + (i < step ? 'done' : '') + '"></div>';
        }
        return h + '</div>';
      }

      function renderEstStep(app) {
        var s = est;
        var h = '<h2 style="margin-bottom: 8px;">Orientacine kaina</h2>';
        h += '<p style="color:var(--vp-ink-secondary);margin-bottom:24px;">' + U.esc(s.rules.disclaimer) + '</p>';
        h += wizardDots(s.step);

        if (s.step === 1) {
          // Step 1: Service + method
          var services = s.rules.services || {};
          var svcKeys = Object.keys(services);
          h += '<div class="cl-status-card">';
          h += '<h3 style="color:var(--vp-ink);margin:0 0 16px;">Pasirinkite paslauga</h3>';
          svcKeys.forEach(function (sk) {
            var svc = services[sk];
            h += '<label style="display:block;margin-bottom:8px;cursor:pointer;">';
            h += '<input type="radio" name="estService" value="' + U.esc(sk) + '"' + (s.service === sk ? ' checked' : '') + ' /> ';
            h += U.esc(svc.label) + '</label>';
          });
          h += '<div id="estMethodsWrap" style="margin-top:16px;"></div>';
          h += '<button type="button" class="vp-btn vp-btn-primary" id="estNext1" style="margin-top:16px;">Toliau</button>';
          h += '</div>';
        } else if (s.step === 2) {
          // Step 2: Area + address
          h += '<div class="cl-status-card">';
          h += '<h3 style="color:var(--vp-ink);margin:0 0 16px;">Objekto informacija</h3>';
          h += '<div class="vp-form-group"><label class="vp-form-label">Sklypo plotas (m&sup2;) <span class="required">*</span></label>';
          h += '<input type="number" id="estArea" class="vp-form-input" placeholder="pvz. 500" min="1" max="100000" step="1" value="' + (s.area || '') + '" required /></div>';
          h += '<div class="vp-form-group"><label class="vp-form-label">Objekto adresas <span class="required">*</span></label>';
          h += '<input type="text" id="estAddress" class="vp-form-input" placeholder="Gatve, miestas" value="' + U.esc(s.address) + '" required /></div>';
          h += '<div id="estDistanceWrap" style="margin-top:8px;">';
          if (s.km > 0) {
            h += '<div class="vp-form-group"><label class="vp-form-label">Atstumas nuo bazes (Kruminiai, Varenos raj.)</label>';
            h += '<div style="display:flex;align-items:center;gap:8px;">';
            h += '<input type="number" id="estKm" class="vp-form-input" style="max-width:120px;" value="' + s.km + '" min="0" max="1000" />';
            h += '<span style="font-size:14px;color:var(--vp-ink-secondary);">km (viena kryptimi)</span>';
            h += '</div></div>';
          }
          h += '</div>';
          h += '<div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;">';
          h += '<button type="button" class="vp-btn vp-btn-outline" id="estBack2">Atgal</button>';
          h += '<button type="button" class="vp-btn vp-btn-primary" id="estNext2">Toliau</button>';
          h += '</div></div>';
        } else if (s.step === 3) {
          // Step 3: Contacts
          h += '<div class="cl-status-card">';
          h += '<h3 style="color:var(--vp-ink);margin:0 0 16px;">Kontaktine informacija</h3>';
          h += '<div class="vp-form-group"><label class="vp-form-label">Telefonas <span class="required">*</span></label>';
          h += '<input type="tel" id="estPhone" class="vp-form-input" placeholder="+370..." value="' + U.esc(s.phone) + '" required /></div>';
          h += '<div class="vp-form-group"><label class="vp-form-label">Pastabos (neprivaloma)</label>';
          h += '<textarea id="estNotes" class="vp-form-textarea" placeholder="Pvz. pageidavimai, speciali informacija...">' + U.esc(s.notes) + '</textarea></div>';
          h += '<div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;">';
          h += '<button type="button" class="vp-btn vp-btn-outline" id="estBack3">Atgal</button>';
          h += '<button type="button" class="vp-btn vp-btn-primary" id="estNext3">Skaiciuoti kaina</button>';
          h += '</div></div>';
        } else if (s.step === 4) {
          if (s.priceResult) {
            // Show price breakdown (id for live update when extras change)
            var pr = s.priceResult;
            h += '<div id="estPriceCard" class="cl-status-card">';
            h += '<h3 style="color:var(--vp-ink);margin:0 0 16px;">Orientacine kaina</h3>';
            if (pr.breakdown && pr.breakdown.length) {
              pr.breakdown.forEach(function (item) {
                h += '<div class="cl-pay-row"><span>' + U.esc(item.label) + '</span><span>' + U.money(item.amount) + '</span></div>';
              });
            }
            h += '<div class="cl-pay-row" style="font-weight:700;border-top:2px solid var(--vp-border);padding-top:12px;margin-top:8px;">';
            h += '<span>Is viso</span><span>' + U.money(pr.total_eur) + '</span></div>';
            h += '<p style="margin-top:16px;font-size:13px;color:var(--vp-ink-secondary);">' + U.esc(s.rules.disclaimer) + '</p>';
            h += '</div>';
            h += '<div class="cl-status-card" style="margin-top:16px;">';
            h += '<h3 style="color:var(--vp-ink);margin:0 0 12px;">Papildomos paslaugos</h3>';
            h += '<p style="font-size:13px;color:var(--vp-ink-secondary);margin-bottom:16px;">Pazymekite, jei norite gauti pasiulyma:</p>';
            var extrasList = [
              { key: 'mole_net', label: 'Tinklas nuo kurmiu', desc: '+1.50 EUR/m\u00B2' },
              { key: 'fertilizing', label: 'Tresavimas', desc: 'Kaina pagal plota' },
              { key: 'robot_mower', label: 'Vejos roboto instaliavimas', desc: 'Individualiai' },
              { key: 'lighting', label: 'Apsvietimas', desc: 'Individualiai' }
            ];
            extrasList.forEach(function (ex) {
              var checked = s.extras.indexOf(ex.key) !== -1 ? ' checked' : '';
              h += '<label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;cursor:pointer;">';
              h += '<input type="checkbox" name="estExtra" value="' + U.esc(ex.key) + '"' + checked + ' />';
              h += '<span>' + U.esc(ex.label) + ' <span style="color:var(--vp-ink-muted);font-size:13px;">(' + U.esc(ex.desc) + ')</span></span>';
              h += '</label>';
            });
            h += '<p style="margin-top:12px;font-size:12px;color:var(--vp-ink-muted);">Į orientacinę sumą įeina tik „Tinklas nuo kurmių“. Kitos paslaugos — individualiai pagal pasiūlymą.</p>';
            h += '</div>';
            // Slot picker section (loaded async)
            h += '<div id="estSlotSection" style="margin-top:16px;"></div>';
            h += '<div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;">';
            h += '<button type="button" class="vp-btn vp-btn-outline" id="estBack4">Atgal</button>';
            h += '<button type="button" class="vp-btn vp-btn-primary" id="estSubmit"' + (s.isPricing ? ' disabled' : '') + '>Pateikti uzklausa</button>';
            h += '</div>';
          } else {
            // Success confirmation
            h += '<div class="cl-status-card" style="text-align:center;">';
            h += '<div style="font-size:48px;margin-bottom:16px;">&#x2705;</div>';
            h += '<h3 style="color:var(--vp-ink);margin:0 0 8px;">Uzklausa pateikta!</h3>';
            h += '<p style="color:var(--vp-ink-secondary);">Uzklausa pateikta. Netrukus susisieksime.</p>';
            h += '<a href="#/projects" class="vp-btn vp-btn-primary" style="margin-top:20px;">Mano projektai</a>';
            h += '</div>';
          }
        }

        app.innerHTML = h;

        // Step 1: service/method selection
        if (s.step === 1) {
          function renderMethods(svcKey) {
            var wrap = document.getElementById('estMethodsWrap');
            if (!wrap) return;
            var svc = (s.rules.services || {})[svcKey];
            if (!svc || !svc.methods) { wrap.innerHTML = ''; return; }
            var mh = '<p style="font-weight:600;margin-bottom:8px;">Metodas:</p>';
            var mKeys = Object.keys(svc.methods);
            mKeys.forEach(function (mk) {
              var m = svc.methods[mk];
              mh += '<label style="display:block;margin-bottom:6px;cursor:pointer;">';
              mh += '<input type="radio" name="estMethod" value="' + U.esc(mk) + '"' + (s.method === mk ? ' checked' : '') + ' /> ';
              mh += U.esc(m.label) + '</label>';
            });
            wrap.innerHTML = mh;
          }
          app.querySelectorAll('input[name="estService"]').forEach(function (r) {
            r.addEventListener('change', function () {
              s.service = r.value;
              s.method = '';
              renderMethods(r.value);
            });
          });
          if (s.service) renderMethods(s.service);
          document.getElementById('estNext1').addEventListener('click', function () {
            var svcRadio = app.querySelector('input[name="estService"]:checked');
            var mRadio = app.querySelector('input[name="estMethod"]:checked');
            if (!svcRadio) { showToast('Pasirinkite paslauga.'); return; }
            if (!mRadio) { showToast('Pasirinkite metoda.'); return; }
            s.service = svcRadio.value;
            s.method = mRadio.value;
            s.step = 2;
            renderEstStep(app);
          });
        }

        // Step 2: area + location + distance
        if (s.step === 2) {
          var addrInput = document.getElementById('estAddress');
          var distWrap = document.getElementById('estDistanceWrap');
          var distTimer = null;

          function showDistanceField(km) {
            s.km = km;
            var dh = '<div class="vp-form-group"><label class="vp-form-label">Atstumas nuo bazes (Kruminiai, Varenos raj.)</label>';
            dh += '<div style="display:flex;align-items:center;gap:8px;">';
            dh += '<input type="number" id="estKm" class="vp-form-input" style="max-width:120px;" value="' + km + '" min="0" max="1000" />';
            dh += '<span style="font-size:14px;color:var(--vp-ink-secondary);">km (viena kryptimi)</span>';
            dh += '</div></div>';
            distWrap.innerHTML = dh;
          }

          function recalcDist() {
            var addr = (addrInput.value || '').trim();
            if (addr.length < 3) return;
            distWrap.innerHTML = '<p style="font-size:13px;color:var(--vp-ink-muted);">Skaiciuojamas atstumas...</p>';
            calcDistance(addr, function (km) {
              if (km > 0) {
                showDistanceField(km);
              } else {
                showDistanceField(s.km || 0);
                showToast('Nepavyko nustatyti atstumo. Iveskite rankiniu budu.');
              }
            });
          }

          addrInput.addEventListener('blur', function () {
            clearTimeout(distTimer);
            distTimer = setTimeout(recalcDist, 300);
          });

          document.getElementById('estBack2').addEventListener('click', function () { s.step = 1; renderEstStep(app); });
          document.getElementById('estNext2').addEventListener('click', function () {
            var area = parseFloat(document.getElementById('estArea').value);
            if (!area || area <= 0 || area > 100000) { showToast('Iveskite tinkama plota (1-100000 m2).'); return; }
            var address = (addrInput.value || '').trim();
            if (!address || address.length < 3) { showToast('Iveskite objekto adresa.'); return; }
            s.area = area;
            s.address = address;
            var kmInput = document.getElementById('estKm');
            if (kmInput) s.km = parseInt(kmInput.value, 10) || 0;
            if (s.km <= 0) {
              // Auto-calculate if not yet done
              var btn = document.getElementById('estNext2');
              btn.disabled = true; btn.textContent = 'Skaiciuojamas atstumas...';
              calcDistance(address, function (km) {
                s.km = km;
                if (km > 0) {
                  showDistanceField(km);
                  btn.disabled = false; btn.textContent = 'Toliau';
                  showToast('Atstumas: ' + km + ' km. Patikrinkite ir spauskite "Toliau".');
                } else {
                  showDistanceField(0);
                  btn.disabled = false; btn.textContent = 'Toliau';
                  showToast('Nepavyko nustatyti atstumo. Iveskite rankiniu budu.');
                }
              });
              return;
            }
            s.step = 3;
            renderEstStep(app);
          });
        }

        // Step 3: contacts -> compute price (distance already calculated in step 2)
        if (s.step === 3) {
          document.getElementById('estBack3').addEventListener('click', function () { s.step = 2; renderEstStep(app); });
          document.getElementById('estNext3').addEventListener('click', function () {
            var phone = (document.getElementById('estPhone').value || '').trim();
            var notes = (document.getElementById('estNotes').value || '').trim();
            if (!phone || phone.length < 3) { showToast('Iveskite telefono numeri.'); return; }
            s.phone = phone; s.notes = notes;
            var btn = document.getElementById('estNext3');
            btn.disabled = true; btn.textContent = 'Skaiciuojama...';
            API.post('/api/v1/client/estimate/price', {
              rules_version: s.rulesVersion || s.rules.rules_version,
              service: s.service, method: s.method,
              area_m2: s.area, km_one_way: s.km, addons_selected: []
            }).then(function (res) {
              if (res && res.ok) {
                res.json().then(function (data) {
                  s.priceResult = data;
                  s.step = 4;
                  renderEstStep(app);
                });
              } else if (res && res.status === 409) {
                API.get('/api/v1/client/estimate/rules').then(function (r) {
                  if (r && r.rules_version) {
                    s.rules = r; s.rulesVersion = r.rules_version;
                    showToast('Kainu taisykles atnaujintos. Perskaiciuojama.');
                    API.post('/api/v1/client/estimate/price', {
                      rules_version: s.rulesVersion,
                      service: s.service, method: s.method,
                      area_m2: s.area, km_one_way: s.km, addons_selected: []
                    }).then(function (retryRes) {
                      if (retryRes && retryRes.ok) {
                        retryRes.json().then(function (data) {
                          s.priceResult = data; s.step = 4; renderEstStep(app);
                        });
                      }
                      btn.disabled = false; btn.textContent = 'Skaiciuoti kaina';
                    });
                  } else {
                    btn.disabled = false; btn.textContent = 'Skaiciuoti kaina';
                    showToast('Kainu taisykles pasikete. Pradekite is naujo.');
                  }
                });
              } else {
                btn.disabled = false; btn.textContent = 'Skaiciuoti kaina';
                showToast('Nepavyko apskaiciuoti kainos.');
              }
            });
          });
        }

        // Step 4: price shown -> submit
        if (s.step === 4 && s.priceResult) {
          // Fetch available slots
          (function () {
            var slotSection = document.getElementById('estSlotSection');
            if (!slotSection) return;
            slotSection.innerHTML = '<p style="font-size:13px;color:var(--vp-ink-muted);">Kraunami laisvi laikai...</p>';
            API.get('/api/v1/client/schedule/available-slots').then(function (data) {
              if (!data || !data.slots || !data.slots.length) {
                slotSection.innerHTML = '';
                s.availableSlots = [];
                return;
              }
              s.availableSlots = data.slots;
              var sh = '<div class="cl-status-card" style="margin-top:0;">';
              sh += '<h3 style="color:var(--vp-ink);margin:0 0 12px;">Pirmo vizito laikas</h3>';
              sh += '<p style="font-size:13px;color:var(--vp-ink-secondary);margin-bottom:16px;">Pasirinkite pageidaujama laika:</p>';
              data.slots.forEach(function (slot, i) {
                var checked = s.selectedSlot === slot.starts_at ? ' checked' : '';
                sh += '<label style="display:block;margin-bottom:8px;cursor:pointer;">';
                sh += '<input type="radio" name="estSlot" value="' + U.esc(slot.starts_at) + '"' + checked + ' /> ';
                sh += U.esc(slot.label) + '</label>';
              });
              sh += '<label style="display:block;margin-bottom:8px;cursor:pointer;">';
              sh += '<input type="radio" name="estSlot" value=""' + (s.selectedSlot === null || s.selectedSlot === '' ? ' checked' : '') + ' /> ';
              sh += 'Kitas laikas (susitarsime)</label>';
              sh += '</div>';
              slotSection.innerHTML = sh;
            });
          })();

          (function () {
            var priceCard = document.getElementById('estPriceCard');
            var submitBtn = document.getElementById('estSubmit');
            if (!priceCard || !submitBtn) return;
            function buildPriceCardHtml(pr, loading) {
              var html = '<h3 style="color:var(--vp-ink);margin:0 0 16px;">Orientacine kaina</h3>';
              if (loading) {
                html += '<p style="color:var(--vp-ink-muted);">Skaičiuojama...</p>';
                html += '<div class="cl-pay-row" style="font-weight:700;border-top:2px solid var(--vp-border);padding-top:12px;margin-top:8px;">';
                html += '<span>Iš viso</span><span>—</span></div>';
              } else if (pr && pr.breakdown && pr.breakdown.length) {
                pr.breakdown.forEach(function (item) {
                  html += '<div class="cl-pay-row"><span>' + U.esc(item.label) + '</span><span>' + U.money(item.amount) + '</span></div>';
                });
                html += '<div class="cl-pay-row" style="font-weight:700;border-top:2px solid var(--vp-border);padding-top:12px;margin-top:8px;">';
                html += '<span>Iš viso</span><span>' + U.money(pr.total_eur) + '</span></div>';
              }
              html += '<p style="margin-top:16px;font-size:13px;color:var(--vp-ink-secondary);">' + U.esc(s.rules.disclaimer) + '</p>';
              return html;
            }
            function refreshPriceFromExtras() {
              if (s.priceAbort) s.priceAbort.abort();
              s.priceAbort = new AbortController();
              s.priceSeq += 1;
              var seq = s.priceSeq;
              var addons = (s.selectedAddons || []).slice().sort();
              s.isPricing = true;
              submitBtn.disabled = true;
              priceCard.innerHTML = buildPriceCardHtml(null, true);
              API.post('/api/v1/client/estimate/price', {
                rules_version: s.rulesVersion || s.rules.rules_version,
                service: s.service, method: s.method,
                area_m2: s.area, km_one_way: s.km || 0, addons_selected: addons
              }, { signal: s.priceAbort.signal }).then(function (res) {
                s.isPricing = false;
                submitBtn.disabled = false;
                if (res && res.ok) {
                  res.json().then(function (data) {
                    if (seq === s.priceSeq) {
                      s.priceResult = data;
                      priceCard.innerHTML = buildPriceCardHtml(data, false);
                    }
                  });
                } else if (res && res.status === 409) {
                  API.get('/api/v1/client/estimate/rules').then(function (r) {
                    if (r && r.rules_version) {
                      s.rules = r; s.rulesVersion = r.rules_version;
                      showToast('Kainu taisykles atnaujintos. Kaina perskaiciuota.');
                      refreshPriceFromExtras();
                    } else {
                      priceCard.innerHTML = buildPriceCardHtml(s.priceResult, false);
                      showToast('Kainu taisykles pasikeite. Atnaujinkite puslapi.');
                    }
                  });
                } else {
                  if (seq === s.priceSeq) priceCard.innerHTML = buildPriceCardHtml(s.priceResult, false);
                }
              }).catch(function (err) {
                if (err && err.name === 'AbortError') return;
                s.isPricing = false;
                submitBtn.disabled = false;
                if (seq === s.priceSeq) priceCard.innerHTML = buildPriceCardHtml(s.priceResult, false);
              });
            }
            var pricingAddonKeys = (s.rules.addons || []).filter(function (a) { return a.pricing_mode === 'included_in_estimate'; }).map(function (a) { return a.key; });
            app.querySelectorAll('input[name="estExtra"]').forEach(function (cb) {
              cb.addEventListener('change', function () {
                var key = cb.value;
                var idx = s.extras.indexOf(key);
                if (cb.checked) {
                  if (idx === -1) s.extras.push(key);
                  if (pricingAddonKeys.indexOf(key) !== -1 && s.selectedAddons.indexOf(key) === -1) s.selectedAddons.push(key);
                } else {
                  if (idx !== -1) s.extras.splice(idx, 1);
                  if (pricingAddonKeys.indexOf(key) !== -1) {
                    var mi = s.selectedAddons.indexOf(key);
                    if (mi !== -1) s.selectedAddons.splice(mi, 1);
                  }
                }
                if (pricingAddonKeys.indexOf(key) !== -1) refreshPriceFromExtras();
              });
            });
          })();

          document.getElementById('estBack4').addEventListener('click', function () { s.step = 3; renderEstStep(app); });
          document.getElementById('estSubmit').addEventListener('click', function () {
            if (s.isPricing) return;
            var btn = document.getElementById('estSubmit');
            btn.disabled = true;
            btn.textContent = 'Pateikiama...';
            var slotRadio = document.querySelector('input[name="estSlot"]:checked');
            s.selectedSlot = slotRadio ? (slotRadio.value || null) : null;
            var addons = (s.selectedAddons || []).slice().sort();
            var extrasText = s.extras.length ? 'Papildomos paslaugos: ' + s.extras.join(', ') : '';
            var fullNotes = [s.notes, extrasText].filter(Boolean).join('. ');
            API.post('/api/v1/client/estimate/submit', {
              rules_version: s.rulesVersion || s.rules.rules_version,
              service: s.service, method: s.method,
              area_m2: s.area, km_one_way: s.km, addons_selected: addons,
              slope_flag: false,
              phone: s.phone, address: s.address,
              photo_file_ids: [], user_notes: fullNotes || null,
              preferred_slot_start: s.selectedSlot
            }).then(function (res) {
              if (res && res.ok) {
                s.priceResult = null;
                renderEstStep(app);
              } else if (res && res.status === 409) {
                res.json().then(function (err) {
                  if (err && err.detail && err.detail.code === 'DUPLICATE_ESTIMATE') {
                    showToast('Jus jau turite pateikta uzklausa.', 'info');
                    location.hash = '#/projects';
                  } else {
                    btn.disabled = false;
                    btn.textContent = 'Pateikti uzklausa';
                    showToast('Kainu taisykles pasikeite. Kaina perskaiciuota – patikrinkite ir pateikite is naujo.');
                    API.get('/api/v1/client/estimate/rules').then(function (r) {
                      if (r && r.rules_version) {
                        s.rules = r; s.rulesVersion = r.rules_version;
                        var priceCard = document.getElementById('estPriceCard');
                        if (priceCard && typeof refreshPriceFromExtras === 'function') refreshPriceFromExtras();
                      }
                    });
                  }
                }).catch(function () {
                  btn.disabled = false;
                  btn.textContent = 'Pateikti uzklausa';
                  showToast('Nepavyko pateikti uzklausos.');
                });
              } else {
                btn.disabled = false;
                btn.textContent = 'Pateikti uzklausa';
                showToast('Nepavyko pateikti uzklausos.');
              }
            });
          });
        }
      }

      // ─── Screen: Services ────────────────────────────────────────────
      var currentService = null;

      function screenServices(app) {
        app.innerHTML = U.loader();
        API.get('/api/v1/client/services/catalog').then(function (data) {
          if (!data || !data.items || !data.items.length) {
            app.innerHTML = '<h2 style="margin-bottom:20px;">Papildomos paslaugos</h2>' +
              U.empty('&#x1F6D2;', 'Paslaugu nera', 'Katalogas siuo metu tuscias.');
            return;
          }
          var h = '<h2 style="margin-bottom:20px;">Papildomos paslaugos</h2>';
          h += '<div class="cl-service-grid">';
          data.items.forEach(function (svc) {
            h += '<div class="cl-service-card">' +
              '<h3>' + U.esc(svc.title) + '</h3>' +
              '<div class="cl-service-price">' + U.esc(svc.price_display) + '</div>' +
              '<p>' + U.esc(svc.benefit) + '</p>' +
              '<button type="button" class="vp-btn vp-btn-outline vp-btn-sm" data-svc-id="' + U.esc(svc.id) + '">Uzsakyti</button>' +
              '</div>';
          });
          h += '</div>';
          app.innerHTML = h;

          // Bind order buttons
          app.querySelectorAll('[data-svc-id]').forEach(function (btn) {
            btn.addEventListener('click', function () {
              var svcId = btn.getAttribute('data-svc-id');
              var svc = data.items.find(function (s) { return s.id === svcId; });
              if (svc) openServiceModal(svc);
            });
          });
        });
      }

      function openServiceModal(svc) {
        currentService = svc;
        document.getElementById('modalTitle').textContent = 'Uzsakyti: ' + svc.title;
        var qDiv = document.getElementById('modalQuestions');
        var qh = '';

        if (svc.questions && svc.questions.length) {
          svc.questions.forEach(function (q, i) {
            qh += '<div class="vp-form-group">';
            qh += '<label class="vp-form-label">' + U.esc(q.label || q.question || 'Klausimas ' + (i + 1)) + '</label>';
            if (q.type === 'select' && q.options) {
              qh += '<select class="vp-form-select" name="q_' + i + '">';
              q.options.forEach(function (opt) {
                qh += '<option value="' + U.esc(opt) + '">' + U.esc(opt) + '</option>';
              });
              qh += '</select>';
            } else {
              qh += '<input type="text" class="vp-form-input" name="q_' + i + '" placeholder="' + U.esc(q.placeholder || '') + '" />';
            }
            qh += '</div>';
          });
        }

        qDiv.innerHTML = qh;
        var msg = document.getElementById('modalMsg');
        msg.className = 'vp-form-msg';
        msg.textContent = '';
        document.getElementById('modalSubmitBtn').disabled = false;
        document.getElementById('modalSubmitBtn').textContent = 'Pateikti uzsakyma';
        document.getElementById('serviceModal').classList.add('open');
      }

      // Modal form submit
      document.getElementById('modalForm').addEventListener('submit', function (e) {
        e.preventDefault();
        if (!currentService) return;
        var btn = document.getElementById('modalSubmitBtn');
        var msg = document.getElementById('modalMsg');
        btn.disabled = true;
        btn.textContent = 'Siunciama...';
        msg.className = 'vp-form-msg';

        var answers = {};
        if (currentService.questions) {
          currentService.questions.forEach(function (q, i) {
            var el = document.querySelector('[name="q_' + i + '"]');
            if (el) answers[q.key || ('q' + i)] = el.value;
          });
        }

        API.post('/api/v1/client/services/request', {
          service_id: currentService.id,
          project_id: null,
          answers: answers,
          photo_file_ids: []
        }).then(function (res) {
          if (res && res.ok) {
            res.json().then(function (data) {
              msg.textContent = data.message || 'Uzsakymas pateiktas!';
              msg.className = 'vp-form-msg success';
              btn.textContent = 'Pateikta';
              setTimeout(function () {
                document.getElementById('serviceModal').classList.remove('open');
                currentService = null;
              }, 2000);
            });
          } else {
            msg.textContent = 'Nepavyko pateikti uzsakymo.';
            msg.className = 'vp-form-msg error';
            btn.disabled = false;
            btn.textContent = 'Pateikti uzsakyma';
          }
        });
      });

      // Modal close
      document.getElementById('modalClose').addEventListener('click', function () {
        document.getElementById('serviceModal').classList.remove('open');
        currentService = null;
      });
      document.getElementById('serviceModal').addEventListener('click', function (e) {
        if (e.target === this) {
          this.classList.remove('open');
          currentService = null;
        }
      });

      // ─── Screen: Help ────────────────────────────────────────────────
      function screenHelp(app) {
        var h = '<h2 style="margin-bottom:20px;">Pagalba</h2>';
        h += '<div class="cl-help-contacts">';
        h += '<div class="cl-help-contact"><div class="cl-help-icon">&#9742;</div><h4>Telefonas</h4><p>+370 658 49514</p></div>';
        h += '<div class="cl-help-contact"><div class="cl-help-icon">&#9993;</div><h4>El. pastas</h4><p>info@vejapro.lt</p></div>';
        h += '<div class="cl-help-contact"><div class="cl-help-icon">&#9719;</div><h4>Darbo laikas</h4><p>I–V: 8:00 – 18:00</p></div>';
        h += '</div>';

        h += '<h3 class="cl-section-title">Daznai uzduodami klausimai</h3>';

        h += '<div class="cl-faq-item"><h4>Kaip veikia kainos ivertinimas?</h4>';
        h += '<p>Prisijunge prie savo paskyros, spauskite "Ivertinti nauja sklypa". Iveskite sklypo plota, ir sistema automatiskai apskaiciuos preliminaria kaina. Galutine kaina bus patikslinta po eksperto apziuros.</p></div>';

        h += '<div class="cl-faq-item"><h4>Kaip apmoketi depozita ar galutine suma?</h4>';
        h += '<p>Kai projektas bus paruostas, Dashboard puslapyje matysite "Reikia jusu veiksmo" kortele su mokejimo mygtuku. Spauskite ji ir sekite instrukcijas.</p></div>';

        h += '<div class="cl-faq-item"><h4>Kada bus atlikti darbai?</h4>';
        h += '<p>Darbu grafika rasite projekto detaliu puslapyje, kai projektas bus busenos "Suplanuota". Ten pat matysite visus susijusius dokumentus.</p></div>';

        h += '<div class="cl-faq-item"><h4>Kaip uzsakyti papildomas paslaugas?</h4>';
        h += '<p>Eikite i "Paslaugos" skyriu, pasirinkite norima paslauga ir spauskite "Uzsakyti". Mes su jumis susisieksime del detaliu.</p></div>';

        h += '<div class="cl-faq-item"><h4>Turiu kitu klausimu – kaip susisiekti?</h4>';
        h += '<p>Skambinkite +370 658 49514 arba raskite el. laiska adresu info@vejapro.lt. Atsakysime per 1 darbo diena.</p></div>';

        app.innerHTML = h;
      }

      // ─── Hamburger ───────────────────────────────────────────────────
      var hamburgerBtn = document.getElementById('hamburgerBtn');
      var mobileMenu = document.getElementById('mobileMenu');

      function closeMobileMenu() {
        hamburgerBtn.classList.remove('open');
        mobileMenu.classList.remove('open');
      }

      hamburgerBtn.addEventListener('click', function () {
        hamburgerBtn.classList.toggle('open');
        mobileMenu.classList.toggle('open');
      });

      mobileMenu.querySelectorAll('a').forEach(function (a) {
        a.addEventListener('click', closeMobileMenu);
      });

      // ─── Logout buttons ──────────────────────────────────────────────
      document.getElementById('logoutBtn').addEventListener('click', function () { Auth.logout(); });
      document.getElementById('mobileLogoutBtn').addEventListener('click', function () { Auth.logout(); });

      // ─── Init ────────────────────────────────────────────────────────
      Auth.check();
      Router.init();
    })();
    </script>
  </body>
</html>
