---
description: Backend Python kodo standartai ir konvencijos
globs: backend/**/*.py
alwaysApply: false
---

# Backend Python konvencijos

## Import taisyklės (ruff I001 — PRIVALOMA)
Importai PRIVALO būti surikiuoti pagal isort tvarką. CI atmeta nesurikiuotus importus.

**Svarbu (ruff UP006/UP035):**
- NENAUDOTI `typing.List`, `typing.Dict`, `typing.Tuple` (ir pan.) anotacijoms.
- Vietoje to naudoti built-in generics: `list[...]`, `dict[...]`, `tuple[...]`.
- Iš `typing` realiai dažniausiai lieka tik `Any` ir (pas mus) `Optional` (nes `UP045` ignoruojamas).

**Tvarka:**
1. `from __future__` (jei reikia)
2. Standard library `import X` (abėcėliškai: `import base64`, `import uuid`)
3. Standard library `from X import Y` (abėcėliškai: `from datetime import ...`, `from typing import Any, Optional`)
4. Tuščia eilutė
5. Third-party `import X` (abėcėliškai: `import jwt`, `import stripe`)
6. Third-party `from X import Y` (abėcėliškai: `from fastapi import ...`, `from sqlalchemy import ...`)
7. Tuščia eilutė
8. Local `import X` (`import app.api...`)
9. Local `from X import Y` (`from app.core...`, `from app.models...`)

**Viduje `from X import Y` — nariai abėcėliškai:**
```python
# BLOGAI:
from typing import Any, Optional
from app.models.project import Project, AuditLog, Evidence  # ne-abėcėliškai

# GERAI:
from typing import Any, Optional
from app.models.project import AuditLog, Evidence, Project

# Tipai (UP006):
# BLOGAI: meta UP006/UP035
payload: Dict[str, Any]  # noqa: F821 (pavyzdys)
items: List[str]         # noqa: F821 (pavyzdys)

# GERAI:
payload: dict[str, Any]
items: list[str]
```

**Konfigūracija:** `ruff.toml` — `known-first-party = ["app"]`

## Ruff ignore taisyklės
- `UP045`: Naudoti `Optional[X]` (ne `X | None`) — FastAPI schemas convention
- `UP017`: Naudoti `timezone.utc` (ne `datetime.UTC`) — codebase standartas
- `UP012`: Eksplicitinis `.encode("utf-8")` leidžiamas
- `B008`: FastAPI `Depends()` default argumentuose leidžiamas
- `E501`: Ilgos eilutės — tvarko formatter

## API endpoints
- Visi error pranešimai — **lietuviškai**: `"Prieiga uždrausta"`, `"Nerastas"`, `"Vartotojas nerastas"`
- Admin endpoints: tikrinti `current_user.role != "ADMIN"`
- Feature flag gated endpoints: `if not settings.enable_X: raise HTTPException(404, "Nerastas")`

## Modeliai (SQLAlchemy)
- UUID primary keys: `Column(UUID_TYPE, primary_key=True, default=uuid.uuid4)`
- PostgreSQL tipai su SQLite fallback
- Audit logging: kiekvienam svarbiam veiksmui kurti `AuditLog` per `create_audit_log()`

## Schemos (Pydantic)
- `AppointmentStatus` turi `CANCELLED` (ne `CANCELED`)
- Enums (ruff UP042): vietoje `class X(str, Enum)` naudoti `enum.StrEnum`.

## Transition logika
- `ALLOWED_TRANSITIONS` yra `transition_service.py` (vienintelis šaltinis)
- `project_service.py` — PAŠALINTAS, neegzistuoja

## Dažnos CI klaidos (ir kaip jų nebekartoti)

**Ruff I001 (imports)**:
- Prieš commit/push paleisk isort (čia “vienas mygtukas” prieš CI):
```powershell
.\.venv\bin\python -m isort --profile black -l 120 -p app backend/app backend/tests
```

**Ruff B904 (raise inside except)**:
- `except Exception as exc:` viduje kelk su `raise ... from exc` (arba `from None`).
```python
try:
    do()
except ValueError as exc:
    raise HTTPException(status_code=400, detail="Blogas parametras") from exc
```

## Saugumas
- PII redakcija audit loguose: `pii_redaction_enabled`
- SQL: tik SQLAlchemy ORM/Core (jokio raw SQL su string concat)
- HTML generavimas: `html.escape()` naudotojo duomenims
- Slaptažodžiai/raktai: tik iš `get_settings()`, niekada hardcoded
