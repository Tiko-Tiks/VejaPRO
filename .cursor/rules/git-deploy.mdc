---
description: Git workflow, CI/CD ir deployment taisyklės
alwaysApply: true
---

# Git, CI/CD ir deployment

## Git commit
- Pranešimai su prefiksais: `fix:`, `feat:`, `i18n:`, `docs:`, `ci:`, `security:`, `test:`
- PowerShell: nenaudoti heredoc — rašyti commit message į `.git/COMMIT_MSG.txt`, tada `git commit -F .git/COMMIT_MSG.txt`

## Pre-push checklist (PRIVALOMA)
Prieš kiekvieną `git push` paleisk **visus 3** CI zingsnius (ruff check, ruff format, pytest):

```powershell
cd backend
ruff check . --output-format=github   # 1. Lint (I001, UP037, W292...)
ruff format --check .                 # 2. Formatavimas (tarpai, newlines)
# 3. pytest: jei Python veikia — PYTHONPATH=. python -m pytest tests -v --tb=short
#    Windows be Python: patikrink VM (SSH) arba palauk CI
```

Jei yra klaidų — pataisyk prieš push:
- `ruff format .` (be `--check`) automatiškai sutvarko formatavimą.
- `ruff check --fix .` automatiškai sutvarko kai kurias lint klaidas.

**Jei Windows neturi ruff**:
```powershell
# Parsisiųsk ruff binarą (vienkartinis):
Invoke-WebRequest -Uri "https://github.com/astral-sh/ruff/releases/latest/download/ruff-x86_64-pc-windows-msvc.zip" -OutFile "$env:TEMP\ruff.zip"
Expand-Archive -Path "$env:TEMP\ruff.zip" -DestinationPath "$env:TEMP\ruff" -Force
# Naudok:
& "$env:TEMP\ruff\ruff.exe" check backend/ --output-format=github
& "$env:TEMP\ruff\ruff.exe" format backend/ --check --diff
```

**Dažniausios klaidos po push (ir kaip išvengti)**:
| Klaida | Priežastis | Sprendimas |
|--------|-----------|------------|
| `UP037` | Kabutės tipo anotacijoje su `from __future__ import annotations` | Pašalinti kabutes: `"Type"` → `Type` |
| `W292` | Trūksta `\n` failo gale | `ruff format .` arba rankiniu būdu pridėti |
| `ruff format` fail | Per daug / per mažai tuščių eilučių failo gale | Failas turi baigtis tiksliai viena `\n` |
| `I001` | Importai nesurikiuoti | `ruff check --fix .` arba rankinis rikiavimas |

## CI/CD kritinės taisyklės (GitHub Actions)
Prieš push'inant patikrinti:
1. **Importai surikiuoti** — CI atmeta I001 (isort) klaidas. Žr. `backend-python.mdc`
2. **Failai baigiasi newline** — CI atmeta W292. Windows dažnai nuryja paskutinį `\n`.
3. **Lint job NETURI `continue-on-error: true`** — tai padaro lintą beprasmiu
4. **Tests job PRIVALO turėti `needs: lint`** — testai vykdomi tik po sėkmingo lint
5. **Feature flags CI env** — visi feature flags turi būti eksplicitiškai nurodyti (`ENABLE_*`, `ADMIN_*`)
6. **Deploy: NIEKADA nenaudoti `${{ inputs.X }}` tiesiogiai shell'e** — naudoti `envs:` parametrą (injection apsauga)
7. **Deploy health check: min `sleep 5`** — uvicorn startup trunka ~8s

## Deployment
- Auto-deploy: `vejapro-update.timer` (kas 5 min) → tik **production** (`vejapro.service`)
- Staging reikia **rankinio** restart: `sudo systemctl restart vejapro-staging.service`
- GitHub Actions Deploy: manual dispatch su target (production/staging/both)
- Servisų pavadinimai: `vejapro.service` (prod), `vejapro-staging.service` (staging)

## SSH
- Host: `10.10.50.178`, user: `administrator`
- Key: `%USERPROFILE%\.ssh\vejapro_ed25519`
- `sudo` reikalauja slaptažodžio — interactive only

## Shell pastaba
- Windows PowerShell: nenaudoti `&&`, `||`, `; do ... done`. Komandas rašyti atskirai arba naudoti `;`

## Deploy: nuotraukų optimizavimas (2026-02-08)
Prieš deploy serveryje:
1. `pip install Pillow` (arba `pip install -r requirements.txt`)
2. `alembic upgrade head` — migracija `000013` pridės `thumbnail_url`, `medium_url` stulpelius
3. Restart uvicorn (`sudo systemctl restart vejapro.service`)
4. Senos nuotraukos veiks be thumbnail (frontend fallback į `file_url`)

## Deploy: Finance modulis (2026-02-08)
Prieš deploy serveryje:
1. `alembic upgrade head` — migracija `000014` sukurs finance lenteles (`finance_ledger_entries`, `finance_documents`, `finance_document_extractions`, `finance_vendor_rules`)
2. `.env.prod` pridėti: `ENABLE_FINANCE_LEDGER=true`, `ENABLE_FINANCE_AI_INGEST=true`, `ENABLE_FINANCE_AUTO_RULES=true`
3. Supabase Storage: sukurti `finance-documents` bucket (jei dar nėra)
4. Restart uvicorn (`sudo systemctl restart vejapro.service`)

## Dokumentacija po pakeitimų
- `PROGRESS_LOCK.md` — pridėti naują DONE eilutę (data + aprašymas)
- Atnaujinti susijusius `.md` failus jei keičiasi architektūra
