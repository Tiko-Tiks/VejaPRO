name: Deploy

# Quote `on` to avoid YAML 1.1 boolean parsing edge-cases in some tooling.
"on":
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        default: "production"
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deploy via webhook
        run: |
          set -e
          echo "=== Triggering deploy on vejapro.lt ==="
          RESPONSE=$(curl -sf -w "\n%{http_code}" \
            -X POST "https://vejapro.lt/api/v1/deploy/webhook" \
            -H "X-Deploy-Token: ${{ secrets.DEPLOY_WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 200)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "=== Deploy triggered ==="
          else
            echo "=== Deploy failed (HTTP $HTTP_CODE) ==="
            exit 1
          fi

      - name: Verify health check
        run: |
          set -e
          echo "=== Waiting 10s for service restart ==="
          sleep 10
          echo "=== Checking health ==="
          HEALTH=$(curl -sf --max-time 15 "https://vejapro.lt/health" || echo '{"status":"error"}')
          echo "Health: $HEALTH"
          if echo "$HEALTH" | grep -q '"status":"ok"'; then
            echo "=== Health check passed ==="
          else
            echo "=== Health check failed ==="
            exit 1
          fi
